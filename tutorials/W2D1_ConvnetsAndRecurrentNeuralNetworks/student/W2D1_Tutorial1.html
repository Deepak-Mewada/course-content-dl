
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Tutorial 1: Introduction to CNNs — Neuromatch Academy: Deep Learning</title>
<link href="../../../_static/css/theme.css" rel="stylesheet"/>
<link href="../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" rel="stylesheet" type="text/css">
<link href="../../../_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="../../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" rel="stylesheet" type="text/css"/>
<link as="script" href="../../../_static/js/index.1c5a1a01449ed65a7b51.js" rel="preload"/>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/doctools.js"></script>
<script src="../../../_static/togglebutton.js"></script>
<script src="../../../_static/clipboard.min.js"></script>
<script src="../../../_static/copybutton.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
<script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
<script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
<script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
<script async="async" src="../../../_static/sphinx-thebe.js"></script>
<script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
<link href="../../../_static/nma-dl-logo-square-4xp.jpeg" rel="shortcut icon">
<link href="../../../genindex.html" rel="index" title="Index"/>
<link href="../../../search.html" rel="search" title="Search"/>
<link href="W2D1_Tutorial2.html" rel="next" title="Tutorial 2: Training loop of CNNs"/>
<link href="../chapter_title.html" rel="prev" title="Convnets And Recurrent Neural Networks"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</link></link></link></link></head>
<body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
<div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../../index.html">
<img alt="logo" class="logo" src="../../../_static/nma-dl-logo-square-4xp.jpeg"/>
<h1 class="site-logo" id="site-title">Neuromatch Academy: Deep Learning</h1>
</a>
</div><form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main navigation" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../../intro.html">
   Introduction
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../Schedule/schedule_intro.html">
   Schedule
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../Schedule/daily_schedules.html">
     General schedule
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Schedule/shared_calendars.html">
     Shared calendars
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../Schedule/timezone_widget.html">
     Timezone widget
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../TechnicalHelp/tech_intro.html">
   Technical Help
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../TechnicalHelp/Jupyterbook.html">
     Using jupyterbook
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../TechnicalHelp/Tutorial_colab.html">
       Using Google Colab
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../TechnicalHelp/Tutorial_kaggle.html">
       Using Kaggle
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../TechnicalHelp/Discord.html">
     Using Discord
    </a>
</li>
</ul>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  The Basics
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D1_BasicsAndPytorch/chapter_title.html">
   Basics And Pytorch (W1D1)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D1_BasicsAndPytorch/student/W1D1_Tutorial1.html">
     Tutorial 1: PyTorch
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D2_LinearDeepLearning/chapter_title.html">
   Linear Deep Learning (W1D2)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_LinearDeepLearning/student/W1D2_Tutorial1.html">
     Tutorial 1: Gradient Descent and AutoGrad
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_LinearDeepLearning/student/W1D2_Tutorial2.html">
     Tutorial 2: Learning Hyperparameters
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D2_LinearDeepLearning/student/W1D2_Tutorial3.html">
     Tutorial 3: Deep linear neural networks
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D3_MultiLayerPerceptrons/chapter_title.html">
   Multi Layer Perceptrons (W1D3)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_MultiLayerPerceptrons/student/W1D3_Tutorial1.html">
     Tutorial 1: Biological vs. Artificial Neural Networks
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D3_MultiLayerPerceptrons/student/W1D3_Tutorial2.html">
     Tutorial 2: Deep MLPs
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D4_Optimization/chapter_title.html">
   Optimization (W1D4)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D4_Optimization/student/W1D4_Tutorial1.html">
     Tutorial 1: Optimization techniques
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W1D5_Regularization/chapter_title.html">
   Regularization (W1D5)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
<label for="toctree-checkbox-8">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_Regularization/student/W1D5_Tutorial1.html">
     Tutorial 1: Regularization techniques part 1
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W1D5_Regularization/student/W1D5_Tutorial2.html">
     Tutorial 2: Regularization techniques part 2
    </a>
</li>
</ul>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Doing more with fewer parameters
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="../chapter_title.html">
   Convnets And Recurrent Neural Networks (W2D1)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
<label for="toctree-checkbox-9">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     Tutorial 1: Introduction to CNNs
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="W2D1_Tutorial2.html">
     Tutorial 2: Training loop of CNNs
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="W2D1_Tutorial3.html">
     Tutorial 3: Introduction to RNNs
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D2_ModernConvnets/chapter_title.html">
   Modern Convnets (W2D2)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
<label for="toctree-checkbox-10">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_ModernConvnets/student/W2D2_Tutorial1.html">
     Tutorial 1: Learn how to use modern convnets
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D2_ModernConvnets/student/W2D2_Tutorial2.html">
     Tutorial 2: Facial recognition using modern convnets
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D3_ModernRecurrentNeuralNetworks/chapter_title.html">
   Modern Recurrent Neural Networks (W2D3)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
<label for="toctree-checkbox-11">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_ModernRecurrentNeuralNetworks/student/W2D3_Tutorial1.html">
     Tutorial 1: Modeling sequencies and encoding text
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D3_ModernRecurrentNeuralNetworks/student/W2D3_Tutorial2.html">
     Tutorial 2: Modern RNNs and their variants
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D4_AttentionAndTransformers/chapter_title.html">
   Attention And Transformers (W2D4)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
<label for="toctree-checkbox-12">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D4_AttentionAndTransformers/student/W2D4_Tutorial1.html">
     Tutorial 1: Learn how to work with Transformers
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W2D5_GenerativeModels/chapter_title.html">
   Generative Models (W2D5)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
<label for="toctree-checkbox-13">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D5_GenerativeModels/student/W2D5_Tutorial1.html">
     Tutorial 1: Variational Autoencoders (VAEs)
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D5_GenerativeModels/student/W2D5_Tutorial2.html">
     Tutorial 2: Introduction to GANs and Density Ratio Estimation Perspective of GANs
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W2D5_GenerativeModels/student/W2D5_Tutorial3.html">
     Tutorial 3: Conditional GANs and Implications of GAN Technology
    </a>
</li>
</ul>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Advanced topics
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D1_UnsupervisedAndSelfSupervisedLearning/chapter_title.html">
   Unsupervised And Self Supervised Learning (W3D1)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
<label for="toctree-checkbox-14">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D1_UnsupervisedAndSelfSupervisedLearning/student/W3D1_Tutorial1.html">
     Tutorial 1: Un/Self-supervised learning methods
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D2_BasicReinforcementLearning/chapter_title.html">
   Basic Reinforcement Learning (W3D2)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
<label for="toctree-checkbox-15">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D2_BasicReinforcementLearning/student/W3D2_Tutorial1.html">
     Tutorial 1: Introduction to Reinforcement Learning
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D3_ReinforcementLearningForGames/chapter_title.html">
   Reinforcement Learning For Games (W3D3)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
<label for="toctree-checkbox-16">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D3_ReinforcementLearningForGames/student/W3D3_Tutorial1.html">
     Tutorial 1: Learn to play games with RL
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../W3D4_ContinualLearning/chapter_title.html">
   Continual Learning (W3D4)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
<label for="toctree-checkbox-17">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ContinualLearning/student/W3D4_Tutorial1.html">
     Tutorial 1: Introduction to Continual Learning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../W3D4_ContinualLearning/student/W3D4_Tutorial2.html">
     Tutorial 2: Out-of-distribution (OOD) Learning
    </a>
</li>
</ul>
</li>
</ul>
<p class="caption">
<span class="caption-text">
  Project Booklet
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../../../projects/README.html">
   Introduction to projects
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../../../projects/docs/project_guidance.html">
   Daily guide for projects
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../../projects/modelingsteps/intro.html">
   Modeling Step-by-Step Guide
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
<label for="toctree-checkbox-18">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/ModelingSteps_1through2_DL.html">
     Modeling Steps 1 - 2
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/ModelingSteps_3through4_DL.html">
     Modeling Steps 3 - 4
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/ModelingSteps_5through6_DL.html">
     Modeling Steps 5 - 6
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/ModelingSteps_7through9_DL.html">
     Modeling Steps 7 - 9
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/ModelingSteps_10_DL.html">
     Modeling Steps 10
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/TrainIllusionDataProjectDL.html">
     Example Data Project: the Train Illusion
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/TrainIllusionModelingProjectDL.html">
     Example Model Project: the Train Illusion
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../../../projects/modelingsteps/Example_Deep_Learning_Project.html">
     Example Deep Learning Project
    </a>
</li>
</ul>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../../../projects/docs/projects_overview.html">
   Project Templates
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
<label for="toctree-checkbox-19">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/ComputerVision/README.html">
     Computer Vision
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/>
<label for="toctree-checkbox-20">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/slides.html">
       Slides
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/ideas_and_datasets.html">
       Ideas
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/em_synapses.html">
       Knowledge Extraction from a Convolutional Neural Network
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/spectrogram_analysis.html">
       Music classification and generation with spectrograms
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/screws.html">
       Something Screwy - image recognition, detection, and classification of screws
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/image_alignment.html">
       Image Alignment
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/data_augmentation.html">
       Data Augmentation in image classification models
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ComputerVision/transfer_learning.html">
       Transfer Learning
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/ReinforcementLearning/README.html">
     Reinforcement Learning
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/>
<label for="toctree-checkbox-21">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ReinforcementLearning/slides.html">
       Slides
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ReinforcementLearning/ideas_and_datasets.html">
       Ideas
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ReinforcementLearning/robolympics.html">
       NMA Robolympics: Controlling robots using reinforcement learning
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ReinforcementLearning/lunar_lander.html">
       Performance Analysis of DQN Algorithm on the Lunar Lander task
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/ReinforcementLearning/human_rl.html">
       Using RL to Model Cognitive Tasks
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/NaturalLanguageProcessing/README.html">
     Natural Language Processing
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/>
<label for="toctree-checkbox-22">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/NaturalLanguageProcessing/slides.html">
       Slides
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/NaturalLanguageProcessing/ideas_and_datasets.html">
       Ideas
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/NaturalLanguageProcessing/sentiment_analysis.html">
       Twitter Sentiment Analysis
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/NaturalLanguageProcessing/machine_translation.html">
       Machine Translation
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../../../projects/Neuroscience/README.html">
     Neuroscience
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/>
<label for="toctree-checkbox-23">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/slides.html">
       Slides
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/ideas_and_datasets.html">
       Ideas
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/pose_estimation.html">
       Animal Pose Estimation
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/cellular_segmentation.html">
       Segmentation and Denoising
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/algonauts_videos.html">
       Load algonauts videos
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/blurry_vision.html">
       Vision with Lost Glasses: Modelling how the brain deals with noisy input
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/finetuning_fmri.html">
       Moving beyond Labels: Finetuning CNNs on BOLD response
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../../../projects/Neuroscience/neuro_seq_to_seq.html">
       Focus on what matters: inferring low-dimensional dynamics from neural recordings
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../../../projects/docs/datasets_and_models.html">
   Models and Data sets
  </a>
</li>
</ul>
</div>
</nav> <!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>
</div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
<div class="topbar container-xl fixed-top">
<div class="topbar-contents row">
<div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
<div class="col pl-md-4 topbar-main">
<button aria-controls="site-navigation" aria-expanded="true" aria-label="Toggle navigation" class="navbar-toggler ml-0" data-placement="left" data-target=".site-navigation" data-toggle="tooltip" id="navbar-toggler" title="Toggle navigation" type="button">
<i class="fas fa-bars"></i>
<i class="fas fa-arrow-left"></i>
<i class="fas fa-arrow-up"></i>
</button>
<div class="dropdown-buttons-trigger">
<button aria-label="Download this page" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-download"></i></button>
<div class="dropdown-buttons">
<!-- ipynb file if we had a myst markdown file -->
<!-- Download raw file -->
<a class="dropdown-buttons" href="../../../_sources/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/student/W2D1_Tutorial1.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Download source file" type="button">.ipynb</button></a>
<!-- Download PDF via print -->
<button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" id="download-print" onclick="window.print()" title="Print to PDF" type="button">.pdf</button>
</div>
</div>
<!-- Source interaction buttons -->
<div class="dropdown-buttons-trigger">
<button aria-label="Connect with source repository" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fab fa-github"></i></button>
<div class="dropdown-buttons sourcebuttons">
<a class="repository-button" href="https://github.com/NeuromatchAcademy/course-content-dl"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Source repository" type="button"><i class="fab fa-github"></i>repository</button></a>
<a class="issues-button" href="https://github.com/NeuromatchAcademy/course-content-dl/issues/new?title=Issue%20on%20page%20%2Ftutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/student/W2D1_Tutorial1.html&amp;body=Your%20issue%20content%20here."><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Open an issue" type="button"><i class="fas fa-lightbulb"></i>open issue</button></a>
</div>
</div>
<!-- Full screen (wrap in <a> to have style consistency -->
<a class="full-screen-button"><button aria-label="Fullscreen mode" class="btn btn-secondary topbarbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode" type="button"><i class="fas fa-expand"></i></button></a>
<!-- Launch buttons -->
</div>
<!-- Table of contents -->
<div class="d-none d-md-block col-md-2 bd-toc show">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
            </div>
<nav id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Tutorial 1: Introduction to CNNs
  </a>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#tutorial-objectives">
   Tutorial Objectives
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#tutorial-slides">
     Tutorial slides
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#setup">
   Setup
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#install-dependencies">
     Install dependencies
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#figure-settings">
     Figure Settings
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions">
     Helper functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#plotting-functions">
     Plotting Functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#set-random-seed">
     Set random seed
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#set-device-gpu-or-cpu-execute-set-device">
     Set device (GPU or CPU). Execute
     <code class="docutils literal notranslate">
<span class="pre">
       set_device()
      </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-0-recap-the-experience-from-last-week">
   Section 0: Recap the Experience from Last Week
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-1-introduction-to-cnns-and-rnns">
     Video 1: Introduction to CNNs and RNNs
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#think-0-regularization-effective-number-of-params">
     Think! 0: Regularization &amp; effective number of params
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#student-response">
       Student Response
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-neuroscience-motivation-general-cnn-structure">
   Section 1: Neuroscience motivation, General CNN structure
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-2-representations-visual-processing-in-the-brain">
     Video 2: Representations &amp; Visual processing in the brain
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#think-1-what-makes-a-representation-good">
     Think! 1: What makes a representation good?
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
       Student Response
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-convolutions-and-edge-detection">
   Section 2: Convolutions and Edge Detection
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-3-details-about-convolution">
     Video 3: Details about Convolution
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#interactive-demo-2-visualization-of-convolution">
       Interactive Demo 2: Visualization of Convolution
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#definitional-note">
         Definitional Note
        </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-2-1-convolution-of-a-simple-kernel">
     Coding Exercise 2.1: Convolution of a Simple Kernel
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-2-2-convolution-output-size">
     Coding Exercise 2.2: Convolution Output Size
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-2-3-coding-a-convolution">
     Coding Exercise 2.3: Coding a Convolution
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#convolution-on-the-chicago-skyline">
       Convolution on the Chicago Skyline
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#load-images-run-me">
       Load images (run me)
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-1-demonstration-of-a-cnn-in-pytorch">
     Section 2.1: Demonstration of a CNN in PyTorch
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-2-2-padding-and-edge-detection">
     Section 2.2: Padding and Edge Detection
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#interactive-demo-2-2-visualization-of-convolution-with-padding-and-stride">
       Interactive Demo 2.2: Visualization of Convolution with Padding and Stride
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#think-2-2-1-edge-detection">
       Think! 2.2.1: Edge Detection
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
         Student Response
        </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#think-2-2-2-kernel-structure">
       Think! 2.2.2 Kernel structure
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id3">
         Student Response
        </a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-3-pooling-and-subsampling">
   Section 3: Pooling and Subsampling
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-4-pooling">
     Video 4: Pooling
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#dataset-dataloader-functions-run-me">
       Dataset/DataLoader Functions (run me)
      </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-3-1-multiple-filters">
     Section 3.1: Multiple Filters
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#think-3-1-do-you-see-how-these-filters-would-help-recognize-an-x">
       Think! 3.1: Do you see how these filters would help recognize an
       <code class="docutils literal notranslate">
<span class="pre">
         X
        </span>
</code>
       ?
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id4">
         Student Response
        </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-3-2-relu-after-convolutions">
     Section 3.2: ReLU after convolutions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-3-3-pooling">
     Section 3.3: Pooling
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#interactive-demo-3-3-the-effect-of-the-stride">
       Interactive Demo 3.3: The effect of the stride
      </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-3-3-implement-maxpooling">
       Coding Exercise 3.3: Implement MaxPooling
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-4-putting-it-all-together">
   Section 4: Putting it all together
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-5-putting-it-all-together">
     Video 5: Putting it all together
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-4-1-number-of-parameters-in-convolutional-vs-fully-connected-models">
     Section 4.1: Number of Parameters in Convolutional vs. Fully-connected Models
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#interactive-demo-4-1-number-of-parameters">
       Interactive Demo 4.1: Number of Parameters
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-6-implement-your-own-cnn">
         Video 6: Implement your own CNN
        </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#coding-exercise-4-implement-your-own-cnn">
     Coding Exercise 4: Implement your own CNN
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#summary">
   Summary
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#airtable-submission-link">
     Airtable Submission Link
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="row" id="main-content">
<div class="col-12 col-md-9 pl-md-3 pr-md-0">
<div>
<p><a href="https://colab.research.google.com/github/NeuromatchAcademy/course-content-dl/blob/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/student/W2D1_Tutorial1.ipynb" target="_blank"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<div class="section" id="tutorial-1-introduction-to-cnns">
<h1>Tutorial 1: Introduction to CNNs<a class="headerlink" href="#tutorial-1-introduction-to-cnns" title="Permalink to this headline">¶</a></h1>
<p><strong>Week 2, Day 1: Convnets And Recurrent Neural Networks</strong></p>
<p><strong>By Neuromatch Academy</strong></p>
<p><strong>Content creators:</strong> Dawn Estes McKnight, Richard Gerum, Cassidy Pirlot, Rohan Saha, Liam Peet-Pare, Saeed Najafi, Alona Fyshe</p>
<p><strong>Content reviewers:</strong> Saeed Salehi, Lily Cheng, Yu-Fang Yang, Polina Turishcheva, Bettina Hein, Kelson Shilling-Scrivo</p>
<p><strong>Content editors:</strong> Nina Kudryashova, Anmol Gupta, Spiros Chavlis</p>
<p><strong>Production editors:</strong> Alex Tran-Van-Minh, Spiros Chavlis</p>
<p><em>Based on material from:</em> Konrad Kording, Hmrishav Bandyopadhyay, Rahul Shekhar, Tejas Srivastava</p>
<p><strong>Our 2021 Sponsors, including Presenting Sponsor Facebook Reality Labs</strong></p>
<p align="center"><img src="https://github.com/NeuromatchAcademy/widgets/blob/master/sponsors.png?raw=True"/></p></div>
<hr class="docutils"/>
<div class="section" id="tutorial-objectives">
<h1>Tutorial Objectives<a class="headerlink" href="#tutorial-objectives" title="Permalink to this headline">¶</a></h1>
<p>At the end of this tutorial, we will be able to:</p>
<ul class="simple">
<li><p>Define what convolution is</p></li>
<li><p>Implement convolution as an operation</p></li>
</ul>
<div class="section" id="tutorial-slides">
<h2>Tutorial slides<a class="headerlink" href="#tutorial-slides" title="Permalink to this headline">¶</a></h2>
<p>These are the slides for the videos in this tutorial</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
<iframe allowfullscreen="" frameborder="0" height="480" src="https://mfr.ca-1.osf.io/render?url=https://osf.io/s8xz5/?direct%26mode=render%26action=download%26mode=render" width="854"></iframe>
</div></div>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h1>
<div class="section" id="install-dependencies">
<h2>Install dependencies<a class="headerlink" href="#install-dependencies" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Install dependencies</span>
<span class="o">!</span>pip install livelossplot --quiet
<span class="o">!</span>pip install Pillow --quiet
<span class="o">!</span>pip install opencv-python --quiet
<span class="o">!</span>pip install imageio-ffmpeg --quiet

<span class="o">!</span>pip install git+https://github.com/NeuromatchAcademy/evaltools --quiet
<span class="kn">from</span> <span class="nn">evaltools.airtable</span> <span class="kn">import</span> <span class="n">AirtableForm</span>

<span class="c1"># generate airtable form</span>
<span class="n">atform</span> <span class="o">=</span> <span class="n">AirtableForm</span><span class="p">(</span><span class="s1">'appn7VdPRseSoMXEG'</span><span class="p">,</span><span class="s1">'W2D1_T1'</span><span class="p">,</span><span class="s1">'https://portal.neuromatchacademy.org/api/redirect/to/351ca652-13d8-4e31-be28-30153d03e639'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">import</span> <span class="nn">torchvision.datasets</span> <span class="k">as</span> <span class="nn">datasets</span>
<span class="kn">from</span> <span class="nn">torchvision.utils</span> <span class="kn">import</span> <span class="n">make_grid</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets</span> <span class="kn">import</span> <span class="n">ImageFolder</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">TensorDataset</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>

<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="figure-settings">
<h2>Figure Settings<a class="headerlink" href="#figure-settings" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Figure Settings</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>       <span class="c1"># interactive display</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = 'retina'
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/NeuromatchAcademy/content-creation/main/nma.mplstyle"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">"mpl_toolkits.legacy_colorbar"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">"matplotlib"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.11/x64/lib/python3.7/site-packages/ipykernel_launcher.py:7: MatplotlibDeprecationWarning: 
The mpl_toolkits.legacy_colorbar rcparam was deprecated in Matplotlib 3.4 and will be removed two minor releases later.
  import sys
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="helper-functions">
<h2>Helper functions<a class="headerlink" href="#helper-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Helper functions</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">convolve2d</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">correlate2d</span>

<span class="k">def</span> <span class="nf">check_shape_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">):</span>
  <span class="n">correct_shape</span> <span class="o">=</span> <span class="n">correlate2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">image_shape</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">kernel_shape</span><span class="p">),</span> <span class="s2">"valid"</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">user_shape</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">correct_shape</span> <span class="o">!=</span> <span class="n">user_shape</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"❌ Your calculated output shape is not correct."</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"✅ Output for image_shape: </span><span class="si">{</span><span class="n">image_shape</span><span class="si">}</span><span class="s2"> and kernel_shape: </span><span class="si">{</span><span class="n">kernel_shape</span><span class="si">}</span><span class="s2">, output_shape: </span><span class="si">{</span><span class="n">user_shape</span><span class="si">}</span><span class="s2">, is correct."</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_conv_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">):</span>
  <span class="n">solution_user</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
  <span class="n">solution_scipy</span> <span class="o">=</span> <span class="n">correlate2d</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="s2">"valid"</span><span class="p">)</span>
  <span class="n">result_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">solution_user</span> <span class="o">==</span> <span class="n">solution_scipy</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">result_right</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"✅ The function calculated the convolution correctly."</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"❌ The function did not produce the right output."</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"For the input matrix:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"and the kernel:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"the function returned:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">solution_user</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"the correct output would be:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">solution_scipy</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_pooling_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">'cpu'</span><span class="p">):</span>
  <span class="n">x_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
  <span class="n">output_x</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x_img</span><span class="p">)</span>
  <span class="n">output_x</span> <span class="o">=</span> <span class="n">output_x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

  <span class="n">right_output</span> <span class="o">=</span> <span class="p">[</span>
                  <span class="p">[</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">2.0491</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.5527</span><span class="p">,</span> <span class="mf">2.0236</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">2.0109</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.5471</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">2.2145</span><span class="p">,</span>
                   <span class="mf">2.4945</span><span class="p">,</span> <span class="mf">1.0181</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">1.2217</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">1.0053</span><span class="p">,</span>
                   <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">1.9854</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span>
                   <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">2.5455</span><span class="p">,</span> <span class="mf">1.5399</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2854</span><span class="p">,</span> <span class="mf">2.2527</span><span class="p">,</span> <span class="mf">1.1835</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span>
                   <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">1.2217</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.3108</span><span class="p">,</span> <span class="mf">2.1763</span><span class="p">,</span> <span class="mf">2.5836</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">1.8200</span><span class="p">,</span> <span class="mf">0.1144</span><span class="p">,</span>
                   <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.1780</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">2.1891</span><span class="p">,</span> <span class="mf">2.2145</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">2.5836</span><span class="p">,</span> <span class="mf">2.3800</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">0.1271</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">1.7563</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.2599</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">1.3872</span><span class="p">,</span> <span class="mf">2.0618</span><span class="p">,</span> <span class="mf">1.9981</span><span class="p">,</span> <span class="mf">1.2854</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">0.9799</span><span class="p">,</span> <span class="mf">1.2472</span><span class="p">,</span> <span class="mf">2.5073</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2599</span><span class="p">,</span> <span class="mf">2.7746</span><span class="p">,</span> <span class="mf">1.3745</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span>
                   <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">,</span> <span class="mf">1.2726</span><span class="p">],</span>
                  <span class="p">]</span>

  <span class="n">right_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">output_x</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">right_shape</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"❌ Your output does not have the right dimensions. Your output is </span><span class="si">{</span><span class="n">output_x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> the expected output is </span><span class="si">{</span><span class="n">right_shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">elif</span> <span class="p">(</span><span class="n">output_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">right_output</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"❌ Your output is not right."</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"✅ Your network produced the correct output."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plotting-functions">
<h2>Plotting Functions<a class="headerlink" href="#plotting-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Plotting Functions</span>

<span class="k">def</span> <span class="nf">display_image_from_greyscale_array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
  <span class="n">_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
  <span class="n">_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">_matrix</span><span class="p">,</span> <span class="s1">'L'</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span> <span class="c1"># using 220 instead of 255 so the examples show up better</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_plots</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">actual_convolution</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
  <span class="n">display_image_from_greyscale_array</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="s2">"Original Image"</span><span class="p">)</span>
  <span class="n">display_image_from_greyscale_array</span><span class="p">(</span><span class="n">actual_convolution</span><span class="p">,</span> <span class="s2">"Convolution result"</span><span class="p">)</span>
  <span class="n">display_image_from_greyscale_array</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="s2">"Your solution"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-random-seed">
<h2>Set random seed<a class="headerlink" href="#set-random-seed" title="Permalink to this headline">¶</a></h2>
<p>Executing <code class="docutils literal notranslate"><span class="pre">set_seed(seed=seed)</span></code> you are setting the seed</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Set random seed</span>

<span class="c1"># @markdown Executing `set_seed(seed=seed)` you are setting the seed</span>

<span class="c1"># for DL its critical to set the random seed so that students can have a</span>
<span class="c1"># baseline to compare their results to expected results.</span>
<span class="c1"># Read more here: https://pytorch.org/docs/stable/notes/randomness.html</span>

<span class="c1"># Call `set_seed` function in the exercises to ensure reproducibility.</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed_torch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">)</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">seed_torch</span><span class="p">:</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>

  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Random seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1"> has been set.'</span><span class="p">)</span>


<span class="c1"># In case that `DataLoader` is used</span>
<span class="k">def</span> <span class="nf">seed_worker</span><span class="p">(</span><span class="n">worker_id</span><span class="p">):</span>
  <span class="n">worker_seed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">initial_seed</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>
  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">worker_seed</span><span class="p">)</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">worker_seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-device-gpu-or-cpu-execute-set-device">
<h2>Set device (GPU or CPU). Execute <code class="docutils literal notranslate"><span class="pre">set_device()</span></code><a class="headerlink" href="#set-device-gpu-or-cpu-execute-set-device" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Set device (GPU or CPU). Execute `set_device()`</span>
<span class="c1"># especially if torch modules used.</span>

<span class="c1"># inform the user if the notebook uses GPU or CPU.</span>

<span class="k">def</span> <span class="nf">set_device</span><span class="p">():</span>
  <span class="n">device</span> <span class="o">=</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span>
  <span class="k">if</span> <span class="n">device</span> <span class="o">!=</span> <span class="s2">"cuda"</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"WARNING: For this notebook to perform best, "</span>
        <span class="s2">"if possible, in the menu under `Runtime` -&gt; "</span>
        <span class="s2">"`Change runtime type.`  select `GPU` "</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"GPU is enabled in this notebook."</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">device</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SEED</span> <span class="o">=</span> <span class="mi">2021</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">set_device</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Random seed 2021 has been set.
WARNING: For this notebook to perform best, if possible, in the menu under `Runtime` -&gt; `Change runtime type.`  select `GPU` 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-0-recap-the-experience-from-last-week">
<h1>Section 0: Recap the Experience from Last Week<a class="headerlink" href="#section-0-recap-the-experience-from-last-week" title="Permalink to this headline">¶</a></h1>
<p>Last week you learned a lot!  Recall that overparametrized ANNs are efficient universal approximators, but also that ANNs can memorize our data.  However, regularization can help ANNs to better generalize. You were introduced to several regularization techniques such as <em>L1</em>, <em>L2</em>, <em>Data Augmentation</em>, and <em>Dropout</em>.</p>
<p>Today we’ll be talking about other ways to simplify ANNs, by making smart changes to their architecture.</p>
<div class="section" id="video-1-introduction-to-cnns-and-rnns">
<h2>Video 1: Introduction to CNNs and RNNs<a class="headerlink" href="#video-1-introduction-to-cnns-and-rnns" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "67bcf1f9ab324173ba5004e724dceb8c"}
</script></div>
</div>
</div>
<div class="section" id="think-0-regularization-effective-number-of-params">
<h2>Think! 0: Regularization &amp; effective number of params<a class="headerlink" href="#think-0-regularization-effective-number-of-params" title="Permalink to this headline">¶</a></h2>
<p>Let’s think back to last week, when you learned about regularization.  Recall that regularization comes in several forms.  For example, L1 regularization adds a term to the loss function that penalizes based on the sum of the <em>absolute</em> magnitude of the weights. Below are the results from training a simple multilayer perceptron with one hidden layer (b) on a simple toy dataset (a).</p>
<p>Below that are two graphics that show the effect of regularization on both the number of non-zero weights (d), and on the network’s accuracy (c).
What do you notice?</p>
<p><strong>Note</strong>: Dense layers are the same as fully-connected layers.  And pytorch calls them linear layers.  Confusing, but now you know!</p>
<img alt="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/think0.png" src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/think0.png"/>
<div class="section" id="student-response">
<h3>Student Response<a class="headerlink" href="#student-response" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Student Response</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>


<span class="n">text</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
   <span class="n">value</span><span class="o">=</span><span class="s1">'Type your answer here and click on `Submit!`'</span><span class="p">,</span>
   <span class="n">placeholder</span><span class="o">=</span><span class="s1">'Type something'</span><span class="p">,</span>
   <span class="n">description</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
   <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Submit!"</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">button</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_button_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
   <span class="n">atform</span><span class="o">.</span><span class="n">add_answer</span><span class="p">(</span><span class="s1">'q1'</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">"Submission successful!"</span><span class="p">)</span>


<span class="n">button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_button_clicked</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "3733e14874374dc188f2a938efe67b09"}
</script><script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "31ab83b6449b49a5a5bd1f8ed34262b5"}
</script></div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_211bbfd0.py"><em>Click for solution</em></a></p>
<p><strong>Coming Up</strong></p>
<p>The rest of these lectures focus on another way to reduce parameters: weight-sharing. Weight-sharing is based on the idea that some sets of weights can be used at multiple points in a network. We will focus mostly on CNNs today, where the weight-sharing is across the 2D space of an image. At the end we will touch briefly on Recurrent Neural Networks (RNNs), which share parameters across time. Both of these weight-sharing techniques (across space and time) can reduce the number of parameters and increase a network’s ability to generalize.</p>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-1-neuroscience-motivation-general-cnn-structure">
<h1>Section 1: Neuroscience motivation, General CNN structure<a class="headerlink" href="#section-1-neuroscience-motivation-general-cnn-structure" title="Permalink to this headline">¶</a></h1>
<div class="section" id="video-2-representations-visual-processing-in-the-brain">
<h2>Video 2: Representations &amp; Visual processing in the brain<a class="headerlink" href="#video-2-representations-visual-processing-in-the-brain" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "9db853e216b947b2bea4c3ad56e9de6d"}
</script></div>
</div>
</div>
<div class="section" id="think-1-what-makes-a-representation-good">
<h2>Think! 1: What makes a representation good?<a class="headerlink" href="#think-1-what-makes-a-representation-good" title="Permalink to this headline">¶</a></h2>
<p>Representations have a long and storied history, having been studied by the likes of Aristotle back in 300 BC! Representations are not a new idea, and they certainly don’t exist just in neural networks.</p>
<p>Take a moment with your pod to discuss what would make a good representation, and how that might differ depending on the task you train your CNN to do.</p>
<p>If there’s time, you can also consider how the brain’s representations might differ from a <em>learned</em> representation inside a NN.</p>
<div class="section" id="id1">
<h3>Student Response<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Student Response</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>


<span class="n">text</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
   <span class="n">value</span><span class="o">=</span><span class="s1">'Type your answer here and click on `Submit!`'</span><span class="p">,</span>
   <span class="n">placeholder</span><span class="o">=</span><span class="s1">'Type something'</span><span class="p">,</span>
   <span class="n">description</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
   <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Submit!"</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">button</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_button_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
   <span class="n">atform</span><span class="o">.</span><span class="n">add_answer</span><span class="p">(</span><span class="s1">'q2'</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">"Submission successful!"</span><span class="p">)</span>


<span class="n">button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_button_clicked</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "30ddd65c921c49c1aaa374623ecf4b91"}
</script><script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "ff758fd91edd4e67b4b9c1c992916710"}
</script></div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_82e644f4.py"><em>Click for solution</em></a></p>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-2-convolutions-and-edge-detection">
<h1>Section 2: Convolutions and Edge Detection<a class="headerlink" href="#section-2-convolutions-and-edge-detection" title="Permalink to this headline">¶</a></h1>
<p>Fundamental to CNNs are convolutions. After all, that <em>is</em> what the C in CNN stands for! In this section, we will define what a convolution is, practice performing a convolution, and implement it in code.</p>
<div class="section" id="video-3-details-about-convolution">
<h2>Video 3: Details about Convolution<a class="headerlink" href="#video-3-details-about-convolution" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "51e7631747c549a5bc0857d9b293d74f"}
</script></div>
</div>
<p>Before jumping into coding exercises, take a moment to look at this animation that steps through the process of convolution.</p>
<p>Recall from the video that convolution involves sliding the kernel across the image, taking the element-wise product, and adding those products together.</p>
<img alt="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/correlation.svg" src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/correlation.svg"/><p>Adopted from A. Zhang, Z. C. Lipton, M. Li and A. J. Smola, <em><a class="reference external" href="http://d2l.ai/chapter_convolutional-neural-networks/conv-layer.html">Dive into Deep Learning</a></em>.</p>
<br/>
<p><strong>Note:</strong> You need to run the cell to activate the sliders, and again to run once changing the sliders.</p>
<p><strong>Tip:</strong> In this animation, and all the ones that follow, you can hover over the parts of the code underlined in red to change them.</p>
<p><strong>Tip:</strong> Below, the function is called <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code> because the convolutional filter is a matrix with two dimensions (2D).  There are also 1D and 3D convolutions, but we won’t talk about them today.</p>
<div class="section" id="interactive-demo-2-visualization-of-convolution">
<h3>Interactive Demo 2: Visualization of Convolution<a class="headerlink" href="#interactive-demo-2-visualization-of-convolution" title="Permalink to this headline">¶</a></h3>
<p><em>Run this cell to enable the widget!</em></p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># @markdown *Run this cell to enable the widget!*
%%html
&lt;style&gt;
    svg {
        #border: 1px solid black;
    }
.matrix {
    font-family: sans-serif;
    transition: all 700ms ease-in-out;
}
.cell rect {
    fill:white;stroke-width:1;stroke:rgb(0,0,0)
}
.padding rect {
    stroke: rgba(0, 0, 0, 0.25);
}
.padding text {
    fill: lightgray;
}
.highlight1 {
    fill:none;stroke-width:4;stroke: rgb(236, 58, 58);stroke-dasharray:10,5;
}
.highlight2 {
    fill:rgba(229, 132, 66, 0.25);stroke-width:5;stroke: rgb(229, 132, 66);
}
.highlight3 {
    fill:rgba(236, 58, 58, 0.25);stroke-width:2;stroke: rgb(236, 58, 58);;
}
.title {
    text-anchor: middle;
}
.button_play {
    display: inline-block;
    background: none;
    border: none;
    position: relative;
    top: -3px;
}
.button_play path {
    fill: darkgray;
}
.button_play:hover path {
    fill: rgb(236, 58, 58);
}
.display_vis_input input:not(:hover)::-webkit-outer-spin-button,
.display_vis_input input:not(:hover)::-webkit-inner-spin-button {
    /* display: none; &lt;- Crashes Chrome on hover */
    -webkit-appearance: none;
    margin: 0; /* &lt;-- Apparently some margin are still there even though it's hidden */
}

.display_vis_input input:not(:hover)[type=number] {
    -moz-appearance:textfield; /* Firefox */
    width: 1ch;
    margin-right: 0px;
    z-index: 0;
}
.display_vis_input input[type=number] {
    width: 4ch;
    border: 0px;
    margin-right: -3ch;
    z-index: 6;
    display: inline-block;
    position: relative;
    padding: 0;
    border-bottom: 2px solid red;
    background: white;
    color: black
}
.display_vis_input .pair {
    display: inline-block;
    white-space:nowrap;
        position: relative;
}
.display_vis_input .pair .pair_hide {
    max-width: 4em;
    transition: max-width 1s ease-in;
    display: inline-block;
    overflow: hidden;
    position: relative;
    top: 5px;
}
.pair:not(:hover) .pair_hide {
    max-width: 0;
}
.pairX .pair_hide {
    max-width: 4em;
    transition: max-width 1s ease-in;
}

/* Dropdown Button */
.dropbtn {
  border-bottom: 2px solid red;
}

/* The container &lt;div&gt; - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 5px 2px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd;}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {display: block;}

&lt;/style&gt;
&lt;script src="https://d3js.org/d3.v3.min.js" charset="utf-8" &gt; &lt;/script&gt;


&lt;div id="animation_conv_filters" style="background: white"&gt;
    &lt;div class="display_vis_input language-python" style="font-family: monospace; color: black; padding: 10px;"&gt;
        &lt;!-- default --&gt;
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, 1&lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="3"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;)&lt;br&gt;
        conv = torch.nn.Conv2d(in_channels=1&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;, out_channels=1&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;,
        kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;)&lt;/span&gt;&lt;/span&gt;
        &lt;span class="pair" style="display: none"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="hidden" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="hidden" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;
        &lt;span class="pair" style="display: none"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="hidden" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="hidden" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)

        &lt;!-- padding
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, 1&lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;))&lt;br&gt;
        conv = torch.nn.Conv2d(in_channels=1&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;, out_channels=1&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;,
        kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="3"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)
--&gt;
    &lt;!-- filters -- &gt;
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, &lt;input class="input_matrixz" type="number" min="1" max="3" value="3"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;)&lt;br&gt;
        conv = torch.nn.Conv2d(in_channels=&lt;input class="input_matrixzB" type="number" min="1" max="3" value="3"&gt;, out_channels=&lt;input class="input_filterz" type="number" min="1" max="3" value="2"&gt;,
        kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)
--&gt;
 &lt;!--
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, &lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;1, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;))&lt;br&gt;
        conv = torch.nn.&lt;div class="dropdown"&gt;
  &lt;div class="dropbtn"&gt;MaxPool2d&lt;/div&gt;
  &lt;div class="dropdown-content"&gt;
    &lt;a class="select_maxpool" href="#"&gt;MaxPool2d&lt;/a&gt;
    &lt;a class="select_avgpool" href="#"&gt;AvgPool2d&lt;/a&gt;
  &lt;/div&gt;
&lt;/div&gt;(&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)
--&gt;
    &lt;/div&gt;
        &lt;button class="button_play play"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 1.5,0 9.5,5 1.5,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;button class="button_play pause" style="display: none"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 0,0 4,0 4,10, 0,10 z"/&gt;&lt;path d="M 6,0 10,0 10,10, 6,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;input type="range" min="1" max="100" value="50" class="slider" style="width: 300px; display: inline-block"&gt;
    &lt;button class="button_play left"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,5 4,0 4,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;button class="button_play right"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,0 4,5 0,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;input type="checkbox" class="play_fast"&gt;fast play mode
    &lt;br/&gt;
    &lt;svg height="0" width="0"&gt;
        &lt;defs&gt;
    &lt;marker id="arrowhead" markerWidth="10" markerHeight="7"
    refX="0" refY="1.5" orient="auto" fill="rgb(236, 58, 58)"&gt;
      &lt;polygon points="0 0, 4 1.5, 0 3" /&gt;
    &lt;/marker&gt;
  &lt;/defs&gt;
    &lt;/svg&gt;
    &lt;svg class="image" height="460" width="600"&gt;

    &lt;/svg&gt;
&lt;/div&gt;
&lt;script&gt;
(function() {
var dom_target = document.getElementById("animation_conv_filters")
const divmod = (x, y) =&gt; [Math.floor(x / y), x % y];
var svg = d3.select(dom_target).select(".image")

var box_s = 50;
var box_z = 10;
var show_single_elements = true;
var group_func = undefined;
function mulberry32(a) {
    return function() {
      var t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t &gt;&gt;&gt; 15, t | 1);
      t ^= t + Math.imul(t ^ t &gt;&gt;&gt; 7, t | 61);
      return ((t ^ t &gt;&gt;&gt; 14) &gt;&gt;&gt; 0) / 4294967296;
    }
}

function numberGenerator(seed, max, digits) {
    var random = mulberry32(seed)
    return () =&gt; parseFloat((random() * max).toFixed(digits));
}
window.numberGenerator = numberGenerator
window.mulberry32 = mulberry32
function generateMatrix2(number, dims) {
    var res = [];
    for (var i = 0; i &lt; dims[0]; i++) {
        if(dims.length == 1)
            res.push(number())
        else
            res.push(generateMatrix2(number, dims.slice(1)));
    }
    return res
}
window.generateMatrix2 = generateMatrix2

function addPadding(matrix, paddingx, paddingy) {
    matrix = JSON.parse(JSON.stringify(matrix));
    var ly = matrix.length; var lx = matrix[0].length;
    for (var i = 0; i &lt; ly; i++) {
        for(var p = 0; p &lt; paddingx; p++) {
            matrix[i].splice(0, 0, 0);
            matrix[i].splice(matrix[i].length, 0, 0);
        }
    }
    for(var p = 0; p &lt; paddingy; p++) {
        matrix.splice(0, 0, []);
        matrix.splice(matrix.length, 0, []);
        for (var i = 0; i &lt; lx + paddingx * 2; i++) {
            matrix[0].push(0);
            matrix[matrix.length - 1].push(0);
        }
    }
    matrix.paddingx = paddingx;
    matrix.paddingy = paddingy;
    return matrix;
}

var stride_x = 1;
var stride_y = 1;
function convolve(matrix, filter) {
    var ress = [];
    for(var zz = 0; zz &lt; filter.length; zz++) {
        var res = [];
        for (var i = 0; i &lt; parseInt((matrix[0].length - filter[0][0].length + stride_y) / stride_y); i++) {
            res.push([]);
            for (var j = 0; j &lt; parseInt((matrix[0][0].length - filter[0][0][0].length + stride_x) / stride_x); j++) {
                var answer = 0;
                var text = "";
                for (var ii = 0; ii &lt; filter[0][0].length; ii++) {
                    for (var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                        for (var z = 0; z &lt; matrix.length; z++) {
                            answer += matrix[z][i * stride_y + ii][j * stride_x + jj] * filter[zz][z][ii][jj];
                            text +=matrix[z][i * stride_y + ii][j * stride_x + jj] + "*" + filter[zz][z][ii][jj]+"+";
                        }
                    }
                }
                console.log(i, j, text, "=", answer)
                res[res.length - 1].push(answer.toFixed(1))
            }
        }
        ress.push(res)
    }
    return ress;
}
function pool(matrix, filter, func) {
    var res = [];
    for (var i = 0; i &lt; parseInt((matrix.length - filter.length + stride_y) / stride_y); i++) {
        res.push([]);
        for (var j = 0; j &lt; parseInt((matrix[0].length - filter[0].length + stride_x) / stride_x); j++) {
            var answer = [];
            for(var ii = 0; ii &lt; filter.length; ii++) {
                for(var jj = 0; jj &lt; filter[0].length; jj++) {
                    answer.push(matrix[i* stride_y + ii][j* stride_x + jj]);
                }
            }
            if(func == "max")
                res[res.length-1].push(Math.max(...answer))
            else {
                var sum = 0;
                for( var ii = 0; ii &lt; answer.length; ii++)
                    sum += answer[ii]; //don't forget to add the base
                var avg = sum/answer.length;
                res[res.length-1].push(parseFloat(avg.toFixed(1)));
            }

        }
    }
    return res;
}

class Matrix {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`);
        for(var z = 0; z &lt; matrix.length; z++) {
            var gg = this.g.append("g").attr("class", "matrix_layer").attr("transform", `translate(${- z*box_z}, ${+ z*box_z})`);
            for (var j = 0; j &lt; matrix[0].length; j++) {
                for (var i = 0; i &lt; matrix[0][0].length; i++) {
                    var element = gg.append("g").attr("class", "cell").attr("transform", `translate(${i * box_s}, ${j * box_s})`);
                    var rect = element.append("rect")
                        .attr("class", "number")
                        .attr("x", -box_s / 2 + "px")
                        .attr("y", -box_s / 2 + "px")
                        .attr("width", box_s + "px")
                        .attr("height", box_s + "px")
                    if (i &lt; matrix.paddingx || j &lt; matrix.paddingy || i &gt; matrix[0][0].length - matrix.paddingx - 1 || j &gt; matrix[0].length - matrix.paddingy - 1)
                        element.attr("class", "cell padding")
                    element.append("text").text(matrix[z][j][i]).attr("text-anchor", "middle").attr("alignment-baseline", "center").attr("dy", "0.3em")
                }
            }
            gg.append("rect").attr("class", "highlight3")
            gg.append("rect").attr("class", "highlight1")
            gg.append("rect").attr("class", "highlight2")
        }
        //&lt;line x1="0" y1="50" x2="250" y2="50" stroke="#000" stroke-width="8" marker-end="url(#arrowhead)" /&gt;
        this.arrow = gg.append("line").attr("transform", `translate(${(-0.5)*box_s}, ${(-0.5+filter.length/2)*box_s})`).attr("marker-end", "url(#arrowhead)").attr("x1", 0).attr("y1", 0).attr("x2", 50).attr("y2", 0)
            .attr("stroke", "#000").attr("stroke-width", 8).attr("stroke", "rgb(236, 58, 58)").style("opacity", 0)


        gg.append("text").attr("class", "title").text(title)
            .attr("x", (matrix[0][0].length/2-0.5)*box_s+"px")
            .attr("y", (matrix[0].length)*box_s+"px")
            .attr("dy", "0em")
        this.highlight2_hidden = true
    }

    setHighlight1(i, j, w, h) {
        if(this.old_i == i &amp;&amp; this.old_j == j &amp;&amp; this.old_w == w)
            return
        if(i == this.old_i+stride_x || j == this.old_j+stride_y) {
            if (this.old_j == j)
                this.arrow.attr("x1", this.old_i * box_s).attr("y1", j * box_s)
                    .attr("x2", i * box_s - 30).attr("y2", j * box_s).attr("transform", `translate(${(-0.5) * box_s}, ${(-0.5 + h / 2) * box_s})`)
            else
                this.arrow.attr("x1", i * box_s).attr("y1", this.old_j * box_s)
                    .attr("x2", i * box_s).attr("y2", j * box_s - 30).attr("transform", `translate(${(-0.5 + w / 2) * box_s}, ${(-0.5) * box_s})`)
            this.arrow.transition().style("opacity", 1)
                .transition()
                .duration(1000)
                .style("opacity", 0)
        }
        this.old_i = i; this.old_j = j; this.old_w = w;
        this.g.selectAll(".highlight1")
            .style("fill", "rgba(236, 58, 58, 0)")
            .transition()
            .duration(1000)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
            .style("fill", "rgba(236, 58, 58, 0.25)")
        this.g.selectAll(".highlight3")
            .style("opacity", 1)
            .transition()
            .duration(1000)
            .style("opacity", 0)
        this.g.selectAll(".highlight3")
            .transition()
            .delay(900)
            .duration(0)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
//            .style("opacity", 1)
    }

    setHighlight2(i, j, w, h) {
        if(this.highlight2_hidden == true) {
            this.g.selectAll(".highlight2")
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
            .transition()
            .duration(1000)
            .style("opacity", 1)
            this.highlight2_hidden = false
            return
        }
        this.g.selectAll(".highlight2")
            .transition()
            .duration(1000)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px");
    }
    hideHighlight2() {
        this.highlight2_hidden = true
        this.g.selectAll(".highlight2")
            .transition()
            .duration(1000)
            .style("opacity", 0)
    }
    //m.g.selectAll(".cell text").style("opacity", (d, i)=&gt;{console.log(i&gt;4); return 1*(i&gt;5)})
}

class Calculation {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
        this.g.append("text").text(title).attr("dy", "-1.5em").attr("dx", "2em")
        this.g = this.g.append("text")
        for (var j in matrix) {
            for (var i in matrix[j]) {
                var element = this.g;
                var a = element.append("tspan")
                    .text(i+"·"+j)
                if(i == 0 &amp;&amp; j &gt; 0)
                    a.attr("dy", "1.5em").attr("x", 0)
                if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                    a = element.append("tspan")
                    .attr("dy", "1.5em").attr("x", 0)
                    .text(" = 12 ")
                }
                else {
                    a = element.append("tspan")
                        .text(" + ")
                }
            }
        }
    }
    setText(i, text) {
        d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
    }
    hideAll() {
        this.g.selectAll("tspan")
            .attr("fill", "white")
    }
    setHighlight1(i) {
        this.g.selectAll("tspan")
            .transition()
            .duration(1000)
            .attr("fill",
            (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

    }
}

class CalculationPool {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
        this.g.append("text").text(title).attr("dy", "-3em").attr("dx", "-2em")
        this.g.append("text").text(group_func+"([").attr("dy", "-1.5em").attr("dx", "-0.5em")
        this.g = this.g.append("text")
        for (var j in matrix) {
            for (var i in matrix[j]) {
                var element = this.g;
                var a = element.append("tspan")
                    .text("")
                if(i == 0 &amp;&amp; j &gt; 0)
                    a.attr("dy", "1.5em").attr("x", 0)
                if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                    a = element.append("tspan")
                    .attr("dy", "1.5em").attr("x", 0).attr("dx", "-0.5em")
                    .text("")
                }
                else {
                    a = element.append("tspan")
                        .text("")
                }
            }
        }
    }
    setText(i, text) {
        d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
    }
    hideAll() {
        this.g.selectAll("tspan")
            .attr("fill", "white")
    }
    setHighlight1(i) {
        this.g.selectAll("tspan")
            .transition()
            .duration(1000)
            .attr("fill",
            (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

    }
}

var matrix, res, m, f, r, c, last_pos, index_max;
function init() {
    show_single_elements = dom_target.querySelector(".play_fast").checked == false
    /*
    tuple_or_single = (x, y) =&gt; x == y ? x : `(${x}, ${y})`
    if(group_func == "max")
        dom_target.querySelector(".torch_name").innerText = `torch.nn.MaxPool2d(kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
    else if(group_func == "mean")
            dom_target.querySelector(".torch_name").innerHTML = `torch.nn.AvgPool2d(x=&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;, kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
    else
        dom_target.querySelector(".torch_name").innerText = `torch.nn.Conv2d(in_channels=1, out_channels=1,  kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`

    if(window.hljs != undefined)
        hljs.highlightElement(dom_target.querySelector(".torch_name"))
    */
    svg.selectAll("*").remove();

    dom_target.querySelector(".input_matrixzB").value = dom_target.querySelector(".input_matrixz").value

    console.log("dom_target", dom_target)
    console.log("dom_target.querySelector(\".input_filterx\").value)", dom_target.querySelector(".input_filterx").value)
    filter = generateMatrix2(numberGenerator(17, 0.9, 1), [parseInt(dom_target.querySelector(".input_filterz").value), parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_filtery").value), parseInt(dom_target.querySelector(".input_filterx").value)]);
    if(dom_target.querySelector(".input_filterx").value == dom_target.querySelector(".input_filtery").value)
        dom_target.querySelector(".input_filtery").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_filtery").parentElement.className = "pairX"
    matrix_raw = generateMatrix2(numberGenerator(4, 9, 0), [parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_matrixy").value), parseInt(dom_target.querySelector(".input_matrixx").value)]);

    matrix = JSON.parse(JSON.stringify(matrix_raw));
    for(var z = 0; z &lt; matrix.length; z++)
        matrix[z] = addPadding(matrix_raw[z], parseInt(dom_target.querySelector(".input_paddingx").value), parseInt(dom_target.querySelector(".input_paddingy").value));
    matrix.paddingx = matrix[0].paddingx
    matrix.paddingy = matrix[0].paddingy
    stride_x = parseInt(dom_target.querySelector(".input_stridex").value)
    stride_y = parseInt(dom_target.querySelector(".input_stridey").value)

    if(dom_target.querySelector(".input_stridex").value == dom_target.querySelector(".input_stridey").value)
        dom_target.querySelector(".input_stridey").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_stridey").parentElement.className = "pairX"
        if(dom_target.querySelector(".input_paddingx").value == dom_target.querySelector(".input_paddingy").value)
        dom_target.querySelector(".input_paddingy").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_paddingy").parentElement.className = "pairX"

    res = convolve(matrix, filter);
        window.matrix = matrix
        window.filter = filter
        window.res = res
    if(group_func != undefined)
        res = [pool(matrix[0], filter[0][0], group_func)]

    m = new Matrix(1*box_s, (1+filter[0][0].length+1.5)*box_s, matrix, "Matrix");

    f = []
    for(var zz = 0; zz &lt; filter.length; zz++)
        f.push(new Matrix((1+(matrix[0][0].length-filter[zz][0][0].length)/2 + zz*(1+filter[zz][0][0].length))*box_s, 1*box_s, filter[zz], group_func == undefined ? (filter.length != 1? `Filter ${zz}` : `Filter`) : "Pooling"));
    if(group_func != undefined)
        f[0].g.selectAll(".cell text").attr("fill", "white")

    console.log("res", res)
    r = new Matrix((2+(matrix[0][0].length)+1)*box_s, (1+filter[0][0].length+1.5)*box_s, res, "Result");

    var c_x = Math.max((1+(matrix[0][0].length))*box_s, (3+filter.length*(1+(filter[0][0].length)))*box_s)
    console.log("m,ax", (1+(matrix[0][0].length)), filter.length*(1+(filter[0][0].length)))
    if(group_func != undefined)
        c = new CalculationPool(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");
    else
        c = new Calculation(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");

    last_pos = undefined;
    if(show_single_elements)
        index_max = filter.length*res[0].length*res[0][0].length*(filter[0][0].length * filter[0][0][0].length * filter[0].length + 2)
    else
        index_max = filter.length*res[0].length*res[0][0].length
    window.index_max = index_max
    window.filter = filter
    setHighlights(0, 0)
    svg.attr("width", box_s*(matrix[0][0].length+res[0][0].length+4)+(c.g.node().getBoundingClientRect().width)+"px");
    svg.attr("height", box_s*(matrix[0].length+filter[0][0].length+3.0)+"px");
}
init()

function setHighlights(pos_zz, subpos) {
    var [zz, pos] = divmod(pos_zz, res[0].length*res[0][0].length)
    var [i, j] = divmod(pos, res[0][0].length)
    i *= stride_y;
    j *= stride_x;
    var [j2, i2] = divmod(subpos, filter[0][0][0].length * filter[0].length)
    var [i2, z2] = divmod(i2, filter[0].length)
    subpos = Math.floor(subpos/filter[0].length)
    console.log(zz, i, j, j2, i2, z2)
    if(last_pos != pos || 1) {
        var answer = 0;
        for(var ii = 0; ii &lt; filter[0][0].length; ii++) {
            for(var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                var text = []
                if(filter[0].length == 1) {
                    for(var z = 0; z &lt; filter[0].length; z++) {
                        if (group_func != undefined)
                            text.push(matrix[0][i + ii][j + jj] + ", ");
                        else
                            text.push(matrix[z][i + ii][j + jj] + " · " + filter[zz][z][ii][jj]);
                    }
                    if (group_func != undefined)
                        c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                    else
                        c.setText(ii * filter[0][0][0].length + jj, text.join("+"));
                }
                else {
                    let max_z = (ii == j2 &amp;&amp; jj == i2) ? z2+1 : filter[0].length
                    for (var z = 0; z &lt; max_z; z++) {
                        if (group_func != undefined)
                            text.push(matrix[0][i + ii][j + jj] + ", ");
                        else
                            text.push(matrix[z][i + ii][j + jj] + "·" + filter[zz][z][ii][jj]);
                        console.log(z, z2, text)
                    }
                    console.log("----------")
                    if (group_func != undefined)
                        c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                    else
                        c.setText(ii * filter[0][0][0].length + jj, "(" + text.join("+") + ((filter[0].length==max_z)?")":""));
                }
            }
        }
        if(group_func != undefined)
            c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   ]) = "+res[zz][i/stride_y][j/stride_x])
        else
            c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   = "+res[zz][i/stride_y][j/stride_x])
        if(last_pos != pos)
            c.hideAll();
        last_pos = pos;
    }
    m.setHighlight1(j, i, filter[0][0][0].length, filter[0][0].length)
    for(var zzz = 0; zzz &lt; filter.length; zzz++) {
        console.log(zzz, zz, zzz == zz)
        if (zzz == zz)
            f[zzz].setHighlight1(0, 0, filter[0][0][0].length, filter[0][0].length)
        else
            f[zzz].setHighlight1(0, 0, 0, 0)
    }
    window.f = f

    r.setHighlight1(j/stride_x, i/stride_y, 1, 1)
    r.g.selectAll(".matrix_layer").attr("opacity", (d,i) =&gt; i &gt; zz ? 0.2 : 1 )
    r.g.selectAll(".matrix_layer .highlight1").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
    r.g.selectAll(".matrix_layer .highlight3").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
    window.r = r

    let matrixpos = (i + j2) * matrix[0][0].length + (j + i2)
    m.g.selectAll(".matrix_layer").each(function(p, j){
        console.log(d3.select(this).select("highlight2"))
        d3.select(this).selectAll(".cell").attr("opacity", (d,i) =&gt; (i == matrixpos &amp;&amp; j &gt; z2 &amp;&amp; subpos &lt; filter[0][0].length * filter[0][0][0].length) ? 0 : 1 );
        d3.select(this).select(".highlight2").style("stroke", (d,i) =&gt; (j != z2) ? "transparent" : "rgb(229, 132, 66)");
    })
    f[zz].g.selectAll(".matrix_layer").each(function(p, j){
        console.log(d3.select(this).select("highlight2"), subpos, i2, j2, z2)
        d3.select(this).selectAll(".cell").attr("opacity", (d,i) =&gt; (i == subpos &amp;&amp; j &gt; z2 &amp;&amp; subpos &lt; filter[0][0].length * filter[0][0][0].length) ? 0 : 1 );
        d3.select(this).select(".highlight2").style("stroke", (d,i) =&gt; (j != z2) ? "transparent" : "rgb(229, 132, 66)");
        //d3.select(this).select(".highlight1").style("stroke", (d,i) =&gt; (j == z2) ? "visible" : "hidden");
        //d3.select(this).select(".highlight3").style("stroke", (d,i) =&gt; (j == z2) ? "visible" : "hidden");
    })

    if(subpos &lt; filter[0][0].length * filter[0][0][0].length) {
        m.setHighlight2(j + i2, i + j2, 1, 1)
        if(group_func == undefined)
            for(var zzz = 0; zzz &lt; filter.length; zzz++) {
                if (zzz == zz)
                    f[zzz].setHighlight2(i2, j2, 1, 1)
                else
                    f[zzz].hideHighlight2()
            }
        r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt;= pos_zz ? "white" : "black")
        c.setHighlight1(subpos);
    }
    else {
        m.hideHighlight2()
        for(var zzz = 0; zzz &lt; filter.length; zzz++)
            f[zzz].hideHighlight2()
        r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt; pos_zz ? "white" : "black")
        if(subpos &gt; filter[0][0].length * filter[0][0][0].length) {
            c.hideAll()
        }
        else
            c.setHighlight1(subpos);
    }

    function p(x) { console.log(x); return x}
}
function animate(frame) {
    dom_target.querySelector("input[type=range]").value = index;
    dom_target.querySelector("input[type=range]").max = index_max - 1;
    dom_target.querySelector("input[type=range]").min = 0;
    if(show_single_elements) {
        var [pos, subpos] = divmod(frame, filter[0][0].length * filter[0][0][0].length * filter[0].length + 2)
        setHighlights(pos, subpos);
    }
    else
        setHighlights(frame, filter[0][0].length * filter[0][0][0].length * filter[0].length);
}
var index = -1
animate(0)
var interval = undefined;

function PlayStep() {
    index += 1;
    if(index &gt;= index_max)
        index = 0;
    animate(index);
}

function playPause() {
    if(interval === undefined) {
        dom_target.querySelector(".play").style.display = "none"
        dom_target.querySelector(".pause").style.display = "inline-block"
        interval = window.setInterval(PlayStep, 1000);
        PlayStep();
    }
    else {
        dom_target.querySelector(".play").style.display = "inline-block"
        dom_target.querySelector(".pause").style.display = "none"
        window.clearInterval(interval);
        interval = undefined;
    }
}
dom_target.querySelector("input[type=range]").value = 0;
dom_target.querySelector("input[type=range]").max = index_max;
dom_target.querySelector("input[type=range]").onchange = (i)=&gt;{var v = parseInt(i.target.value); index = v; animate(v);};
dom_target.querySelector(".play").onclick = playPause;
dom_target.querySelector(".pause").onclick = playPause;
dom_target.querySelector(".left").onclick = ()=&gt;{index &gt; 0 ? index -= 1 : index = index_max-1; animate(index);};
dom_target.querySelector(".right").onclick = ()=&gt;{index &lt; index_max-1 ? index += 1 : index = 0; animate(index);};

dom_target.querySelector(".input_filterx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_filtery").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_filterz").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixy").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixz").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixzB").onchange = (i)=&gt;{dom_target.querySelector(".input_matrixz").value = parseInt(i.target.value); init();};
dom_target.querySelector(".input_paddingx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_paddingy").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_stridex").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_stridey").onchange = ()=&gt;{init()}
dom_target.querySelector(".play_fast").onchange = ()=&gt;{init()}

//dom_target.querySelector(".select_maxpool").onclick = ()=&gt;{group_func="max"; dom_target.querySelector(".dropbtn").innerText = "MaxPool2d"; init()}
//dom_target.querySelector(".select_avgpool").onclick = ()=&gt;{group_func="avg"; dom_target.querySelector(".dropbtn").innerText = "AvgPool2d"; init()}

})();
&lt;/script&gt;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">  File</span><span class="nn"> "/tmp/ipykernel_7642/1723788140.py"</span><span class="gt">, line </span><span class="mi">3</span>
    <span class="o">&lt;</span><span class="n">style</span><span class="o">&gt;</span>
    <span class="o">^</span>
<span class="ne">SyntaxError</span>: invalid syntax
</pre></div>
</div>
</div>
</div>
<div class="section" id="definitional-note">
<h4>Definitional Note<a class="headerlink" href="#definitional-note" title="Permalink to this headline">¶</a></h4>
<p>If you have a background in signal processing or math, you may have already heard of convolution. However, the definitions in other domains and the one we use here are slightly different. The more common definition involves flipping the kernel horizontally and vertically before sliding.</p>
<p><strong>For our purposes, no flipping is needed. If you are familiar with conventions involving flipping, just assume the kernel is pre-flipped.</strong></p>
<p>In more general usage, the no-flip operation that we call convolution is known as <em>cross-correlation</em> (hence the usage of <code class="docutils literal notranslate"><span class="pre">scipy.signal.correlate2d</span></code> in the next exercise). Early papers used the more common definition of convolution, but not using a flip is easier to visualize, and in fact the lack of flip does not impact a CNN’s ability to learn.</p>
</div>
</div>
</div>
<div class="section" id="coding-exercise-2-1-convolution-of-a-simple-kernel">
<h2>Coding Exercise 2.1: Convolution of a Simple Kernel<a class="headerlink" href="#coding-exercise-2-1-convolution-of-a-simple-kernel" title="Permalink to this headline">¶</a></h2>
<p>At its core, convolution is just repeatedly multiplying a matrix, known as a <em>kernel</em> or <em>filter</em>, with some other, larger matrix (in our case the pixels of an image). Consider the below image and kernel:</p>
<div class="amsmath math notranslate nohighlight" id="equation-78a5b4f7-6233-43c4-8001-c68b5a97f26d">
<span class="eqno">(55)<a class="headerlink" href="#equation-78a5b4f7-6233-43c4-8001-c68b5a97f26d" title="Permalink to this equation">¶</a></span>\[\begin{align}
\textbf{Image} &amp;= 
\begin{bmatrix}0 &amp; 200 &amp; 200 \\0 &amp; 0 &amp; 200 \\ 0 &amp; 0 &amp; 0  
\end{bmatrix} \\ \\
\textbf{Kernel} &amp;= 
\begin{bmatrix} \frac{1}{4} &amp;\frac{1}{4} \\\frac{1}{4} &amp; \frac{1}{4}
\end{bmatrix} 
\end{align}\]</div>
<p>Perform (by hand) the operations needed to convolve the kernel and image above. Afterwards enter your results in the “solution” section in the code below. Think about what this specific kernel is doing to the original image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">conv_check</span><span class="p">():</span>
  <span class="c1">####################################################################</span>
  <span class="c1"># Fill in missing code below (the elements of the matrix),</span>
  <span class="c1"># then remove or comment the line below to test your function</span>
  <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Fill in the solution matrix, then delete this"</span><span class="p">)</span>
  <span class="c1">####################################################################</span>
  <span class="c1"># Write the solution array and call the function to verify it!</span>
  <span class="n">solution</span> <span class="o">=</span> <span class="o">...</span>

  <span class="n">original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">]</span>
                       <span class="p">])</span>

  <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                     <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>
                     <span class="p">])</span>

  <span class="n">actual_convolution</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">correlate2d</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">"valid"</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">solution</span> <span class="o">==</span> <span class="n">actual_convolution</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"✅ Your solution is correct!</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"❌ Your solution is incorrect.</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">original</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">actual_convolution</span><span class="p">,</span> <span class="n">solution</span>


<span class="c1"># add event to airtable</span>
<span class="n">atform</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">'Coding Exercise 2.1: Convolution of a Simple Kernel'</span><span class="p">)</span>

<span class="c1">## Uncomment to test your solution!</span>
<span class="c1"># original, kernel, actual_convolution, solution = conv_check()</span>
<span class="c1"># make_plots(original, actual_convolution, solution)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_ecc74cf8.py"><em>Click for solution</em></a></p>
<p><em>Example output:</em></p>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/W2D1_Tutorial1_Solution_ecc74cf8_1.png"><img align="center" alt="Solution hint" class="align-center" src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/W2D1_Tutorial1_Solution_ecc74cf8_1.png" style="width: 363.0px; height: 396.0px;"/></a>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/W2D1_Tutorial1_Solution_ecc74cf8_2.png"><img align="center" alt="Solution hint" class="align-center" src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/W2D1_Tutorial1_Solution_ecc74cf8_2.png" style="width: 391.0px; height: 396.0px;"/></a>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/W2D1_Tutorial1_Solution_ecc74cf8_3.png"><img align="center" alt="Solution hint" class="align-center" src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/W2D1_Tutorial1_Solution_ecc74cf8_3.png" style="width: 363.0px; height: 396.0px;"/></a>
</div>
<div class="section" id="coding-exercise-2-2-convolution-output-size">
<h2>Coding Exercise 2.2: Convolution Output Size<a class="headerlink" href="#coding-exercise-2-2-convolution-output-size" title="Permalink to this headline">¶</a></h2>
<p>Now, you have manually calculated a convolution. How did this change the shape of the output? When you know the shapes of the input matrix and kernel, what is the shape of the output?</p>
<p><em>Hint: If you have problems figuring out what the output shape should look like, go back to the visualisation and see how the output shape changes as you modify the image and kernel size</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_output_shape</span><span class="p">(</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">):</span>
  <span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span> <span class="o">=</span> <span class="n">image_shape</span>
  <span class="n">kernel_height</span><span class="p">,</span> <span class="n">kernel_width</span> <span class="o">=</span> <span class="n">kernel_shape</span>
  <span class="c1">####################################################################</span>
  <span class="c1"># Fill in missing code below, then remove or comment the line below to test your function</span>
  <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Fill in the lines below, then delete this"</span><span class="p">)</span>
  <span class="c1">####################################################################</span>
  <span class="n">output_height</span> <span class="o">=</span> <span class="o">...</span>
  <span class="n">output_width</span> <span class="o">=</span> <span class="o">...</span>
  <span class="k">return</span> <span class="n">output_height</span><span class="p">,</span> <span class="n">output_width</span>


<span class="c1"># add event to airtable</span>
<span class="n">atform</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">'Coding Exercise 2.2: Convolution Output Size'</span><span class="p">)</span>

<span class="c1"># here we check if your function works correcly by applying it to different image</span>
<span class="c1"># and kernel shapes</span>
<span class="c1"># check_shape_function(calculate_output_shape, image_shape=(3, 3), kernel_shape=(2, 2))</span>
<span class="c1"># check_shape_function(calculate_output_shape, image_shape=(3, 4), kernel_shape=(2, 3))</span>
<span class="c1"># check_shape_function(calculate_output_shape, image_shape=(5, 5), kernel_shape=(5, 5))</span>
<span class="c1"># check_shape_function(calculate_output_shape, image_shape=(10, 20), kernel_shape=(3, 2))</span>
<span class="c1"># check_shape_function(calculate_output_shape, image_shape=(100, 200), kernel_shape=(40, 30))</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_a728d667.py"><em>Click for solution</em></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>✅ Output for image_shape: (3, 3) and kernel_shape: (2, 2), output_shape: (2, 2), is correct.
✅ Output for image_shape: (3, 4) and kernel_shape: (2, 3), output_shape: (2, 2), is correct.
✅ Output for image_shape: (5, 5) and kernel_shape: (5, 5), output_shape: (1, 1), is correct.
✅ Output for image_shape: (10, 20) and kernel_shape: (3, 2), output_shape: (8, 19), is correct.
✅ Output for image_shape: (100, 200) and kernel_shape: (40, 30), output_shape: (61, 171), is correct.
</pre></div>
</div>
</div>
<div class="section" id="coding-exercise-2-3-coding-a-convolution">
<h2>Coding Exercise 2.3: Coding a Convolution<a class="headerlink" href="#coding-exercise-2-3-coding-a-convolution" title="Permalink to this headline">¶</a></h2>
<p>Here, we have the skeleton of a function that performs convolution using the provided image and kernel matrices.</p>
<p><em>Exercise:</em> Fill in the missing lines of code. You can test your function by uncommenting the sections beneath it.</p>
<p>Note: in more general situations, once you understand convolutions, you can use functions already available in <code class="docutils literal notranslate"><span class="pre">pytorch</span></code>/<code class="docutils literal notranslate"><span class="pre">numpy</span></code> to perform convolution (such as <code class="docutils literal notranslate"><span class="pre">scipy.signal.correlate2d</span></code> or <code class="docutils literal notranslate"><span class="pre">scipy.signal.convolve2d</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convolution2d</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">):</span>
  <span class="sd">"""Convolves a 2D image matrix with a kernel matrix. Both are numpy arrays."""</span>

  <span class="c1"># get the height/width of the image, kernel, and output</span>
  <span class="n">im_h</span><span class="p">,</span> <span class="n">im_w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">ker_h</span><span class="p">,</span> <span class="n">ker_w</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">out_h</span> <span class="o">=</span> <span class="n">im_h</span> <span class="o">-</span> <span class="n">ker_h</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">out_w</span> <span class="o">=</span> <span class="n">im_w</span> <span class="o">-</span> <span class="n">ker_w</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="c1"># create an empty matrix in which to store the output</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">out_h</span><span class="p">,</span> <span class="n">out_w</span><span class="p">))</span>

  <span class="c1"># iterate over the different positions at which to apply the kernel,</span>
  <span class="c1">#   storing the results in the output matrix</span>
  <span class="k">for</span> <span class="n">out_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out_h</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">out_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out_w</span><span class="p">):</span>
      <span class="c1"># overlay the kernel on part of the image</span>
      <span class="c1">#   (multiply each element of the kernel with some element of the image, then sum)</span>
      <span class="c1">#   to determine the output of the matrix at a point</span>
      <span class="n">current_product</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ker_h</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ker_w</span><span class="p">):</span>
          <span class="c1">####################################################################</span>
          <span class="c1"># Fill in missing code below (...),</span>
          <span class="c1"># then remove or comment the line below to test your function</span>
          <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Implement the convolution function"</span><span class="p">)</span>
          <span class="c1">####################################################################</span>
          <span class="n">current_product</span> <span class="o">+=</span> <span class="o">...</span>

      <span class="n">output</span><span class="p">[</span><span class="n">out_row</span><span class="p">,</span> <span class="n">out_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_product</span>

  <span class="k">return</span> <span class="n">output</span>


<span class="c1"># add event to airtable</span>
<span class="n">atform</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">'Coding Exercise 2.3: Coding a Convolution'</span><span class="p">)</span>

<span class="c1">## Tests</span>
<span class="c1"># first, we test the parameters we used before in the manual-calculation example</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">200</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">]])</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]])</span>
<span class="c1"># check_conv_function(convolution2d, image, kernel)</span>

<span class="c1"># next, we test with a different input and kernel (the numbers 1-9 and 1-4)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># check_conv_function(convolution2d, image, kernel)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_79e1f5fb.py"><em>Click for solution</em></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>✅ The function calculated the convolution correctly.
✅ The function calculated the convolution correctly.
</pre></div>
</div>
<div class="section" id="convolution-on-the-chicago-skyline">
<h3>Convolution on the Chicago Skyline<a class="headerlink" href="#convolution-on-the-chicago-skyline" title="Permalink to this headline">¶</a></h3>
<p>After you have finished programming the above convolution function, run the below coding cell, which applies two different kernels to a greyscale picture of Chicago and takes the geometric average of the results.</p>
<p><strong>Make sure you remove all print statements from your convolution2d implementation, or this will run for a <em>very</em> long time.</strong> It should take somewhere between 10 seconds and 1 minute.</p>
</div>
<div class="section" id="load-images-run-me">
<h3>Load images (run me)<a class="headerlink" href="#load-images-run-me" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown ### Load images (run me)</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">'images/'</span><span class="p">):</span>
  <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">'images/'</span><span class="p">)</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">"https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/chicago_skyline_shrunk_v2.bmp"</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"images/chicago_skyline_shrunk_v2.bmp"</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
  <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the output of your function</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"images/chicago_skyline_shrunk_v2.bmp"</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">skyline_image_file</span><span class="p">:</span>
  <span class="n">img_skyline_orig</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">skyline_image_file</span><span class="p">)</span>
  <span class="n">img_skyline_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img_skyline_orig</span><span class="p">)</span>
  <span class="n">kernel_ver</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
  <span class="n">kernel_hor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
  <span class="n">img_processed_mat_ver</span> <span class="o">=</span> <span class="n">convolution2d</span><span class="p">(</span><span class="n">img_skyline_mat</span><span class="p">,</span> <span class="n">kernel_ver</span><span class="p">)</span>
  <span class="n">img_processed_mat_hor</span> <span class="o">=</span> <span class="n">convolution2d</span><span class="p">(</span><span class="n">img_skyline_mat</span><span class="p">,</span> <span class="n">kernel_hor</span><span class="p">)</span>
  <span class="n">img_processed_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">img_processed_mat_ver</span><span class="p">,</span>
                                          <span class="n">img_processed_mat_ver</span><span class="p">)</span> <span class="o">+</span> \
                              <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">img_processed_mat_hor</span><span class="p">,</span>
                                          <span class="n">img_processed_mat_hor</span><span class="p">))</span>

  <span class="n">img_processed_mat</span> <span class="o">*=</span> <span class="mf">255.0</span><span class="o">/</span><span class="n">img_processed_mat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
  <span class="n">img_processed_mat</span> <span class="o">=</span> <span class="n">img_processed_mat</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
  <span class="n">img_processed</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img_processed_mat</span><span class="p">,</span> <span class="s1">'L'</span><span class="p">)</span>
  <span class="n">display</span><span class="p">(</span><span class="n">img_skyline_orig</span><span class="p">)</span>
  <span class="n">display</span><span class="p">(</span><span class="n">img_processed</span><span class="p">)</span>
</pre></div>
</div>
</div>

</div>
<p>Pretty cool, right? We will go into more detail on what’s happening in the next section.</p>
</div>
</div>
<div class="section" id="section-2-1-demonstration-of-a-cnn-in-pytorch">
<h2>Section 2.1: Demonstration of a CNN in PyTorch<a class="headerlink" href="#section-2-1-demonstration-of-a-cnn-in-pytorch" title="Permalink to this headline">¶</a></h2>
<p>At this point, you should have a fair idea of how to perform a convolution on an image given a kernel. In the following cell, we provide a code snippet that demonstrates setting up a convolutional network using PyTorch.</p>
<p>We look at the <code class="docutils literal notranslate"><span class="pre">nn</span></code> module in PyTorch. The <code class="docutils literal notranslate"><span class="pre">nn</span></code> module contains a plethora of functions that will make implementing a neural network easier. In particular we will look at the <code class="docutils literal notranslate"><span class="pre">nn.Conv2d()</span></code> function, which creates a convolutional layer that is applied to whatever image that you feed the resulting network.</p>
<p>Look at the code below. In it, we define a <code class="docutils literal notranslate"><span class="pre">Net</span></code> class that you can instantiate with a kernel to create a Neural Network object. When you apply the network object to an image (or anything in the form of a matrix), it convolves the kernel over that image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="sd">"""</span>
<span class="sd">  A convolutional neural network class.</span>
<span class="sd">  When an instance of it is constructed with a kernel, you can apply that instance</span>
<span class="sd">    to a matrix and it will convolve the kernel over that image.</span>
<span class="sd">  i.e. Net(kernel)(image)</span>
<span class="sd">  """</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="c1"># Summary of the nn.conv2d parameters (you can also get this by hovering</span>
    <span class="c1"># over the method):</span>
    <span class="c1"># in_channels (int): Number of channels in the input image</span>
    <span class="c1"># out_channels (int): Number of channels produced by the convolution</span>
    <span class="c1"># kernel_size (int or tuple): Size of the convolving kernel</span>
    <span class="c1"># padding (int or tuple, optional): Zero-padding added to both sides of</span>
    <span class="c1">#     the input. Default: 0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> \
                           <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>

    <span class="c1"># set up a default kernel if a default one isn't provided</span>
    <span class="k">if</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">bias</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Format a default 2x2 kernel of numbers from 0 through 3</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="c1"># Prepare the network with that default kernel</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="c1"># set up a 3x3 image matrix of numbers from 0 through 8</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span> <span class="c1"># BatchSizeXChannelsXHeightXWidth</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Image:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Kernel:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kernel</span><span class="p">))</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="c1"># Apply the convolution</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Output:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Image:
tensor([[[[0., 1., 2.],
          [3., 4., 5.],
          [6., 7., 8.]]]])
Kernel:
tensor([[0., 1.],
        [2., 3.]])
Output:
tensor([[[[19., 25.],
          [37., 43.]]]], grad_fn=&lt;ThnnConv2DBackward&gt;)
</pre></div>
</div>
</div>
</div>
<p>As a quick aside, notice the difference in the input and output size. The input had a size of 3×3, and the output is of size 2×2. This is because of the fact that the kernel can’t produce values for the edges of the image - when it slides to an end of the image and is centered on a border pixel, it overlaps space outside of the image that is undefined. If we don’t want to lose that information, we will have to pad the image with some defaults (such as 0s) on the border. This process is, somewhat predictably, called <em>padding</em>. We will talk more about padding in the next section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Image (before padding):</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Kernel:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kernel</span><span class="p">))</span>

<span class="c1"># Prepare the network with the aforementioned default kernel, but this</span>
<span class="c1"># time with padding</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># Apply the convolution onto the padded image</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Output:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Image (before padding):
tensor([[[[0., 1., 2.],
          [3., 4., 5.],
          [6., 7., 8.]]]])
Kernel:
tensor([[0., 1.],
        [2., 3.]])
Output:
tensor([[[[ 0.,  3.,  8.,  4.],
          [ 9., 19., 25., 10.],
          [21., 37., 43., 16.],
          [ 6.,  7.,  8.,  0.]]]], grad_fn=&lt;ThnnConv2DBackward&gt;)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="section-2-2-padding-and-edge-detection">
<h2>Section 2.2: Padding and Edge Detection<a class="headerlink" href="#section-2-2-padding-and-edge-detection" title="Permalink to this headline">¶</a></h2>
<p>Before we start in on the exercises, here’s a visualization to help you think about padding.</p>
<div class="section" id="interactive-demo-2-2-visualization-of-convolution-with-padding-and-stride">
<h3>Interactive Demo 2.2: Visualization of Convolution with Padding and Stride<a class="headerlink" href="#interactive-demo-2-2-visualization-of-convolution-with-padding-and-stride" title="Permalink to this headline">¶</a></h3>
<p>Recall that</p>
<ul class="simple">
<li><p>Padding adds rows and columns of zeros to the outside edge of an image</p></li>
<li><p>Stride length adjusts the distance by which a filter is shifted after each convolution.</p></li>
</ul>
<p>Change the padding and stride and see how this affects the shape of the output. How does the padding need to be configured to maintain the shape of the input?</p>
<p><em>Run this cell to enable the widget!</em></p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># @markdown *Run this cell to enable the widget!*

%%html

&lt;style&gt;
  svg {
      #border: 1px solid black;
  }
  .matrix {
      font-family: sans-serif;
      transition: all 700ms ease-in-out;
  }
  .cell rect {
      fill:white;stroke-width:1;stroke:rgb(0,0,0)
  }
  .padding rect {
      stroke: rgba(0, 0, 0, 0.25);
  }
  .padding text {
      fill: lightgray;
  }
  .highlight1 {
      fill:none;stroke-width:4;stroke: rgb(236, 58, 58);stroke-dasharray:10,5;
  }
  .highlight2 {
      fill:rgba(229, 132, 66, 0.25);stroke-width:5;stroke: rgb(229, 132, 66);
  }
  .highlight3 {
      fill:rgba(236, 58, 58, 0.25);stroke-width:2;stroke: rgb(236, 58, 58);;
  }
  .title {
      text-anchor: middle;
  }
  .button_play {
      display: inline-block;
      background: none;
      border: none;
      position: relative;
      top: -3px;
  }
  .button_play path {
      fill: darkgray;
  }
  .button_play:hover path {
      fill: rgb(236, 58, 58);
  }
  .display_vis_input input:not(:hover)::-webkit-outer-spin-button,
  .display_vis_input input:not(:hover)::-webkit-inner-spin-button {
      /* display: none; &lt;- Crashes Chrome on hover */
      -webkit-appearance: none;
      margin: 0; /* &lt;-- Apparently some margin are still there even though it's hidden */
  }

  .display_vis_input input:not(:hover)[type=number] {
      -moz-appearance:textfield; /* Firefox */
      width: 1ch;
      margin-right: 0px;
      z-index: 0;
  }
  .display_vis_input input[type=number] {
      width: 4ch;
      border: 0px;
      margin-right: -3ch;
      z-index: 6;
      display: inline-block;
      position: relative;
      padding: 0;
      border-bottom: 2px solid red;
      background: white;
      color: black
  }
  .display_vis_input .pair {
      display: inline-block;
      white-space:nowrap;
          position: relative;
  }
  .display_vis_input .pair .pair_hide {
      max-width: 4em;
      transition: max-width 1s ease-in;
      display: inline-block;
      overflow: hidden;
      position: relative;
      top: 5px;
  }
  .pair:not(:hover) .pair_hide {
      max-width: 0;
  }
  .pairX .pair_hide {
      max-width: 4em;
      transition: max-width 1s ease-in;
  }

  /* Dropdown Button */
  .dropbtn {
    border-bottom: 2px solid red;
  }

  /* The container &lt;div&gt; - needed to position the dropdown content */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  /* Dropdown Content (Hidden by Default) */
  .dropdown-content {
    display: none;
    position: absolute;
    background-color: #f1f1f1;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
  }

  /* Links inside the dropdown */
  .dropdown-content a {
    color: black;
    padding: 5px 2px;
    text-decoration: none;
    display: block;
  }

  /* Change color of dropdown links on hover */
  .dropdown-content a:hover {background-color: #ddd;}

  /* Show the dropdown menu on hover */
  .dropdown:hover .dropdown-content {display: block;}
&lt;/style&gt;

&lt;script src="https://d3js.org/d3.v3.min.js" charset="utf-8" &gt; &lt;/script&gt;


&lt;div id="animation_conv_padding" style="background: white"&gt;
  &lt;div class="display_vis_input language-python" style="font-family: monospace; color: black; padding: 10px;"&gt;
      &lt;!-- default -- &gt;
      import torch&lt;br&gt;&lt;br&gt;
      input = torch.rand(1, 1&lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="3"&gt;))&lt;br&gt;
      conv = torch.nn.Conv2d(in_channels=1&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;, out_channels=1&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;,
      kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;&lt;span class="pair_hide"&gt;,
                                                                      &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
      stride=1&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="hidden" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                &lt;input class="input_stridey" type="hidden" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
      padding=0&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="hidden" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_paddingy" type="hidden" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
      result = conv(input)
      --&gt;
      &lt;!-- padding --&gt;
      import torch&lt;br&gt;&lt;br&gt;
      input = torch.rand(1, 1&lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;)&lt;br&gt;
      conv = torch.nn.Conv2d(in_channels=1&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;, out_channels=1&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;,
      kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;&lt;span class="pair_hide"&gt;,
                                                                      &lt;input class="input_filtery" type="number" min="2" max="4" value="3"&gt;)&lt;/span&gt;&lt;/span&gt;,
      stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                &lt;input class="input_stridey" type="number" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
      padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_paddingy" type="number" min="0" max="4" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
      result = conv(input)


&lt;!--
      import torch&lt;br&gt;&lt;br&gt;
      input = torch.rand(1, &lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;1, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;))&lt;br&gt;
      conv = torch.nn.&lt;div class="dropdown"&gt;
&lt;div class="dropbtn"&gt;MaxPool2d&lt;/div&gt;
&lt;div class="dropdown-content"&gt;
  &lt;a class="select_maxpool" href="#"&gt;MaxPool2d&lt;/a&gt;
  &lt;a class="select_avgpool" href="#"&gt;AvgPool2d&lt;/a&gt;
&lt;/div&gt;
&lt;/div&gt;(&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                      &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
      stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                &lt;input class="input_stridey" type="number" min="1" max="2" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
      padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_paddingy" type="number" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
      result = conv(input)
--&gt;
  &lt;/div&gt;
      &lt;button class="button_play play"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 1.5,0 9.5,5 1.5,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
  &lt;button class="button_play pause" style="display: none"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 0,0 4,0 4,10, 0,10 z"/&gt;&lt;path d="M 6,0 10,0 10,10, 6,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
  &lt;input type="range" min="1" max="100" value="50" class="slider" style="width: 300px; display: inline-block"&gt;
  &lt;button class="button_play left"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,5 4,0 4,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
  &lt;button class="button_play right"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,0 4,5 0,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
  &lt;input type="checkbox" class="play_fast"&gt;fast play mode
  &lt;br/&gt;
  &lt;svg height="0" width="0"&gt;
      &lt;defs&gt;
  &lt;marker id="arrowhead" markerWidth="10" markerHeight="7"
  refX="0" refY="1.5" orient="auto" fill="rgb(236, 58, 58)"&gt;
    &lt;polygon points="0 0, 4 1.5, 0 3" /&gt;
  &lt;/marker&gt;
&lt;/defs&gt;
  &lt;/svg&gt;
  &lt;svg class="image" height="460" width="600"&gt;

  &lt;/svg&gt;
&lt;/div&gt;

&lt;script&gt;
  (function() {
  var dom_target = document.getElementById("animation_conv_padding")
  const divmod = (x, y) =&gt; [Math.floor(x / y), x % y];
  var svg = d3.select(dom_target).select(".image")

  var box_s = 50;
  var box_z = 10;
  var show_single_elements = true;
  var group_func = undefined;
  function mulberry32(a) {
      return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t &gt;&gt;&gt; 15, t | 1);
        t ^= t + Math.imul(t ^ t &gt;&gt;&gt; 7, t | 61);
        return ((t ^ t &gt;&gt;&gt; 14) &gt;&gt;&gt; 0) / 4294967296;
      }
  }

  function numberGenerator(seed, max, digits) {
      var random = mulberry32(seed)
      return () =&gt; parseFloat((random() * max).toFixed(digits));
  }
  window.numberGenerator = numberGenerator
  window.mulberry32 = mulberry32
  function generateMatrix2(number, dims) {
      var res = [];
      for (var i = 0; i &lt; dims[0]; i++) {
          if(dims.length == 1)
              res.push(number())
          else
              res.push(generateMatrix2(number, dims.slice(1)));
      }
      return res
  }
  window.generateMatrix2 = generateMatrix2

  function addPadding(matrix, paddingx, paddingy) {
      matrix = JSON.parse(JSON.stringify(matrix));
      var ly = matrix.length; var lx = matrix[0].length;
      for (var i = 0; i &lt; ly; i++) {
          for(var p = 0; p &lt; paddingx; p++) {
              matrix[i].splice(0, 0, 0);
              matrix[i].splice(matrix[i].length, 0, 0);
          }
      }
      for(var p = 0; p &lt; paddingy; p++) {
          matrix.splice(0, 0, []);
          matrix.splice(matrix.length, 0, []);
          for (var i = 0; i &lt; lx + paddingx * 2; i++) {
              matrix[0].push(0);
              matrix[matrix.length - 1].push(0);
          }
      }
      matrix.paddingx = paddingx;
      matrix.paddingy = paddingy;
      return matrix;
  }

  var stride_x = 1;
  var stride_y = 1;
  function convolve(matrix, filter) {
      var ress = [];
      for(var zz = 0; zz &lt; filter.length; zz++) {
          var res = [];
          for (var i = 0; i &lt; parseInt((matrix[0].length - filter[0][0].length + stride_y) / stride_y); i++) {
              res.push([]);
              for (var j = 0; j &lt; parseInt((matrix[0][0].length - filter[0][0][0].length + stride_x) / stride_x); j++) {
                  var answer = 0;
                  var text = "";
                  for (var ii = 0; ii &lt; filter[0][0].length; ii++) {
                      for (var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                          for (var z = 0; z &lt; matrix.length; z++) {
                              answer += matrix[z][i * stride_y + ii][j * stride_x + jj] * filter[zz][z][ii][jj];
                              text +=matrix[z][i * stride_y + ii][j * stride_x + jj] + "*" + filter[zz][z][ii][jj]+"+";
                          }
                      }
                  }
                  console.log(i, j, text, "=", answer)
                  res[res.length - 1].push(answer.toFixed(1))
              }
          }
          ress.push(res)
      }
      return ress;
  }
  function pool(matrix, filter, func) {
      var res = [];
      for (var i = 0; i &lt; parseInt((matrix.length - filter.length + stride_y) / stride_y); i++) {
          res.push([]);
          for (var j = 0; j &lt; parseInt((matrix[0].length - filter[0].length + stride_x) / stride_x); j++) {
              var answer = [];
              for(var ii = 0; ii &lt; filter.length; ii++) {
                  for(var jj = 0; jj &lt; filter[0].length; jj++) {
                      answer.push(matrix[i* stride_y + ii][j* stride_x + jj]);
                  }
              }
              if(func == "max")
                  res[res.length-1].push(Math.max(...answer))
              else {
                  var sum = 0;
                  for( var ii = 0; ii &lt; answer.length; ii++)
                      sum += answer[ii]; //don't forget to add the base
                  var avg = sum/answer.length;
                  res[res.length-1].push(parseFloat(avg.toFixed(1)));
              }

          }
      }
      return res;
  }

  class Matrix {
      constructor(x, y, matrix, title) {
          this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`);
          for(var z = 0; z &lt; matrix.length; z++) {
              var gg = this.g.append("g").attr("class", "matrix_layer").attr("transform", `translate(${- z*box_z}, ${+ z*box_z})`);
              for (var j = 0; j &lt; matrix[0].length; j++) {
                  for (var i = 0; i &lt; matrix[0][0].length; i++) {
                      var element = gg.append("g").attr("class", "cell").attr("transform", `translate(${i * box_s}, ${j * box_s})`);
                      var rect = element.append("rect")
                          .attr("class", "number")
                          .attr("x", -box_s / 2 + "px")
                          .attr("y", -box_s / 2 + "px")
                          .attr("width", box_s + "px")
                          .attr("height", box_s + "px")
                      if (i &lt; matrix.paddingx || j &lt; matrix.paddingy || i &gt; matrix[0][0].length - matrix.paddingx - 1 || j &gt; matrix[0].length - matrix.paddingy - 1)
                          element.attr("class", "cell padding")
                      element.append("text").text(matrix[z][j][i]).attr("text-anchor", "middle").attr("alignment-baseline", "center").attr("dy", "0.3em")
                  }
              }
              gg.append("rect").attr("class", "highlight3")
              gg.append("rect").attr("class", "highlight1")
              gg.append("rect").attr("class", "highlight2")
          }
          //&lt;line x1="0" y1="50" x2="250" y2="50" stroke="#000" stroke-width="8" marker-end="url(#arrowhead)" /&gt;
          this.arrow = gg.append("line").attr("transform", `translate(${(-0.5)*box_s}, ${(-0.5+filter.length/2)*box_s})`).attr("marker-end", "url(#arrowhead)").attr("x1", 0).attr("y1", 0).attr("x2", 50).attr("y2", 0)
              .attr("stroke", "#000").attr("stroke-width", 8).attr("stroke", "rgb(236, 58, 58)").style("opacity", 0)


          gg.append("text").attr("class", "title").text(title)
              .attr("x", (matrix[0][0].length/2-0.5)*box_s+"px")
              .attr("y", (matrix[0].length)*box_s+"px")
              .attr("dy", "0em")
          this.highlight2_hidden = true
      }

      setHighlight1(i, j, w, h) {
          if(this.old_i == i &amp;&amp; this.old_j == j &amp;&amp; this.old_w == w)
              return
          if(i == this.old_i+stride_x || j == this.old_j+stride_y) {
              if (this.old_j == j)
                  this.arrow.attr("x1", this.old_i * box_s).attr("y1", j * box_s)
                      .attr("x2", i * box_s - 30).attr("y2", j * box_s).attr("transform", `translate(${(-0.5) * box_s}, ${(-0.5 + h / 2) * box_s})`)
              else
                  this.arrow.attr("x1", i * box_s).attr("y1", this.old_j * box_s)
                      .attr("x2", i * box_s).attr("y2", j * box_s - 30).attr("transform", `translate(${(-0.5 + w / 2) * box_s}, ${(-0.5) * box_s})`)
              this.arrow.transition().style("opacity", 1)
                  .transition()
                  .duration(1000)
                  .style("opacity", 0)
          }
          this.old_i = i; this.old_j = j; this.old_w = w;
          this.g.selectAll(".highlight1")
              .style("fill", "rgba(236, 58, 58, 0)")
              .transition()
              .duration(1000)
              .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
              .attr("width", box_s*w+"px")
              .attr("height", box_s*h+"px")
              .style("fill", "rgba(236, 58, 58, 0.25)")
          this.g.selectAll(".highlight3")
              .style("opacity", 1)
              .transition()
              .duration(1000)
              .style("opacity", 0)
          this.g.selectAll(".highlight3")
              .transition()
              .delay(900)
              .duration(0)
              .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
              .attr("width", box_s*w+"px")
              .attr("height", box_s*h+"px")
  //            .style("opacity", 1)
      }

      setHighlight2(i, j, w, h) {
          if(this.highlight2_hidden == true) {
              this.g.selectAll(".highlight2")
              .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
              .attr("width", box_s*w+"px")
              .attr("height", box_s*h+"px")
              .transition()
              .duration(1000)
              .style("opacity", 1)
              this.highlight2_hidden = false
              return
          }
          this.g.selectAll(".highlight2")
              .transition()
              .duration(1000)
              .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
              .attr("width", box_s*w+"px")
              .attr("height", box_s*h+"px");
      }
      hideHighlight2() {
          this.highlight2_hidden = true
          this.g.selectAll(".highlight2")
              .transition()
              .duration(1000)
              .style("opacity", 0)
      }
      //m.g.selectAll(".cell text").style("opacity", (d, i)=&gt;{console.log(i&gt;4); return 1*(i&gt;5)})
  }

  class Calculation {
      constructor(x, y, matrix, title) {
          this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
          this.g.append("text").text(title).attr("dy", "-1.5em").attr("dx", "2em")
          this.g = this.g.append("text")
          for (var j in matrix) {
              for (var i in matrix[j]) {
                  var element = this.g;
                  var a = element.append("tspan")
                      .text(i+"·"+j)
                  if(i == 0 &amp;&amp; j &gt; 0)
                      a.attr("dy", "1.5em").attr("x", 0)
                  if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                      a = element.append("tspan")
                      .attr("dy", "1.5em").attr("x", 0)
                      .text(" = 12 ")
                  }
                  else {
                      a = element.append("tspan")
                          .text(" + ")
                  }
              }
          }
      }
      setText(i, text) {
          d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
      }
      hideAll() {
          this.g.selectAll("tspan")
              .attr("fill", "white")
      }
      setHighlight1(i) {
          this.g.selectAll("tspan")
              .transition()
              .duration(1000)
              .attr("fill",
              (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

      }
  }

  class CalculationPool {
      constructor(x, y, matrix, title) {
          this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
          this.g.append("text").text(title).attr("dy", "-3em").attr("dx", "-2em")
          this.g.append("text").text(group_func+"([").attr("dy", "-1.5em").attr("dx", "-0.5em")
          this.g = this.g.append("text")
          for (var j in matrix) {
              for (var i in matrix[j]) {
                  var element = this.g;
                  var a = element.append("tspan")
                      .text("")
                  if(i == 0 &amp;&amp; j &gt; 0)
                      a.attr("dy", "1.5em").attr("x", 0)
                  if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                      a = element.append("tspan")
                      .attr("dy", "1.5em").attr("x", 0).attr("dx", "-0.5em")
                      .text("")
                  }
                  else {
                      a = element.append("tspan")
                          .text("")
                  }
              }
          }
      }
      setText(i, text) {
          d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
      }
      hideAll() {
          this.g.selectAll("tspan")
              .attr("fill", "white")
      }
      setHighlight1(i) {
          this.g.selectAll("tspan")
              .transition()
              .duration(1000)
              .attr("fill",
              (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

      }
  }

  var matrix, res, m, f, r, c, last_pos, index_max;
  function init() {
      show_single_elements = dom_target.querySelector(".play_fast").checked == false
      /*
      tuple_or_single = (x, y) =&gt; x == y ? x : `(${x}, ${y})`
      if(group_func == "max")
          dom_target.querySelector(".torch_name").innerText = `torch.nn.MaxPool2d(kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
      else if(group_func == "mean")
              dom_target.querySelector(".torch_name").innerHTML = `torch.nn.AvgPool2d(x=&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;, kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
      else
          dom_target.querySelector(".torch_name").innerText = `torch.nn.Conv2d(in_channels=1, out_channels=1,  kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`

      if(window.hljs != undefined)
          hljs.highlightElement(dom_target.querySelector(".torch_name"))
      */
      svg.selectAll("*").remove();

      dom_target.querySelector(".input_matrixzB").value = dom_target.querySelector(".input_matrixz").value

      console.log("dom_target", dom_target)
      console.log("dom_target.querySelector(\".input_filterx\").value)", dom_target.querySelector(".input_filterx").value)
      filter = generateMatrix2(numberGenerator(17, 0.9, 1), [parseInt(dom_target.querySelector(".input_filterz").value), parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_filtery").value), parseInt(dom_target.querySelector(".input_filterx").value)]);
      if(dom_target.querySelector(".input_filterx").value == dom_target.querySelector(".input_filtery").value)
          dom_target.querySelector(".input_filterx").parentElement.className = "pair"
      else
          dom_target.querySelector(".input_filterx").parentElement.className = "pairX"
      matrix_raw = generateMatrix2(numberGenerator(4, 9, 0), [parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_matrixy").value), parseInt(dom_target.querySelector(".input_matrixx").value)]);

      matrix = JSON.parse(JSON.stringify(matrix_raw));
      for(var z = 0; z &lt; matrix.length; z++)
          matrix[z] = addPadding(matrix_raw[z], parseInt(dom_target.querySelector(".input_paddingx").value), parseInt(dom_target.querySelector(".input_paddingy").value));
      matrix.paddingx = matrix[0].paddingx
      matrix.paddingy = matrix[0].paddingy
      stride_x = parseInt(dom_target.querySelector(".input_stridex").value)
      stride_y = parseInt(dom_target.querySelector(".input_stridey").value)

      if(dom_target.querySelector(".input_stridex").value == dom_target.querySelector(".input_stridey").value)
          dom_target.querySelector(".input_stridex").parentElement.className = "pair"
      else
          dom_target.querySelector(".input_stridex").parentElement.className = "pairX"
          if(dom_target.querySelector(".input_paddingx").value == dom_target.querySelector(".input_paddingy").value)
          dom_target.querySelector(".input_paddingx").parentElement.className = "pair"
      else
          dom_target.querySelector(".input_paddingx").parentElement.className = "pairX"

      res = convolve(matrix, filter);
          window.matrix = matrix
          window.filter = filter
          window.res = res
      if(group_func != undefined)
          res = [pool(matrix[0], filter[0][0], group_func)]

      m = new Matrix(1*box_s, (1+filter[0][0].length+1.5)*box_s, matrix, "Matrix");

      f = []
      for(var zz = 0; zz &lt; filter.length; zz++)
          f.push(new Matrix((1+(matrix[0][0].length-filter[zz][0][0].length)/2 + zz*(1+filter[zz][0][0].length))*box_s, 1*box_s, filter[zz], group_func == undefined ? (filter.length != 1? `Filter ${zz}` : `Filter`) : "Pooling"));
      if(group_func != undefined)
          f[0].g.selectAll(".cell text").attr("fill", "white")

      console.log("res", res)
      r = new Matrix((2+(matrix[0][0].length)+1)*box_s, (1+filter[0][0].length+1.5)*box_s, res, "Result");

      var c_x = Math.max((1+(matrix[0][0].length))*box_s, (3+filter.length*(1+(filter[0][0].length)))*box_s)
      console.log("m,ax", (1+(matrix[0][0].length)), filter.length*(1+(filter[0][0].length)))
      if(group_func != undefined)
          c = new CalculationPool(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");
      else
          c = new Calculation(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");

      last_pos = undefined;
      if(show_single_elements)
          index_max = filter.length*res[0].length*res[0][0].length*(filter[0][0].length * filter[0][0][0].length + 2)
      else
          index_max = filter.length*res[0].length*res[0][0].length
      window.index_max = index_max
      window.filter = filter
      setHighlights(0, 0)
      svg.attr("width", box_s*(matrix[0][0].length+res[0][0].length+4)+(c.g.node().getBoundingClientRect().width)+"px");
      svg.attr("height", box_s*(matrix[0].length+filter[0][0].length+3.0)+"px");
  }
  init()

  function setHighlights(pos_zz, subpos) {
      var [zz, pos] = divmod(pos_zz, res[0].length*res[0][0].length)
      var [i, j] = divmod(pos, res[0][0].length)
      i *= stride_y;
      j *= stride_x;
      var [j2, i2] = divmod(subpos, filter[0][0][0].length)
      if(last_pos != pos) {
          var answer = 0;
          for(var ii = 0; ii &lt; filter[0][0].length; ii++) {
              for(var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                  var text = []
                  if(filter[0].length == 1) {
                      for(var z = 0; z &lt; filter[0].length; z++) {
                          if (group_func != undefined)
                              text.push(matrix[0][i + ii][j + jj] + ", ");
                          else
                              text.push(matrix[z][i + ii][j + jj] + " · " + filter[zz][z][ii][jj]);
                      }
                      if (group_func != undefined)
                          c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                      else
                          c.setText(ii * filter[0][0][0].length + jj, text.join("+"));
                  }
                  else {
                      for (var z = 0; z &lt; filter[0].length; z++) {
                          if (group_func != undefined)
                              text.push(matrix[0][i + ii][j + jj] + ", ");
                          else
                              text.push(matrix[z][i + ii][j + jj] + "·" + filter[zz][z][ii][jj]);
                      }
                      if (group_func != undefined)
                          c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                      else
                          c.setText(ii * filter[0][0][0].length + jj, "(" + text.join("+") + ")");
                  }
              }
          }
          if(group_func != undefined)
              c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   ]) = "+res[zz][i/stride_y][j/stride_x])
          else
              c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   = "+res[zz][i/stride_y][j/stride_x])
          c.hideAll();
          last_pos = pos;
      }
      m.setHighlight1(j, i, filter[0][0][0].length, filter[0][0].length)
      for(var zzz = 0; zzz &lt; filter.length; zzz++) {
          console.log(zzz, zz, zzz == zz)
          if (zzz == zz)
              f[zzz].setHighlight1(0, 0, filter[0][0][0].length, filter[0][0].length)
          else
              f[zzz].setHighlight1(0, 0, 0, 0)
      }
      window.f = f

      r.setHighlight1(j/stride_x, i/stride_y, 1, 1)
      r.g.selectAll(".matrix_layer").attr("opacity", (d,i) =&gt; i &gt; zz ? 0.2 : 1 )
      r.g.selectAll(".matrix_layer .highlight1").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
      r.g.selectAll(".matrix_layer .highlight3").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
      window.r = r

      if(subpos &lt; filter[0][0].length * filter[0][0][0].length) {
          m.setHighlight2(j + i2, i + j2, 1, 1)
          if(group_func == undefined)
              for(var zzz = 0; zzz &lt; filter.length; zzz++) {
                  if (zzz == zz)
                      f[zzz].setHighlight2(i2, j2, 1, 1)
                  else
                      f[zzz].hideHighlight2()
              }
          r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt;= pos_zz ? "white" : "black")
          c.setHighlight1(subpos);
      }
      else {
          m.hideHighlight2()
          for(var zzz = 0; zzz &lt; filter.length; zzz++)
              f[zzz].hideHighlight2()
          r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt; pos_zz ? "white" : "black")
          if(subpos &gt; filter[0][0].length * filter[0][0][0].length) {
              c.hideAll()
          }
          else
              c.setHighlight1(subpos);
      }

      function p(x) { console.log(x); return x}
  }
  function animate(frame) {
      dom_target.querySelector("input[type=range]").value = index;
      dom_target.querySelector("input[type=range]").max = index_max - 1;
      dom_target.querySelector("input[type=range]").min = 0;
      if(show_single_elements) {
          var [pos, subpos] = divmod(frame, filter[0][0].length * filter[0][0][0].length + 2)
          setHighlights(pos, subpos);
      }
      else
          setHighlights(frame, filter[0][0].length * filter[0][0][0].length);
  }
  var index = -1
  animate(0)
  var interval = undefined;

  function PlayStep() {
      index += 1;
      if(index &gt;= index_max)
          index = 0;
      animate(index);
  }

  function playPause() {
      if(interval === undefined) {
          dom_target.querySelector(".play").style.display = "none"
          dom_target.querySelector(".pause").style.display = "inline-block"
          interval = window.setInterval(PlayStep, 1000);
          PlayStep();
      }
      else {
          dom_target.querySelector(".play").style.display = "inline-block"
          dom_target.querySelector(".pause").style.display = "none"
          window.clearInterval(interval);
          interval = undefined;
      }
  }
  dom_target.querySelector("input[type=range]").value = 0;
  dom_target.querySelector("input[type=range]").max = index_max;
  dom_target.querySelector("input[type=range]").onchange = (i)=&gt;{var v = parseInt(i.target.value); index = v; animate(v);};
  dom_target.querySelector(".play").onclick = playPause;
  dom_target.querySelector(".pause").onclick = playPause;
  dom_target.querySelector(".left").onclick = ()=&gt;{index &gt; 0 ? index -= 1 : index = index_max-1; animate(index);};
  dom_target.querySelector(".right").onclick = ()=&gt;{index &lt; index_max-1 ? index += 1 : index = 0; animate(index);};

  dom_target.querySelector(".input_filterx").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_filtery").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_filterz").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_matrixx").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_matrixy").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_matrixz").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_matrixzB").onchange = (i)=&gt;{dom_target.querySelector(".input_matrixz").value = parseInt(i.target.value); init();};
  dom_target.querySelector(".input_paddingx").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_paddingy").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_stridex").onchange = ()=&gt;{init()}
  dom_target.querySelector(".input_stridey").onchange = ()=&gt;{init()}
  dom_target.querySelector(".play_fast").onchange = ()=&gt;{init()}
      &lt;!--
  dom_target.querySelector(".select_maxpool").onclick = ()=&gt;{group_func="max"; dom_target.querySelector(".dropbtn").innerText = "MaxPool2d"; init()}
  dom_target.querySelector(".select_avgpool").onclick = ()=&gt;{group_func="avg"; dom_target.querySelector(".dropbtn").innerText = "AvgPool2d"; init()}
  --&gt;
  })();
&lt;/script&gt;
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">  File</span><span class="nn"> "/tmp/ipykernel_7642/1963347081.py"</span><span class="gt">, line </span><span class="mi">5</span>
    <span class="o">&lt;</span><span class="n">style</span><span class="o">&gt;</span>
    <span class="o">^</span>
<span class="ne">SyntaxError</span>: invalid syntax
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="think-2-2-1-edge-detection">
<h3>Think! 2.2.1: Edge Detection<a class="headerlink" href="#think-2-2-1-edge-detection" title="Permalink to this headline">¶</a></h3>
<p>One of the simpler tasks performed by a convolutional layer is edge detection; that is, finding a place in the image where there is a large and abrupt change in color. Edge-detecting filters are usually learned by the first layers in a CNN. Observe the following simple kernel and discuss whether this will detect vertical edges (where the trace of the edge is vertical; i.e. there is a boundary between left and right), or whether it will detect horizontal edges (where the trace of the edge is horizontal; i.e., there is a boundary between top and bottom).</p>
<div class="amsmath math notranslate nohighlight" id="equation-6146d730-1882-4973-ad1a-57c302c6477b">
<span class="eqno">(56)<a class="headerlink" href="#equation-6146d730-1882-4973-ad1a-57c302c6477b" title="Permalink to this equation">¶</a></span>\[\begin{equation}
\textbf{Kernel} = 
\begin{bmatrix} 1 &amp; -1 \\ 1 &amp; -1
\end{bmatrix} 
\end{equation}\]</div>
<div class="section" id="id2">
<h4>Student Response<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Student Response</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>


<span class="n">text</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
   <span class="n">value</span><span class="o">=</span><span class="s1">'Type your answer here and click on `Submit!`'</span><span class="p">,</span>
   <span class="n">placeholder</span><span class="o">=</span><span class="s1">'Type something'</span><span class="p">,</span>
   <span class="n">description</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
   <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Submit!"</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">button</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_button_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
   <span class="n">atform</span><span class="o">.</span><span class="n">add_answer</span><span class="p">(</span><span class="s1">'q3'</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">"Submission successful!"</span><span class="p">)</span>


<span class="n">button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_button_clicked</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "60a76b2d83be4d6fa93b00ca7395463d"}
</script><script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "e3d9453b01014285be23b6cab47af90e"}
</script></div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_309474b2.py"><em>Click for solution</em></a></p>
<p>Consider the image below, which has a black vertical stripe with white on the side. This is like a very zoomed-in vertical edge within an image!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare an image that's basically just a vertical black stripe</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'gray'</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1. 1. 0. 0. 0. 0. 1. 1.]
 [1. 1. 0. 0. 0. 0. 1. 1.]
 [1. 1. 0. 0. 0. 0. 1. 1.]
 [1. 1. 0. 0. 0. 0. 1. 1.]
 [1. 1. 0. 0. 0. 0. 1. 1.]
 [1. 1. 0. 0. 0. 0. 1. 1.]]
</pre></div>
</div>
<img alt="../../../_images/W2D1_Tutorial1_80_1.png" src="../../../_images/W2D1_Tutorial1_80_1.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Format the image that's basically just a vertical stripe</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c1"># BatchSize X Channels X Height X Width</span>

<span class="c1"># Prepare a 2x2 kernel with 1s in the first column and -1s in the</span>
<span class="c1"># This exact kernel was discussed above!</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]])</span>
<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>

<span class="c1"># Apply the kernel to the image and prepare for display</span>
<span class="n">processed_image</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
<span class="n">processed_image</span> <span class="o">=</span> <span class="n">processed_image</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">processed_image</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">processed_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'gray'</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 0.  2.  0.  0.  0. -2.  0.]
 [ 0.  2.  0.  0.  0. -2.  0.]
 [ 0.  2.  0.  0.  0. -2.  0.]
 [ 0.  2.  0.  0.  0. -2.  0.]
 [ 0.  2.  0.  0.  0. -2.  0.]]
</pre></div>
</div>
<img alt="../../../_images/W2D1_Tutorial1_81_1.png" src="../../../_images/W2D1_Tutorial1_81_1.png"/>
</div>
</div>
<p>As you can see, this kernel detects vertical edges (the black stripe corresponds to a highly positive result, while the white stripe corresponds to a highly negative result. However, to display the image, all the pixels are normalized between 0=black and 1=white).</p>
</div>
</div>
<div class="section" id="think-2-2-2-kernel-structure">
<h3>Think! 2.2.2 Kernel structure<a class="headerlink" href="#think-2-2-2-kernel-structure" title="Permalink to this headline">¶</a></h3>
<p>If the kernel were transposed (i.e., the columns become rows and the rows become columns), what would the kernel detect? What would be produced by running this kernel on the vertical edge image above?</p>
<div class="section" id="id3">
<h4>Student Response<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Student Response</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>


<span class="n">text</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
   <span class="n">value</span><span class="o">=</span><span class="s1">'Type your answer here and click on `Submit!`'</span><span class="p">,</span>
   <span class="n">placeholder</span><span class="o">=</span><span class="s1">'Type something'</span><span class="p">,</span>
   <span class="n">description</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
   <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Submit!"</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">button</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_button_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
   <span class="n">atform</span><span class="o">.</span><span class="n">add_answer</span><span class="p">(</span><span class="s1">'q4'</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">"Submission successful!"</span><span class="p">)</span>


<span class="n">button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_button_clicked</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "1fff1b98f589469381ec2fbe40ae6487"}
</script><script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "dce1ac53131b4444b9e81cc85384a425"}
</script></div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_7cc3340b.py"><em>Click for solution</em></a></p>
</div>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-3-pooling-and-subsampling">
<h1>Section 3: Pooling and Subsampling<a class="headerlink" href="#section-3-pooling-and-subsampling" title="Permalink to this headline">¶</a></h1>
<div class="section" id="video-4-pooling">
<h2>Video 4: Pooling<a class="headerlink" href="#video-4-pooling" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "82070cf34d1748ababbed36d84eb049b"}
</script></div>
</div>
<p>To visualize the various components of a CNN, we will build a simple CNN step by step. Recall that the MNIST dataset consists of binarized images of handwritten digits. This time we will be using the EMNIST letters dataset, which consists of binarized images of handwritten characters <span class="math notranslate nohighlight">\((A, ..., Z)\)</span>.</p>
<p>We will simplify the problem further by only keeping the images that correspond to <span class="math notranslate nohighlight">\(X\)</span> (labeled as <code class="docutils literal notranslate"><span class="pre">24</span></code> in the dataset) and <span class="math notranslate nohighlight">\(O\)</span> (labeled as <code class="docutils literal notranslate"><span class="pre">15</span></code> in the dataset). Then, we will train a CNN to classify an image either an <span class="math notranslate nohighlight">\(X\)</span> or an <span class="math notranslate nohighlight">\(O\)</span>.</p>
<div class="section" id="dataset-dataloader-functions-run-me">
<h3>Dataset/DataLoader Functions (run me)<a class="headerlink" href="#dataset-dataloader-functions-run-me" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown ### Dataset/DataLoader Functions (run me)</span>

<span class="c1"># loading the dataset</span>
<span class="k">def</span> <span class="nf">get_Xvs0_dataset</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))</span>
        <span class="p">])</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="p">])</span>

  <span class="n">emnist_train</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">EMNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span>
                                 <span class="n">split</span><span class="o">=</span><span class="s1">'letters'</span><span class="p">,</span>
                                 <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
  <span class="n">emnist_test</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">EMNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span>
                                <span class="n">split</span><span class="o">=</span><span class="s1">'letters'</span><span class="p">,</span>
                                <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

  <span class="c1"># only want O (15) and X (24) labels</span>
  <span class="n">train_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">emnist_train</span><span class="o">.</span><span class="n">targets</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">emnist_train</span><span class="o">.</span><span class="n">targets</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
  <span class="n">emnist_train</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>
  <span class="n">emnist_train</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span>

  <span class="c1"># convert Xs predictions to 1, Os predictions to 0</span>
  <span class="n">emnist_train</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">(</span><span class="n">emnist_train</span><span class="o">.</span><span class="n">targets</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

  <span class="n">test_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">emnist_test</span><span class="o">.</span><span class="n">targets</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">emnist_test</span><span class="o">.</span><span class="n">targets</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
  <span class="n">emnist_test</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">emnist_test</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>
  <span class="n">emnist_test</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">emnist_test</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span>

  <span class="c1"># convert Xs predictions to 1, Os predictions to 0</span>
  <span class="n">emnist_test</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">(</span><span class="n">emnist_test</span><span class="o">.</span><span class="n">targets</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">emnist_train</span><span class="p">,</span> <span class="n">emnist_test</span>



<span class="k">def</span> <span class="nf">get_data_loaders</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

  <span class="n">g_seed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span>
  <span class="n">g_seed</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

  <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">worker_init_fn</span><span class="o">=</span><span class="n">seed_worker</span><span class="p">,</span>
                        <span class="n">generator</span><span class="o">=</span><span class="n">g_seed</span><span class="p">)</span>
  <span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">worker_init_fn</span><span class="o">=</span><span class="n">seed_worker</span><span class="p">,</span>
                        <span class="n">generator</span><span class="o">=</span><span class="n">g_seed</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">emnist_train</span><span class="p">,</span> <span class="n">emnist_test</span> <span class="o">=</span> <span class="n">get_Xvs0_dataset</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">get_data_loaders</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">,</span> <span class="n">emnist_test</span><span class="p">,</span>
                                             <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>

<span class="c1"># index of an image in the dataset that corresponds to an X and O</span>
<span class="n">x_img_idx</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">o_img_idx</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading https://www.itl.nist.gov/iaui/vip/cs_links/EMNIST/gzip.zip to ./data/EMNIST/raw/gzip.zip
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "52abe8b2708847bd84bb68bef9951f05"}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Extracting ./data/EMNIST/raw/gzip.zip to ./data/EMNIST/raw
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_7642</span><span class="o">/</span><span class="mf">4125148237.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">emnist_train</span><span class="p">,</span> <span class="n">emnist_test</span> <span class="o">=</span> <span class="n">get_Xvs0_dataset</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">get_data_loaders</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">,</span> <span class="n">emnist_test</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                                              <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># index of an image in the dataset that corresponds to an X and O</span>

<span class="nn">/tmp/ipykernel_7642/375273804.py</span> in <span class="ni">get_Xvs0_dataset</span><span class="nt">(normalize)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>                                  <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span>                                  <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="ne">---&gt; </span><span class="mi">19</span>                                  <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>   <span class="n">emnist_test</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">EMNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">'./data'</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>                                 <span class="n">split</span><span class="o">=</span><span class="s1">'letters'</span><span class="p">,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.11/x64/lib/python3.7/site-packages/torchvision/datasets/mnist.py</span> in <span class="ni">__init__</span><span class="nt">(self, root, split, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span>         <span class="bp">self</span><span class="o">.</span><span class="n">training_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_file</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">292</span>         <span class="bp">self</span><span class="o">.</span><span class="n">test_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_file</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">293</span>         <span class="nb">super</span><span class="p">(</span><span class="n">EMNIST</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">294</span>         <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes_split_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.11/x64/lib/python3.7/site-packages/torchvision/datasets/mnist.py</span> in <span class="ni">__init__</span><span class="nt">(self, root, train, transform, target_transform, download)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span> 
<span class="g g-Whitespace">     </span><span class="mi">86</span>         <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">87</span>             <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">88</span> 
<span class="g g-Whitespace">     </span><span class="mi">89</span>         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_exists</span><span class="p">():</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.11/x64/lib/python3.7/site-packages/torchvision/datasets/mnist.py</span> in <span class="ni">download</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>         <span class="k">for</span> <span class="n">gzip_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">gzip_folder</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">333</span>             <span class="k">if</span> <span class="n">gzip_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.gz'</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">334</span>                 <span class="n">extract_archive</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gzip_folder</span><span class="p">,</span> <span class="n">gzip_file</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">335</span>         <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gzip_folder</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">336</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.11/x64/lib/python3.7/site-packages/torchvision/datasets/utils.py</span> in <span class="ni">extract_archive</span><span class="nt">(from_path, to_path, remove_finished)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span>             <span class="n">from_path</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">387</span>             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">from_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="s2">""</span><span class="p">)),</span>
<span class="ne">--&gt; </span><span class="mi">388</span>             <span class="n">remove_finished</span><span class="o">=</span><span class="n">remove_finished</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.11/x64/lib/python3.7/site-packages/torchvision/datasets/utils.py</span> in <span class="ni">_decompress</span><span class="nt">(from_path, to_path, remove_finished)</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span> 
<span class="g g-Whitespace">    </span><span class="mi">356</span>     <span class="k">with</span> <span class="n">compressed_file_opener</span><span class="p">(</span><span class="n">from_path</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">rfh</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">to_path</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">wfh</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">357</span>         <span class="n">wfh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rfh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span> 
<span class="g g-Whitespace">    </span><span class="mi">359</span>     <span class="k">if</span> <span class="n">remove_finished</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>Let’s view a couple samples from the dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># @markdown ### Visualization of Convolution with Multiple Filters

# @markdown Change the number of input channels (e.g., the color channels of an image or the output channels of a previous layer) and the output channels (number of different filters to apply).

%%html

&lt;style&gt;
    svg {
        #border: 1px solid black;
    }
.matrix {
    font-family: sans-serif;
    transition: all 700ms ease-in-out;
}
.cell rect {
    fill:white;stroke-width:1;stroke:rgb(0,0,0)
}
.padding rect {
    stroke: rgba(0, 0, 0, 0.25);
}
.padding text {
    fill: lightgray;
}
.highlight1 {
    fill:none;stroke-width:4;stroke: rgb(236, 58, 58);stroke-dasharray:10,5;
}
.highlight2 {
    fill:rgba(229, 132, 66, 0.25);stroke-width:5;stroke: rgb(229, 132, 66);
}
.highlight3 {
    fill:rgba(236, 58, 58, 0.25);stroke-width:2;stroke: rgb(236, 58, 58);;
}
.title {
    text-anchor: middle;
}
.button_play {
    display: inline-block;
    background: none;
    border: none;
    position: relative;
    top: -3px;
}
.button_play path {
    fill: darkgray;
}
.button_play:hover path {
    fill: rgb(236, 58, 58);
}
.display_vis_input input:not(:hover)::-webkit-outer-spin-button,
.display_vis_input input:not(:hover)::-webkit-inner-spin-button {
    /* display: none; &lt;- Crashes Chrome on hover */
    -webkit-appearance: none;
    margin: 0; /* &lt;-- Apparently some margin are still there even though it's hidden */
}

.display_vis_input input:not(:hover)[type=number] {
    -moz-appearance:textfield; /* Firefox */
    width: 1ch;
    margin-right: 0px;
    z-index: 0;
}
.display_vis_input input[type=number] {
    width: 4ch;
    border: 0px;
    margin-right: -3ch;
    z-index: 6;
    display: inline-block;
    position: relative;
    padding: 0;
    border-bottom: 2px solid red;
    background: white;
    color: black
}
.display_vis_input .pair {
    display: inline-block;
    white-space:nowrap;
        position: relative;
}
.display_vis_input .pair .pair_hide {
    max-width: 4em;
    transition: max-width 1s ease-in;
    display: inline-block;
    overflow: hidden;
    position: relative;
    top: 5px;
}
.pair:not(:hover) .pair_hide {
    max-width: 0;
}
.pairX .pair_hide {
    max-width: 4em;
    transition: max-width 1s ease-in;
}

/* Dropdown Button */
.dropbtn {
  border-bottom: 2px solid red;
}

/* The container &lt;div&gt; - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 5px 2px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd;}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {display: block;}

&lt;/style&gt;
&lt;script src="https://d3js.org/d3.v3.min.js" charset="utf-8" &gt; &lt;/script&gt;


&lt;div id="animation_conv_filters" style="background: white"&gt;
    &lt;div class="display_vis_input language-python" style="font-family: monospace; color: black; padding: 10px;"&gt;
        &lt;!-- default -- &gt;
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, 1&lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="3"&gt;))&lt;br&gt;
        conv = torch.nn.Conv2d(in_channels=1&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;, out_channels=1&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;,
        kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=1&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="hidden" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="hidden" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=0&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="hidden" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="hidden" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)
        --&gt;
        &lt;!-- padding
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, 1&lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;))&lt;br&gt;
        conv = torch.nn.Conv2d(in_channels=1&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;, out_channels=1&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;,
        kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="3"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)
--&gt;
    &lt;!-- filters --&gt;
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, &lt;input class="input_matrixz" type="number" min="1" max="3" value="3"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;)&lt;br&gt;
        conv = torch.nn.Conv2d(in_channels=&lt;input class="input_matrixzB" type="number" min="1" max="3" value="3"&gt;, out_channels=&lt;input class="input_filterz" type="number" min="1" max="3" value="2"&gt;,
        kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)

 &lt;!--
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, &lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;1, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;))&lt;br&gt;
        conv = torch.nn.&lt;div class="dropdown"&gt;
  &lt;div class="dropbtn"&gt;MaxPool2d&lt;/div&gt;
  &lt;div class="dropdown-content"&gt;
    &lt;a class="select_maxpool" href="#"&gt;MaxPool2d&lt;/a&gt;
    &lt;a class="select_avgpool" href="#"&gt;AvgPool2d&lt;/a&gt;
  &lt;/div&gt;
&lt;/div&gt;(&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)
--&gt;
    &lt;/div&gt;
        &lt;button class="button_play play"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 1.5,0 9.5,5 1.5,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;button class="button_play pause" style="display: none"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 0,0 4,0 4,10, 0,10 z"/&gt;&lt;path d="M 6,0 10,0 10,10, 6,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;input type="range" min="1" max="100" value="50" class="slider" style="width: 300px; display: inline-block"&gt;
    &lt;button class="button_play left"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,5 4,0 4,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;button class="button_play right"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,0 4,5 0,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;input type="checkbox" class="play_fast"&gt;fast play mode
    &lt;br/&gt;
    &lt;svg height="0" width="0"&gt;
        &lt;defs&gt;
    &lt;marker id="arrowhead" markerWidth="10" markerHeight="7"
    refX="0" refY="1.5" orient="auto" fill="rgb(236, 58, 58)"&gt;
      &lt;polygon points="0 0, 4 1.5, 0 3" /&gt;
    &lt;/marker&gt;
  &lt;/defs&gt;
    &lt;/svg&gt;
    &lt;svg class="image" height="460" width="600"&gt;

    &lt;/svg&gt;
&lt;/div&gt;
&lt;script&gt;
(function() {
var dom_target = document.getElementById("animation_conv_filters")
const divmod = (x, y) =&gt; [Math.floor(x / y), x % y];
var svg = d3.select(dom_target).select(".image")

var box_s = 50;
var box_z = 10;
var show_single_elements = true;
var group_func = undefined;
function mulberry32(a) {
    return function() {
      var t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t &gt;&gt;&gt; 15, t | 1);
      t ^= t + Math.imul(t ^ t &gt;&gt;&gt; 7, t | 61);
      return ((t ^ t &gt;&gt;&gt; 14) &gt;&gt;&gt; 0) / 4294967296;
    }
}

function numberGenerator(seed, max, digits) {
    var random = mulberry32(seed)
    return () =&gt; parseFloat((random() * max).toFixed(digits));
}
window.numberGenerator = numberGenerator
window.mulberry32 = mulberry32
function generateMatrix2(number, dims) {
    var res = [];
    for (var i = 0; i &lt; dims[0]; i++) {
        if(dims.length == 1)
            res.push(number())
        else
            res.push(generateMatrix2(number, dims.slice(1)));
    }
    return res
}
window.generateMatrix2 = generateMatrix2

function addPadding(matrix, paddingx, paddingy) {
    matrix = JSON.parse(JSON.stringify(matrix));
    var ly = matrix.length; var lx = matrix[0].length;
    for (var i = 0; i &lt; ly; i++) {
        for(var p = 0; p &lt; paddingx; p++) {
            matrix[i].splice(0, 0, 0);
            matrix[i].splice(matrix[i].length, 0, 0);
        }
    }
    for(var p = 0; p &lt; paddingy; p++) {
        matrix.splice(0, 0, []);
        matrix.splice(matrix.length, 0, []);
        for (var i = 0; i &lt; lx + paddingx * 2; i++) {
            matrix[0].push(0);
            matrix[matrix.length - 1].push(0);
        }
    }
    matrix.paddingx = paddingx;
    matrix.paddingy = paddingy;
    return matrix;
}

var stride_x = 1;
var stride_y = 1;
function convolve(matrix, filter) {
    var ress = [];
    for(var zz = 0; zz &lt; filter.length; zz++) {
        var res = [];
        for (var i = 0; i &lt; parseInt((matrix[0].length - filter[0][0].length + stride_y) / stride_y); i++) {
            res.push([]);
            for (var j = 0; j &lt; parseInt((matrix[0][0].length - filter[0][0][0].length + stride_x) / stride_x); j++) {
                var answer = 0;
                var text = "";
                for (var ii = 0; ii &lt; filter[0][0].length; ii++) {
                    for (var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                        for (var z = 0; z &lt; matrix.length; z++) {
                            answer += matrix[z][i * stride_y + ii][j * stride_x + jj] * filter[zz][z][ii][jj];
                            text +=matrix[z][i * stride_y + ii][j * stride_x + jj] + "*" + filter[zz][z][ii][jj]+"+";
                        }
                    }
                }
                console.log(i, j, text, "=", answer)
                res[res.length - 1].push(answer.toFixed(1))
            }
        }
        ress.push(res)
    }
    return ress;
}
function pool(matrix, filter, func) {
    var res = [];
    for (var i = 0; i &lt; parseInt((matrix.length - filter.length + stride_y) / stride_y); i++) {
        res.push([]);
        for (var j = 0; j &lt; parseInt((matrix[0].length - filter[0].length + stride_x) / stride_x); j++) {
            var answer = [];
            for(var ii = 0; ii &lt; filter.length; ii++) {
                for(var jj = 0; jj &lt; filter[0].length; jj++) {
                    answer.push(matrix[i* stride_y + ii][j* stride_x + jj]);
                }
            }
            if(func == "max")
                res[res.length-1].push(Math.max(...answer))
            else {
                var sum = 0;
                for( var ii = 0; ii &lt; answer.length; ii++)
                    sum += answer[ii]; //don't forget to add the base
                var avg = sum/answer.length;
                res[res.length-1].push(parseFloat(avg.toFixed(1)));
            }

        }
    }
    return res;
}

class Matrix {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`);
        for(var z = 0; z &lt; matrix.length; z++) {
            var gg = this.g.append("g").attr("class", "matrix_layer").attr("transform", `translate(${- z*box_z}, ${+ z*box_z})`);
            for (var j = 0; j &lt; matrix[0].length; j++) {
                for (var i = 0; i &lt; matrix[0][0].length; i++) {
                    var element = gg.append("g").attr("class", "cell").attr("transform", `translate(${i * box_s}, ${j * box_s})`);
                    var rect = element.append("rect")
                        .attr("class", "number")
                        .attr("x", -box_s / 2 + "px")
                        .attr("y", -box_s / 2 + "px")
                        .attr("width", box_s + "px")
                        .attr("height", box_s + "px")
                    if (i &lt; matrix.paddingx || j &lt; matrix.paddingy || i &gt; matrix[0][0].length - matrix.paddingx - 1 || j &gt; matrix[0].length - matrix.paddingy - 1)
                        element.attr("class", "cell padding")
                    element.append("text").text(matrix[z][j][i]).attr("text-anchor", "middle").attr("alignment-baseline", "center").attr("dy", "0.3em")
                }
            }
            gg.append("rect").attr("class", "highlight3")
            gg.append("rect").attr("class", "highlight1")
            gg.append("rect").attr("class", "highlight2")
        }
        //&lt;line x1="0" y1="50" x2="250" y2="50" stroke="#000" stroke-width="8" marker-end="url(#arrowhead)" /&gt;
        this.arrow = gg.append("line").attr("transform", `translate(${(-0.5)*box_s}, ${(-0.5+filter.length/2)*box_s})`).attr("marker-end", "url(#arrowhead)").attr("x1", 0).attr("y1", 0).attr("x2", 50).attr("y2", 0)
            .attr("stroke", "#000").attr("stroke-width", 8).attr("stroke", "rgb(236, 58, 58)").style("opacity", 0)


        gg.append("text").attr("class", "title").text(title)
            .attr("x", (matrix[0][0].length/2-0.5)*box_s+"px")
            .attr("y", (matrix[0].length)*box_s+"px")
            .attr("dy", "0em")
        this.highlight2_hidden = true
    }

    setHighlight1(i, j, w, h) {
        if(this.old_i == i &amp;&amp; this.old_j == j &amp;&amp; this.old_w == w)
            return
        if(i == this.old_i+stride_x || j == this.old_j+stride_y) {
            if (this.old_j == j)
                this.arrow.attr("x1", this.old_i * box_s).attr("y1", j * box_s)
                    .attr("x2", i * box_s - 30).attr("y2", j * box_s).attr("transform", `translate(${(-0.5) * box_s}, ${(-0.5 + h / 2) * box_s})`)
            else
                this.arrow.attr("x1", i * box_s).attr("y1", this.old_j * box_s)
                    .attr("x2", i * box_s).attr("y2", j * box_s - 30).attr("transform", `translate(${(-0.5 + w / 2) * box_s}, ${(-0.5) * box_s})`)
            this.arrow.transition().style("opacity", 1)
                .transition()
                .duration(1000)
                .style("opacity", 0)
        }
        this.old_i = i; this.old_j = j; this.old_w = w;
        this.g.selectAll(".highlight1")
            .style("fill", "rgba(236, 58, 58, 0)")
            .transition()
            .duration(1000)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
            .style("fill", "rgba(236, 58, 58, 0.25)")
        this.g.selectAll(".highlight3")
            .style("opacity", 1)
            .transition()
            .duration(1000)
            .style("opacity", 0)
        this.g.selectAll(".highlight3")
            .transition()
            .delay(900)
            .duration(0)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
//            .style("opacity", 1)
    }

    setHighlight2(i, j, w, h) {
        if(this.highlight2_hidden == true) {
            this.g.selectAll(".highlight2")
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
            .transition()
            .duration(1000)
            .style("opacity", 1)
            this.highlight2_hidden = false
            return
        }
        this.g.selectAll(".highlight2")
            .transition()
            .duration(1000)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px");
    }
    hideHighlight2() {
        this.highlight2_hidden = true
        this.g.selectAll(".highlight2")
            .transition()
            .duration(1000)
            .style("opacity", 0)
    }
    //m.g.selectAll(".cell text").style("opacity", (d, i)=&gt;{console.log(i&gt;4); return 1*(i&gt;5)})
}

class Calculation {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
        this.g.append("text").text(title).attr("dy", "-1.5em").attr("dx", "2em")
        this.g = this.g.append("text")
        for (var j in matrix) {
            for (var i in matrix[j]) {
                var element = this.g;
                var a = element.append("tspan")
                    .text(i+"·"+j)
                if(i == 0 &amp;&amp; j &gt; 0)
                    a.attr("dy", "1.5em").attr("x", 0)
                if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                    a = element.append("tspan")
                    .attr("dy", "1.5em").attr("x", 0)
                    .text(" = 12 ")
                }
                else {
                    a = element.append("tspan")
                        .text(" + ")
                }
            }
        }
    }
    setText(i, text) {
        d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
    }
    hideAll() {
        this.g.selectAll("tspan")
            .attr("fill", "white")
    }
    setHighlight1(i) {
        this.g.selectAll("tspan")
            .transition()
            .duration(1000)
            .attr("fill",
            (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

    }
}

class CalculationPool {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
        this.g.append("text").text(title).attr("dy", "-3em").attr("dx", "-2em")
        this.g.append("text").text(group_func+"([").attr("dy", "-1.5em").attr("dx", "-0.5em")
        this.g = this.g.append("text")
        for (var j in matrix) {
            for (var i in matrix[j]) {
                var element = this.g;
                var a = element.append("tspan")
                    .text("")
                if(i == 0 &amp;&amp; j &gt; 0)
                    a.attr("dy", "1.5em").attr("x", 0)
                if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                    a = element.append("tspan")
                    .attr("dy", "1.5em").attr("x", 0).attr("dx", "-0.5em")
                    .text("")
                }
                else {
                    a = element.append("tspan")
                        .text("")
                }
            }
        }
    }
    setText(i, text) {
        d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
    }
    hideAll() {
        this.g.selectAll("tspan")
            .attr("fill", "white")
    }
    setHighlight1(i) {
        this.g.selectAll("tspan")
            .transition()
            .duration(1000)
            .attr("fill",
            (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

    }
}

var matrix, res, m, f, r, c, last_pos, index_max;
function init() {
    show_single_elements = dom_target.querySelector(".play_fast").checked == false
    /*
    tuple_or_single = (x, y) =&gt; x == y ? x : `(${x}, ${y})`
    if(group_func == "max")
        dom_target.querySelector(".torch_name").innerText = `torch.nn.MaxPool2d(kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
    else if(group_func == "mean")
            dom_target.querySelector(".torch_name").innerHTML = `torch.nn.AvgPool2d(x=&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;, kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
    else
        dom_target.querySelector(".torch_name").innerText = `torch.nn.Conv2d(in_channels=1, out_channels=1,  kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`

    if(window.hljs != undefined)
        hljs.highlightElement(dom_target.querySelector(".torch_name"))
    */
    svg.selectAll("*").remove();

    dom_target.querySelector(".input_matrixzB").value = dom_target.querySelector(".input_matrixz").value

    console.log("dom_target", dom_target)
    console.log("dom_target.querySelector(\".input_filterx\").value)", dom_target.querySelector(".input_filterx").value)
    filter = generateMatrix2(numberGenerator(17, 0.9, 1), [parseInt(dom_target.querySelector(".input_filterz").value), parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_filtery").value), parseInt(dom_target.querySelector(".input_filterx").value)]);
    if(dom_target.querySelector(".input_filterx").value == dom_target.querySelector(".input_filtery").value)
        dom_target.querySelector(".input_filterx").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_filterx").parentElement.className = "pairX"
    matrix_raw = generateMatrix2(numberGenerator(4, 9, 0), [parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_matrixy").value), parseInt(dom_target.querySelector(".input_matrixx").value)]);

    matrix = JSON.parse(JSON.stringify(matrix_raw));
    for(var z = 0; z &lt; matrix.length; z++)
        matrix[z] = addPadding(matrix_raw[z], parseInt(dom_target.querySelector(".input_paddingx").value), parseInt(dom_target.querySelector(".input_paddingy").value));
    matrix.paddingx = matrix[0].paddingx
    matrix.paddingy = matrix[0].paddingy
    stride_x = parseInt(dom_target.querySelector(".input_stridex").value)
    stride_y = parseInt(dom_target.querySelector(".input_stridey").value)

    if(dom_target.querySelector(".input_stridex").value == dom_target.querySelector(".input_stridey").value)
        dom_target.querySelector(".input_stridex").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_stridex").parentElement.className = "pairX"
        if(dom_target.querySelector(".input_paddingx").value == dom_target.querySelector(".input_paddingy").value)
        dom_target.querySelector(".input_paddingx").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_paddingx").parentElement.className = "pairX"

    res = convolve(matrix, filter);
        window.matrix = matrix
        window.filter = filter
        window.res = res
    if(group_func != undefined)
        res = [pool(matrix[0], filter[0][0], group_func)]

    m = new Matrix(1*box_s, (1+filter[0][0].length+1.5)*box_s, matrix, "Matrix");

    f = []
    for(var zz = 0; zz &lt; filter.length; zz++)
        f.push(new Matrix((1+(matrix[0][0].length-filter[zz][0][0].length)/2 + zz*(1+filter[zz][0][0].length))*box_s, 1*box_s, filter[zz], group_func == undefined ? (filter.length != 1? `Filter ${zz}` : `Filter`) : "Pooling"));
    if(group_func != undefined)
        f[0].g.selectAll(".cell text").attr("fill", "white")

    console.log("res", res)
    r = new Matrix((2+(matrix[0][0].length)+1)*box_s, (1+filter[0][0].length+1.5)*box_s, res, "Result");

    var c_x = Math.max((1+(matrix[0][0].length))*box_s, (3+filter.length*(1+(filter[0][0].length)))*box_s)
    console.log("m,ax", (1+(matrix[0][0].length)), filter.length*(1+(filter[0][0].length)))
    if(group_func != undefined)
        c = new CalculationPool(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");
    else
        c = new Calculation(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");

    last_pos = undefined;
    if(show_single_elements)
        index_max = filter.length*res[0].length*res[0][0].length*(filter[0][0].length * filter[0][0][0].length * filter[0].length + 2)
    else
        index_max = filter.length*res[0].length*res[0][0].length
    window.index_max = index_max
    window.filter = filter
    setHighlights(0, 0)
    svg.attr("width", box_s*(matrix[0][0].length+res[0][0].length+4)+(c.g.node().getBoundingClientRect().width)+"px");
    svg.attr("height", box_s*(matrix[0].length+filter[0][0].length+3.0)+"px");
}
init()

function setHighlights(pos_zz, subpos) {
    var [zz, pos] = divmod(pos_zz, res[0].length*res[0][0].length)
    var [i, j] = divmod(pos, res[0][0].length)
    i *= stride_y;
    j *= stride_x;
    var [j2, i2] = divmod(subpos, filter[0][0][0].length * filter[0].length)
    var [i2, z2] = divmod(i2, filter[0].length)
    subpos = Math.floor(subpos/filter[0].length)
    console.log(zz, i, j, j2, i2, z2)
    if(last_pos != pos || 1) {
        var answer = 0;
        for(var ii = 0; ii &lt; filter[0][0].length; ii++) {
            for(var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                var text = []
                if(filter[0].length == 1) {
                    for(var z = 0; z &lt; filter[0].length; z++) {
                        if (group_func != undefined)
                            text.push(matrix[0][i + ii][j + jj] + ", ");
                        else
                            text.push(matrix[z][i + ii][j + jj] + " · " + filter[zz][z][ii][jj]);
                    }
                    if (group_func != undefined)
                        c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                    else
                        c.setText(ii * filter[0][0][0].length + jj, text.join("+"));
                }
                else {
                    let max_z = (ii == j2 &amp;&amp; jj == i2) ? z2+1 : filter[0].length
                    for (var z = 0; z &lt; max_z; z++) {
                        if (group_func != undefined)
                            text.push(matrix[0][i + ii][j + jj] + ", ");
                        else
                            text.push(matrix[z][i + ii][j + jj] + "·" + filter[zz][z][ii][jj]);
                        console.log(z, z2, text)
                    }
                    console.log("----------")
                    if (group_func != undefined)
                        c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                    else
                        c.setText(ii * filter[0][0][0].length + jj, "(" + text.join("+") + ((filter[0].length==max_z)?")":""));
                }
            }
        }
        if(group_func != undefined)
            c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   ]) = "+res[zz][i/stride_y][j/stride_x])
        else
            c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   = "+res[zz][i/stride_y][j/stride_x])
        if(last_pos != pos)
            c.hideAll();
        last_pos = pos;
    }
    m.setHighlight1(j, i, filter[0][0][0].length, filter[0][0].length)
    for(var zzz = 0; zzz &lt; filter.length; zzz++) {
        console.log(zzz, zz, zzz == zz)
        if (zzz == zz)
            f[zzz].setHighlight1(0, 0, filter[0][0][0].length, filter[0][0].length)
        else
            f[zzz].setHighlight1(0, 0, 0, 0)
    }
    window.f = f

    r.setHighlight1(j/stride_x, i/stride_y, 1, 1)
    r.g.selectAll(".matrix_layer").attr("opacity", (d,i) =&gt; i &gt; zz ? 0.2 : 1 )
    r.g.selectAll(".matrix_layer .highlight1").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
    r.g.selectAll(".matrix_layer .highlight3").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
    window.r = r

    let matrixpos = (i + j2) * matrix[0][0].length + (j + i2)
    m.g.selectAll(".matrix_layer").each(function(p, j){
        console.log(d3.select(this).select("highlight2"))
        d3.select(this).selectAll(".cell").attr("opacity", (d,i) =&gt; (i == matrixpos &amp;&amp; j &gt; z2 &amp;&amp; subpos &lt; filter[0][0].length * filter[0][0][0].length) ? 0 : 1 );
        d3.select(this).select(".highlight2").style("stroke", (d,i) =&gt; (j != z2) ? "transparent" : "rgb(229, 132, 66)");
    })
    f[zz].g.selectAll(".matrix_layer").each(function(p, j){
        console.log(d3.select(this).select("highlight2"), subpos, i2, j2, z2)
        d3.select(this).selectAll(".cell").attr("opacity", (d,i) =&gt; (i == subpos &amp;&amp; j &gt; z2 &amp;&amp; subpos &lt; filter[0][0].length * filter[0][0][0].length) ? 0 : 1 );
        d3.select(this).select(".highlight2").style("stroke", (d,i) =&gt; (j != z2) ? "transparent" : "rgb(229, 132, 66)");
        //d3.select(this).select(".highlight1").style("stroke", (d,i) =&gt; (j == z2) ? "visible" : "hidden");
        //d3.select(this).select(".highlight3").style("stroke", (d,i) =&gt; (j == z2) ? "visible" : "hidden");
    })

    if(subpos &lt; filter[0][0].length * filter[0][0][0].length) {
        m.setHighlight2(j + i2, i + j2, 1, 1)
        if(group_func == undefined)
            for(var zzz = 0; zzz &lt; filter.length; zzz++) {
                if (zzz == zz)
                    f[zzz].setHighlight2(i2, j2, 1, 1)
                else
                    f[zzz].hideHighlight2()
            }
        r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt;= pos_zz ? "white" : "black")
        c.setHighlight1(subpos);
    }
    else {
        m.hideHighlight2()
        for(var zzz = 0; zzz &lt; filter.length; zzz++)
            f[zzz].hideHighlight2()
        r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt; pos_zz ? "white" : "black")
        if(subpos &gt; filter[0][0].length * filter[0][0][0].length) {
            c.hideAll()
        }
        else
            c.setHighlight1(subpos);
    }

    function p(x) { console.log(x); return x}
}
function animate(frame) {
    dom_target.querySelector("input[type=range]").value = index;
    dom_target.querySelector("input[type=range]").max = index_max - 1;
    dom_target.querySelector("input[type=range]").min = 0;
    if(show_single_elements) {
        var [pos, subpos] = divmod(frame, filter[0][0].length * filter[0][0][0].length * filter[0].length + 2)
        setHighlights(pos, subpos);
    }
    else
        setHighlights(frame, filter[0][0].length * filter[0][0][0].length * filter[0].length);
}
var index = -1
animate(0)
var interval = undefined;

function PlayStep() {
    index += 1;
    if(index &gt;= index_max)
        index = 0;
    animate(index);
}

function playPause() {
    if(interval === undefined) {
        dom_target.querySelector(".play").style.display = "none"
        dom_target.querySelector(".pause").style.display = "inline-block"
        interval = window.setInterval(PlayStep, 1000);
        PlayStep();
    }
    else {
        dom_target.querySelector(".play").style.display = "inline-block"
        dom_target.querySelector(".pause").style.display = "none"
        window.clearInterval(interval);
        interval = undefined;
    }
}
dom_target.querySelector("input[type=range]").value = 0;
dom_target.querySelector("input[type=range]").max = index_max;
dom_target.querySelector("input[type=range]").onchange = (i)=&gt;{var v = parseInt(i.target.value); index = v; animate(v);};
dom_target.querySelector(".play").onclick = playPause;
dom_target.querySelector(".pause").onclick = playPause;
dom_target.querySelector(".left").onclick = ()=&gt;{index &gt; 0 ? index -= 1 : index = index_max-1; animate(index);};
dom_target.querySelector(".right").onclick = ()=&gt;{index &lt; index_max-1 ? index += 1 : index = 0; animate(index);};

dom_target.querySelector(".input_filterx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_filtery").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_filterz").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixy").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixz").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixzB").onchange = (i)=&gt;{dom_target.querySelector(".input_matrixz").value = parseInt(i.target.value); init();};
dom_target.querySelector(".input_paddingx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_paddingy").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_stridex").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_stridey").onchange = ()=&gt;{init()}
dom_target.querySelector(".play_fast").onchange = ()=&gt;{init()}

//dom_target.querySelector(".select_maxpool").onclick = ()=&gt;{group_func="max"; dom_target.querySelector(".dropbtn").innerText = "MaxPool2d"; init()}
//dom_target.querySelector(".select_avgpool").onclick = ()=&gt;{group_func="avg"; dom_target.querySelector(".dropbtn").innerText = "AvgPool2d"; init()}

})();
&lt;/script&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="section-3-1-multiple-filters">
<h2>Section 3.1: Multiple Filters<a class="headerlink" href="#section-3-1-multiple-filters" title="Permalink to this headline">¶</a></h2>
<p>The following network sets up 3 filters and runs them on an image of the dataset from the <span class="math notranslate nohighlight">\(X\)</span> class.  Note that we are using the filters from the videos!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Net2</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Net2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                           <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>

    <span class="c1"># first kernel - leading diagonal</span>
    <span class="n">kernel_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]])</span>

    <span class="c1"># second kernel -checkerboard pattern</span>
    <span class="n">kernel_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]])</span>

    <span class="c1"># third kernel - other diagonal</span>
    <span class="n">kernel_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>

    <span class="n">multiple_kernels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">kernel_1</span><span class="p">,</span> <span class="n">kernel_2</span><span class="p">,</span> <span class="n">kernel_3</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">multiple_kernels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s visualize the filters using the code given below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net2</span> <span class="o">=</span> <span class="n">Net2</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax13</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="c1"># show the filters</span>
<span class="n">ax11</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 1"</span><span class="p">)</span>
<span class="n">ax11</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 2"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 3"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="think-3-1-do-you-see-how-these-filters-would-help-recognize-an-x">
<h3>Think! 3.1: Do you see how these filters would help recognize an <code class="docutils literal notranslate"><span class="pre">X</span></code>?<a class="headerlink" href="#think-3-1-do-you-see-how-these-filters-would-help-recognize-an-x" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id4">
<h4>Student Response<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Student Response</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">widgets</span>


<span class="n">text</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
   <span class="n">value</span><span class="o">=</span><span class="s1">'Type your answer here and click on `Submit!`'</span><span class="p">,</span>
   <span class="n">placeholder</span><span class="o">=</span><span class="s1">'Type something'</span><span class="p">,</span>
   <span class="n">description</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
   <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Submit!"</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">button</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_button_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
   <span class="n">atform</span><span class="o">.</span><span class="n">add_answer</span><span class="p">(</span><span class="s1">'q5'</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">"Submission successful!"</span><span class="p">)</span>


<span class="n">button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_button_clicked</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_256458ee.py"><em>Click for solution</em></a></p>
<p>We apply the filters to the images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net2</span> <span class="o">=</span> <span class="n">Net2</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">x_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">output_x</span> <span class="o">=</span> <span class="n">net2</span><span class="p">(</span><span class="n">x_img</span><span class="p">)</span>
<span class="n">output_x</span> <span class="o">=</span> <span class="n">output_x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">o_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">output_o</span> <span class="o">=</span> <span class="n">net2</span><span class="p">(</span><span class="n">o_img</span><span class="p">)</span>
<span class="n">output_o</span> <span class="o">=</span> <span class="n">output_o</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let us view the image of <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(O\)</span> and what the output of the filters applied to them looks like. Pay special attention to the areas with very high vs. very low output patterns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax13</span><span class="p">,</span> <span class="n">ax14</span><span class="p">),</span> <span class="p">(</span><span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax23</span><span class="p">,</span> <span class="n">ax24</span><span class="p">),</span> <span class="p">(</span><span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">,</span> <span class="n">ax33</span><span class="p">,</span> <span class="n">ax34</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1"># show the filters</span>
<span class="n">ax11</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 1"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 2"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax14</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 3"</span><span class="p">)</span>
<span class="n">ax14</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>

<span class="c1"># show x and the filters applied to x</span>
<span class="n">ax21</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"image x"</span><span class="p">)</span>
<span class="n">ax21</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax22</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 1"</span><span class="p">)</span>
<span class="n">ax22</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax23</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 2"</span><span class="p">)</span>
<span class="n">ax23</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax24</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 3"</span><span class="p">)</span>
<span class="n">ax24</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># show o and the filters applied to o</span>
<span class="n">ax31</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"image o"</span><span class="p">)</span>
<span class="n">ax31</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax32</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 1"</span><span class="p">)</span>
<span class="n">ax32</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax33</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 2"</span><span class="p">)</span>
<span class="n">ax33</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax34</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 3"</span><span class="p">)</span>
<span class="n">ax34</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="section-3-2-relu-after-convolutions">
<h2>Section 3.2: ReLU after convolutions<a class="headerlink" href="#section-3-2-relu-after-convolutions" title="Permalink to this headline">¶</a></h2>
<p>Up until now we’ve talked about the convolution operation, which is linear. But the real strength of neural networks comes from the incorporation of non-linear functions.  Furthermore, in the real world, we often have learning problems where the relationship between the input and output is non-linear and complex.</p>
<p>The ReLU (Rectified Linear Unit) introduces non-linearity into our model, allowing us to learn a more complex function that can better predict the class of an image.</p>
<p>The ReLU function is shown below.</p>
<br/>
<figure>
<center><img src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/relu.png" width="400px"/>
<figcaption>The Rectified Linear Unit (ReLU) Activation Function<figcaption>
</figcaption></figcaption></center>
</figure><p>Now let us incorporate ReLU into our previous model and visualize the output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Net3</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Net3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                           <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>

    <span class="c1"># first kernel - leading diagonal</span>
    <span class="n">kernel_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]])</span>

    <span class="c1"># second kernel -checkerboard pattern</span>
    <span class="n">kernel_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]])</span>

    <span class="c1"># third kernel - other diagonal</span>
    <span class="n">kernel_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>

    <span class="n">multiple_kernels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">kernel_1</span><span class="p">,</span> <span class="n">kernel_2</span><span class="p">,</span> <span class="n">kernel_3</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">multiple_kernels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>We apply the filters and relus to the images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net3</span> <span class="o">=</span> <span class="n">Net3</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">x_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">output_x_relu</span> <span class="o">=</span> <span class="n">net3</span><span class="p">(</span><span class="n">x_img</span><span class="p">)</span>
<span class="n">output_x_relu</span> <span class="o">=</span> <span class="n">output_x_relu</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">o_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">output_o_relu</span> <span class="o">=</span> <span class="n">net3</span><span class="p">(</span><span class="n">o_img</span><span class="p">)</span>
<span class="n">output_o_relu</span> <span class="o">=</span> <span class="n">output_o_relu</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let us view the image of <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(O\)</span> and what the output of the filters applied to them look like.</p>
<p><em>Execute this cell to view the filtered images</em></p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown *Execute this cell to view the filtered images*</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax13</span><span class="p">,</span> <span class="n">ax14</span><span class="p">,</span> <span class="n">ax15</span><span class="p">,</span> <span class="n">ax16</span><span class="p">,</span> <span class="n">ax17</span><span class="p">),</span>
      <span class="p">(</span><span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax23</span><span class="p">,</span> <span class="n">ax24</span><span class="p">,</span> <span class="n">ax25</span><span class="p">,</span> <span class="n">ax26</span><span class="p">,</span> <span class="n">ax27</span><span class="p">),</span>
      <span class="p">(</span><span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">,</span> <span class="n">ax33</span><span class="p">,</span> <span class="n">ax34</span><span class="p">,</span> <span class="n">ax35</span><span class="p">,</span> <span class="n">ax36</span><span class="p">,</span> <span class="n">ax37</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">),)</span>
<span class="c1"># show the filters</span>
<span class="n">ax11</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 1"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 2"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax14</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 3"</span><span class="p">)</span>
<span class="n">ax14</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>

<span class="n">ax15</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 1"</span><span class="p">)</span>
<span class="n">ax15</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax16</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 2"</span><span class="p">)</span>
<span class="n">ax16</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax17</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 3"</span><span class="p">)</span>
<span class="n">ax17</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>

<span class="c1"># show x and the filters applied to x</span>
<span class="n">ax21</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"image x"</span><span class="p">)</span>
<span class="n">ax21</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax22</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 1"</span><span class="p">)</span>
<span class="n">ax22</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax23</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 2"</span><span class="p">)</span>
<span class="n">ax23</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax24</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 3"</span><span class="p">)</span>
<span class="n">ax24</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax25</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 1 + relu"</span><span class="p">)</span>
<span class="n">ax25</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x_relu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax26</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 2 + relu"</span><span class="p">)</span>
<span class="n">ax26</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x_relu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax27</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 3 + relu"</span><span class="p">)</span>
<span class="n">ax27</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x_relu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># show o and the filters applied to o</span>
<span class="n">ax31</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"image o"</span><span class="p">)</span>
<span class="n">ax31</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax32</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 1"</span><span class="p">)</span>
<span class="n">ax32</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax33</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 2"</span><span class="p">)</span>
<span class="n">ax33</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax34</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 3"</span><span class="p">)</span>
<span class="n">ax34</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax35</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 1 + relu"</span><span class="p">)</span>
<span class="n">ax35</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o_relu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax36</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 2 + relu"</span><span class="p">)</span>
<span class="n">ax36</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o_relu</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax37</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 3 + relu"</span><span class="p">)</span>
<span class="n">ax37</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o_relu</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Discuss with your pod how the ReLU activations help strengthen the features necessary to detect an <span class="math notranslate nohighlight">\(X\)</span>.</p>
<p><a class="reference external" href="https://stats.stackexchange.com/a/226927">Here</a>’s an discussion which talks about how ReLU is useful as an activation funciton.</p>
<p><a class="reference external" href="https://stats.stackexchange.com/questions/126238/what-are-the-advantages-of-relu-over-sigmoid-function-in-deep-neural-networks?sfb=2">Here</a>’s another excellent discussion about the advantages of using ReLU.</p>
</div>
<div class="section" id="section-3-3-pooling">
<h2>Section 3.3: Pooling<a class="headerlink" href="#section-3-3-pooling" title="Permalink to this headline">¶</a></h2>
<p>Convolutional layers create feature maps that summarize the presence of particular features (e.g. edges) in the input. However, these feature maps record the <em>precise</em> position of features in the input. That means that small changes to the position of an object in an image can result in a very different feature map. But a cup is a cup (and an <span class="math notranslate nohighlight">\(X\)</span> is an <span class="math notranslate nohighlight">\(X\)</span>) no matter where it appears in the image!  We need to achieve <em>translational invariance</em>.</p>
<p>A common approach to this problem is called downsampling. Downsampling creates a lower-resolution version of an image, retaining the large structural elements and removing some of the fine detail that may be less relevant to the task. In CNNs, Max-Pooling and Average-Pooling are used to downsample.  These operations shrink the size of the hidden layers, and produce features that are more translationally invariant, which can be better leveraged by subsequent layers.</p>
<p>Like convolutional layers, pooling layers have fixed-shape windows (pooling windows) that are systematically applied to the input.  As with filters, we can change the shape of the window and the size of the stride.  And, just like with filters, every time we apply a pooling operation we produce a single output.</p>
<p>Pooling performs a kind of information compression that provides summary statistics for a <em>neighborhood</em> of the input.</p>
<ul class="simple">
<li><p>In Maxpooling, we compute the maximum value of all pixels in the pooling window.</p></li>
<li><p>In Avgpooling, we compute the average value of all pixels in the pooling window.</p></li>
</ul>
<p>The example below shows the result of Maxpooling within the yellow pooling windows to create the red pooling output matrix.</p>
<figure>
<center><img src="https://developers.google.com/machine-learning/glossary/images/PoolingConvolution.svg?hl=fr" width="400px"/>
<figcaption>An Example of Pooling with a kernel size of 2</figcaption>
</center>
</figure>
<p>Pooling gives our network translational invariance by providing a summary of the values in each pooling window. Thus, A small change in the features of the underlying image won’t make a huge difference to the output.</p>
<p>Note that, unlike a convolutional layer, the pooling layer contains no learned parameters! Pooling just computes a pre-determined summary of the input and passes that along.  This is in contrast to the convolutional layer, where there are filters to be learned.</p>
<div class="section" id="interactive-demo-3-3-the-effect-of-the-stride">
<h3>Interactive Demo 3.3: The effect of the stride<a class="headerlink" href="#interactive-demo-3-3-the-effect-of-the-stride" title="Permalink to this headline">¶</a></h3>
<p>The following animation depicts how changing the stride changes the output. The stride defines how much the pooling region is moved over the input matrix to produce the next output (red arrows in the animation).  Give it a try! Change the stride and see how it affects the output shape.  You can also try MaxPool or AvgPool.</p>
<p><em>Run this cell to enable the widget!</em></p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># @markdown *Run this cell to enable the widget!*

%%html


&lt;style&gt;
    svg {
        #border: 1px solid black;
    }
.matrix {
    font-family: sans-serif;
    transition: all 700ms ease-in-out;
}
.cell rect {
    fill:white;stroke-width:1;stroke:rgb(0,0,0)
}
.padding rect {
    stroke: rgba(0, 0, 0, 0.25);
}
.padding text {
    fill: lightgray;
}
.highlight1 {
    fill:none;stroke-width:4;stroke: rgb(236, 58, 58);stroke-dasharray:10,5;
}
.highlight2 {
    fill:rgba(229, 132, 66, 0.25);stroke-width:5;stroke: rgb(229, 132, 66);
}
.highlight3 {
    fill:rgba(236, 58, 58, 0.25);stroke-width:2;stroke: rgb(236, 58, 58);;
}
.title {
    text-anchor: middle;
}
.button_play {
    display: inline-block;
    background: none;
    border: none;
    position: relative;
    top: -3px;
}
.button_play path {
    fill: darkgray;
}
.button_play:hover path {
    fill: rgb(236, 58, 58);
}
.display_vis_input input:not(:hover)::-webkit-outer-spin-button,
.display_vis_input input:not(:hover)::-webkit-inner-spin-button {
    /* display: none; &lt;- Crashes Chrome on hover */
    -webkit-appearance: none;
    margin: 0; /* &lt;-- Apparently some margin are still there even though it's hidden */
}

.display_vis_input input:not(:hover)[type=number] {
    -moz-appearance:textfield; /* Firefox */
    width: 1ch;
    margin-right: 0px;
    z-index: 0;
}
.display_vis_input input[type=number] {
    width: 4ch;
    border: 0px;
    margin-right: -3ch;
    z-index: 6;
    display: inline-block;
    position: relative;
    padding: 0;
    border-bottom: 2px solid red;
    background: white;
    color: black
}
.display_vis_input .pair {
    display: inline-block;
    white-space:nowrap;
        position: relative;
}
.display_vis_input .pair .pair_hide {
    max-width: 4em;
    transition: max-width 1s ease-in;
    display: inline-block;
    overflow: hidden;
    position: relative;
    top: 5px;
}
.pair:not(:hover) .pair_hide {
    max-width: 0;
}
.pairX .pair_hide {
    max-width: 4em;
    transition: max-width 1s ease-in;
}

/* Dropdown Button */
.dropbtn {
  border-bottom: 2px solid red;
}

/* The container &lt;div&gt; - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 5px 2px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #ddd;}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {display: block;}

&lt;/style&gt;
&lt;script src="https://d3js.org/d3.v3.min.js" charset="utf-8" &gt; &lt;/script&gt;


&lt;div id="animation_conv_pool" style="background: white"&gt;
    &lt;div class="display_vis_input language-python" style="font-family: monospace; color: black; padding: 10px;"&gt;
        &lt;!--
        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, &lt;input class="input_matrixz" type="number" min="1" max="3" value="1"&gt;, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="3"&gt;))&lt;br&gt;
        conv = torch.nn.Conv2d(in_channels=&lt;input class="input_matrixzB" type="number" min="1" max="3" value="1"&gt;, out_channels=&lt;input class="input_filterz" type="number" min="1" max="3" value="1"&gt;,
        kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="1"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="1"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)
        --&gt;

        import torch&lt;br&gt;&lt;br&gt;
        input = torch.rand(1, &lt;input class="input_matrixz" type="hidden" min="1" max="3" value="1"&gt;1, &lt;input class="input_matrixx" type="number" min="3" max="5" value="4"&gt;, &lt;input class="input_matrixy" type="number" min="3" max="5" value="4"&gt;)&lt;br&gt;
        conv = torch.nn.&lt;div class="dropdown"&gt;
  &lt;div class="dropbtn"&gt;MaxPool2d&lt;/div&gt;
  &lt;div class="dropdown-content"&gt;
    &lt;a class="select_maxpool"&gt;MaxPool2d&lt;/a&gt;
    &lt;a class="select_avgpool"&gt;AvgPool2d&lt;/a&gt;
  &lt;/div&gt;
&lt;/div&gt;(&lt;input class="input_matrixzB" type="hidden" min="1" max="3" value="1"&gt;&lt;input class="input_filterz" type="hidden" min="1" max="3" value="1"&gt;kernel_size=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_filterx" type="number" min="2" max="4" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                       &lt;input class="input_filtery" type="number" min="2" max="4" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        stride=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_stridex" type="number" min="1" max="2" value="2"&gt;&lt;span class="pair_hide"&gt;,
                                                                  &lt;input class="input_stridey" type="number" min="1" max="2" value="2"&gt;)&lt;/span&gt;&lt;/span&gt;,
        padding=&lt;span class="pair"&gt;&lt;span class="pair_hide"&gt;(&lt;/span&gt;&lt;input class="input_paddingx" type="number" min="0" max="4" value="0"&gt;&lt;span class="pair_hide"&gt;,
                                                                   &lt;input class="input_paddingy" type="number" min="0" max="4" value="0"&gt;)&lt;/span&gt;&lt;/span&gt;)&lt;br&gt;
        result = conv(input)

    &lt;/div&gt;
        &lt;button class="button_play play"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 1.5,0 9.5,5 1.5,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;button class="button_play pause" style="display: none"&gt;&lt;svg width="15" height="15" viewbox="0 0 10 10"&gt;&lt;path d="M 0,0 4,0 4,10, 0,10 z"/&gt;&lt;path d="M 6,0 10,0 10,10, 6,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;input type="range" min="1" max="100" value="50" class="slider" style="width: 300px; display: inline-block"&gt;
    &lt;button class="button_play left"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,5 4,0 4,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;button class="button_play right"&gt;&lt;svg width="7" height="15" viewbox="0 0 4 10"&gt;&lt;path d="M 0,0 4,5 0,10 z"/&gt;&lt;/svg&gt;&lt;/button&gt;
    &lt;input type="checkbox" class="play_fast"&gt;fast play mode
    &lt;br/&gt;
    &lt;svg height="0" width="0"&gt;
        &lt;defs&gt;
    &lt;marker id="arrowhead" markerWidth="10" markerHeight="7"
    refX="0" refY="1.5" orient="auto" fill="rgb(236, 58, 58)"&gt;
      &lt;polygon points="0 0, 4 1.5, 0 3" /&gt;
    &lt;/marker&gt;
  &lt;/defs&gt;
    &lt;/svg&gt;
    &lt;svg class="image" height="460" width="600"&gt;

    &lt;/svg&gt;
&lt;/div&gt;
&lt;script&gt;
(function() {
var dom_target = document.getElementById("animation_conv_pool")
const divmod = (x, y) =&gt; [Math.floor(x / y), x % y];
var svg = d3.select(dom_target).select(".image")

var box_s = 50;
var box_z = 10;
var show_single_elements = true;
var group_func = "max";
function mulberry32(a) {
    return function() {
      var t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t &gt;&gt;&gt; 15, t | 1);
      t ^= t + Math.imul(t ^ t &gt;&gt;&gt; 7, t | 61);
      return ((t ^ t &gt;&gt;&gt; 14) &gt;&gt;&gt; 0) / 4294967296;
    }
}

function numberGenerator(seed, max, digits) {
    var random = mulberry32(seed)
    return () =&gt; parseFloat((random() * max).toFixed(digits));
}
window.numberGenerator = numberGenerator
window.mulberry32 = mulberry32
function generateMatrix2(number, dims) {
    var res = [];
    for (var i = 0; i &lt; dims[0]; i++) {
        if(dims.length == 1)
            res.push(number())
        else
            res.push(generateMatrix2(number, dims.slice(1)));
    }
    return res
}
window.generateMatrix2 = generateMatrix2

function addPadding(matrix, paddingx, paddingy) {
    matrix = JSON.parse(JSON.stringify(matrix));
    var ly = matrix.length; var lx = matrix[0].length;
    for (var i = 0; i &lt; ly; i++) {
        for(var p = 0; p &lt; paddingx; p++) {
            matrix[i].splice(0, 0, 0);
            matrix[i].splice(matrix[i].length, 0, 0);
        }
    }
    for(var p = 0; p &lt; paddingy; p++) {
        matrix.splice(0, 0, []);
        matrix.splice(matrix.length, 0, []);
        for (var i = 0; i &lt; lx + paddingx * 2; i++) {
            matrix[0].push(0);
            matrix[matrix.length - 1].push(0);
        }
    }
    matrix.paddingx = paddingx;
    matrix.paddingy = paddingy;
    return matrix;
}

var stride_x = 1;
var stride_y = 1;
function convolve(matrix, filter) {
    var ress = [];
    for(var zz = 0; zz &lt; filter.length; zz++) {
        var res = [];
        for (var i = 0; i &lt; parseInt((matrix[0].length - filter[0][0].length + stride_y) / stride_y); i++) {
            res.push([]);
            for (var j = 0; j &lt; parseInt((matrix[0][0].length - filter[0][0][0].length + stride_x) / stride_x); j++) {
                var answer = 0;
                var text = "";
                for (var ii = 0; ii &lt; filter[0][0].length; ii++) {
                    for (var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                        for (var z = 0; z &lt; matrix.length; z++) {
                            answer += matrix[z][i * stride_y + ii][j * stride_x + jj] * filter[zz][z][ii][jj];
                            text +=matrix[z][i * stride_y + ii][j * stride_x + jj] + "*" + filter[zz][z][ii][jj]+"+";
                        }
                    }
                }
                console.log(i, j, text, "=", answer)
                res[res.length - 1].push(answer.toFixed(1))
            }
        }
        ress.push(res)
    }
    return ress;
}
function pool(matrix, filter, func) {
    var res = [];
    for (var i = 0; i &lt; parseInt((matrix.length - filter.length + stride_y) / stride_y); i++) {
        res.push([]);
        for (var j = 0; j &lt; parseInt((matrix[0].length - filter[0].length + stride_x) / stride_x); j++) {
            var answer = [];
            for(var ii = 0; ii &lt; filter.length; ii++) {
                for(var jj = 0; jj &lt; filter[0].length; jj++) {
                    answer.push(matrix[i* stride_y + ii][j* stride_x + jj]);
                }
            }
            if(func == "max")
                res[res.length-1].push(Math.max(...answer))
            else {
                var sum = 0;
                for( var ii = 0; ii &lt; answer.length; ii++)
                    sum += answer[ii]; //don't forget to add the base
                var avg = sum/answer.length;
                res[res.length-1].push(parseFloat(avg.toFixed(1)));
            }

        }
    }
    return res;
}

class Matrix {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`);
        for(var z = 0; z &lt; matrix.length; z++) {
            var gg = this.g.append("g").attr("class", "matrix_layer").attr("transform", `translate(${- z*box_z}, ${+ z*box_z})`);
            for (var j = 0; j &lt; matrix[0].length; j++) {
                for (var i = 0; i &lt; matrix[0][0].length; i++) {
                    var element = gg.append("g").attr("class", "cell").attr("transform", `translate(${i * box_s}, ${j * box_s})`);
                    var rect = element.append("rect")
                        .attr("class", "number")
                        .attr("x", -box_s / 2 + "px")
                        .attr("y", -box_s / 2 + "px")
                        .attr("width", box_s + "px")
                        .attr("height", box_s + "px")
                    if (i &lt; matrix.paddingx || j &lt; matrix.paddingy || i &gt; matrix[0][0].length - matrix.paddingx - 1 || j &gt; matrix[0].length - matrix.paddingy - 1)
                        element.attr("class", "cell padding")
                    element.append("text").text(matrix[z][j][i]).attr("text-anchor", "middle").attr("alignment-baseline", "center").attr("dy", "0.3em")
                }
            }
            gg.append("rect").attr("class", "highlight3")
            gg.append("rect").attr("class", "highlight1")
            gg.append("rect").attr("class", "highlight2")
        }
        //&lt;line x1="0" y1="50" x2="250" y2="50" stroke="#000" stroke-width="8" marker-end="url(#arrowhead)" /&gt;
        this.arrow = gg.append("line").attr("transform", `translate(${(-0.5)*box_s}, ${(-0.5+filter.length/2)*box_s})`).attr("marker-end", "url(#arrowhead)").attr("x1", 0).attr("y1", 0).attr("x2", 50).attr("y2", 0)
            .attr("stroke", "#000").attr("stroke-width", 8).attr("stroke", "rgb(236, 58, 58)").style("opacity", 0)


        gg.append("text").attr("class", "title").text(title)
            .attr("x", (matrix[0][0].length/2-0.5)*box_s+"px")
            .attr("y", (matrix[0].length)*box_s+"px")
            .attr("dy", "0em")
        this.highlight2_hidden = true
    }

    setHighlight1(i, j, w, h) {
        if(this.old_i == i &amp;&amp; this.old_j == j &amp;&amp; this.old_w == w)
            return
        if(i == this.old_i+stride_x || j == this.old_j+stride_y) {
            if (this.old_j == j)
                this.arrow.attr("x1", this.old_i * box_s).attr("y1", j * box_s)
                    .attr("x2", i * box_s - 30).attr("y2", j * box_s).attr("transform", `translate(${(-0.5) * box_s}, ${(-0.5 + h / 2) * box_s})`)
            else
                this.arrow.attr("x1", i * box_s).attr("y1", this.old_j * box_s)
                    .attr("x2", i * box_s).attr("y2", j * box_s - 30).attr("transform", `translate(${(-0.5 + w / 2) * box_s}, ${(-0.5) * box_s})`)
            this.arrow.transition().style("opacity", 1)
                .transition()
                .duration(1000)
                .style("opacity", 0)
        }
        this.old_i = i; this.old_j = j; this.old_w = w;
        this.g.selectAll(".highlight1")
            .style("fill", "rgba(236, 58, 58, 0)")
            .transition()
            .duration(1000)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
            .style("fill", "rgba(236, 58, 58, 0.25)")
        this.g.selectAll(".highlight3")
            .style("opacity", 1)
            .transition()
            .duration(1000)
            .style("opacity", 0)
        this.g.selectAll(".highlight3")
            .transition()
            .delay(900)
            .duration(0)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
//            .style("opacity", 1)
    }

    setHighlight2(i, j, w, h) {
        if(this.highlight2_hidden == true) {
            this.g.selectAll(".highlight2")
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px")
            .transition()
            .duration(1000)
            .style("opacity", 1)
            this.highlight2_hidden = false
            return
        }
        this.g.selectAll(".highlight2")
            .transition()
            .duration(1000)
            .attr("x", (-box_s/2+i*box_s)+"px").attr("y", (-box_s/2+j*box_s)+"px")
            .attr("width", box_s*w+"px")
            .attr("height", box_s*h+"px");
    }
    hideHighlight2() {
        this.highlight2_hidden = true
        this.g.selectAll(".highlight2")
            .transition()
            .duration(1000)
            .style("opacity", 0)
    }
    //m.g.selectAll(".cell text").style("opacity", (d, i)=&gt;{console.log(i&gt;4); return 1*(i&gt;5)})
}

class Calculation {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
        this.g.append("text").text(title).attr("dy", "-1.5em").attr("dx", "2em")
        this.g = this.g.append("text")
        for (var j in matrix) {
            for (var i in matrix[j]) {
                var element = this.g;
                var a = element.append("tspan")
                    .text(i+"·"+j)
                if(i == 0 &amp;&amp; j &gt; 0)
                    a.attr("dy", "1.5em").attr("x", 0)
                if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                    a = element.append("tspan")
                    .attr("dy", "1.5em").attr("x", 0)
                    .text(" = 12 ")
                }
                else {
                    a = element.append("tspan")
                        .text(" + ")
                }
            }
        }
    }
    setText(i, text) {
        d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
    }
    hideAll() {
        this.g.selectAll("tspan")
            .attr("fill", "white")
    }
    setHighlight1(i) {
        this.g.selectAll("tspan")
            .transition()
            .duration(1000)
            .attr("fill",
            (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

    }
}

class CalculationPool {
    constructor(x, y, matrix, title) {
        this.g = svg.append("g").attr("class", "matrix").attr("transform", `translate(${x}, ${y})`)
        this.g.append("text").text(title).attr("dy", "-3em").attr("dx", "-2em")
        this.g.append("text").text(group_func+"([").attr("dy", "-1.5em").attr("dx", "-0.5em")
        this.g = this.g.append("text")
        for (var j in matrix) {
            for (var i in matrix[j]) {
                var element = this.g;
                var a = element.append("tspan")
                    .text("")
                if(i == 0 &amp;&amp; j &gt; 0)
                    a.attr("dy", "1.5em").attr("x", 0)
                if(i == matrix[0].length - 1 &amp;&amp; j == matrix.length - 1) {
                    a = element.append("tspan")
                    .attr("dy", "1.5em").attr("x", 0).attr("dx", "-0.5em")
                    .text("")
                }
                else {
                    a = element.append("tspan")
                        .text("")
                }
            }
        }
    }
    setText(i, text) {
        d3.select(this.g.selectAll("tspan")[0][i*2]).text(text)
    }
    hideAll() {
        this.g.selectAll("tspan")
            .attr("fill", "white")
    }
    setHighlight1(i) {
        this.g.selectAll("tspan")
            .transition()
            .duration(1000)
            .attr("fill",
            (d, ii) =&gt; ii==i*2 ? "rgb(229, 132, 66)" : ii&gt; i*2 ? "white" : "black")

    }
}

var matrix, res, m, f, r, c, last_pos, index_max;
function init() {
    show_single_elements = dom_target.querySelector(".play_fast").checked == false
    /*
    tuple_or_single = (x, y) =&gt; x == y ? x : `(${x}, ${y})`
    if(group_func == "max")
        dom_target.querySelector(".torch_name").innerText = `torch.nn.MaxPool2d(kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
    else if(group_func == "mean")
            dom_target.querySelector(".torch_name").innerHTML = `torch.nn.AvgPool2d(x=&lt;input class="input_filterx" type="number" min="2" max="4" value="3"&gt;, kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`
    else
        dom_target.querySelector(".torch_name").innerText = `torch.nn.Conv2d(in_channels=1, out_channels=1,  kernel_size=${tuple_or_single(dom_target.querySelector(".input_filterx").value, dom_target.querySelector(".input_filtery").value)}, stride=${tuple_or_single(dom_target.querySelector(".input_stridex").value, dom_target.querySelector(".input_stridey").value)}, padding=${tuple_or_single(dom_target.querySelector(".input_paddingx").value, dom_target.querySelector(".input_paddingy").value)})`

    if(window.hljs != undefined)
        hljs.highlightElement(dom_target.querySelector(".torch_name"))
    */
    svg.selectAll("*").remove();

    dom_target.querySelector(".input_matrixzB").value = dom_target.querySelector(".input_matrixz").value

    console.log("dom_target", dom_target)
    console.log("dom_target.querySelector(\".input_filterx\").value)", dom_target.querySelector(".input_filterx").value)
    filter = generateMatrix2(numberGenerator(17, 0.9, 1), [parseInt(dom_target.querySelector(".input_filterz").value), parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_filtery").value), parseInt(dom_target.querySelector(".input_filterx").value)]);
    if(dom_target.querySelector(".input_filterx").value == dom_target.querySelector(".input_filtery").value)
        dom_target.querySelector(".input_filterx").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_filterx").parentElement.className = "pairX"
    matrix_raw = generateMatrix2(numberGenerator(4, 9, 0), [parseInt(dom_target.querySelector(".input_matrixz").value), parseInt(dom_target.querySelector(".input_matrixy").value), parseInt(dom_target.querySelector(".input_matrixx").value)]);

    matrix = JSON.parse(JSON.stringify(matrix_raw));
    for(var z = 0; z &lt; matrix.length; z++)
        matrix[z] = addPadding(matrix_raw[z], parseInt(dom_target.querySelector(".input_paddingx").value), parseInt(dom_target.querySelector(".input_paddingy").value));
    matrix.paddingx = matrix[0].paddingx
    matrix.paddingy = matrix[0].paddingy
    stride_x = parseInt(dom_target.querySelector(".input_stridex").value)
    stride_y = parseInt(dom_target.querySelector(".input_stridey").value)

    if(dom_target.querySelector(".input_stridex").value == dom_target.querySelector(".input_stridey").value)
        dom_target.querySelector(".input_stridex").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_stridex").parentElement.className = "pairX"
        if(dom_target.querySelector(".input_paddingx").value == dom_target.querySelector(".input_paddingy").value)
        dom_target.querySelector(".input_paddingx").parentElement.className = "pair"
    else
        dom_target.querySelector(".input_paddingx").parentElement.className = "pairX"

    res = convolve(matrix, filter);
        window.matrix = matrix
        window.filter = filter
        window.res = res
    if(group_func != undefined)
        res = [pool(matrix[0], filter[0][0], group_func)]

    m = new Matrix(1*box_s, (1+filter[0][0].length+1.5)*box_s, matrix, "Matrix");

    f = []
    for(var zz = 0; zz &lt; filter.length; zz++)
        f.push(new Matrix((1+(matrix[0][0].length-filter[zz][0][0].length)/2 + zz*(1+filter[zz][0][0].length))*box_s, 1*box_s, filter[zz], group_func == undefined ? `Filter ${zz}` : "Pooling"));
    if(group_func != undefined)
        f[0].g.selectAll(".cell text").attr("fill", "white")

    console.log("res", res)
    r = new Matrix((2+(matrix[0][0].length)+1)*box_s, (1+filter[0][0].length+1.5)*box_s, res, "Result");

    var c_x = Math.max((1+(matrix[0][0].length))*box_s, (3+filter.length*(1+(filter[0][0].length)))*box_s)
    console.log("m,ax", (1+(matrix[0][0].length)), filter.length*(1+(filter[0][0].length)))
    if(group_func != undefined)
        c = new CalculationPool(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");
    else
        c = new Calculation(c_x, (1+0.5)*box_s, filter[0][0], "Calculation");

    last_pos = undefined;
    if(show_single_elements)
        index_max = filter.length*res[0].length*res[0][0].length*(filter[0][0].length * filter[0][0][0].length + 2)
    else
        index_max = filter.length*res[0].length*res[0][0].length
    window.index_max = index_max
    window.filter = filter
    setHighlights(0, 0)
    svg.attr("width", box_s*(matrix[0][0].length+res[0][0].length+4)+(c.g.node().getBoundingClientRect().width)+"px");
    svg.attr("height", box_s*(matrix[0].length+filter[0][0].length+3.0)+"px");
}
init()

function setHighlights(pos_zz, subpos) {
    var [zz, pos] = divmod(pos_zz, res[0].length*res[0][0].length)
    var [i, j] = divmod(pos, res[0][0].length)
    i *= stride_y;
    j *= stride_x;
    var [j2, i2] = divmod(subpos, filter[0][0][0].length)
    if(last_pos != pos) {
        var answer = 0;
        for(var ii = 0; ii &lt; filter[0][0].length; ii++) {
            for(var jj = 0; jj &lt; filter[0][0][0].length; jj++) {
                var text = []
                if(filter[0].length == 1) {
                    for(var z = 0; z &lt; filter[0].length; z++) {
                        if (group_func != undefined)
                            text.push(matrix[0][i + ii][j + jj] + ", ");
                        else
                            text.push(matrix[z][i + ii][j + jj] + " · " + filter[zz][z][ii][jj]);
                    }
                    if (group_func != undefined)
                        c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                    else
                        c.setText(ii * filter[0][0][0].length + jj, text.join("+"));
                }
                else {
                    for (var z = 0; z &lt; filter[0].length; z++) {
                        if (group_func != undefined)
                            text.push(matrix[0][i + ii][j + jj] + ", ");
                        else
                            text.push(matrix[z][i + ii][j + jj] + "·" + filter[zz][z][ii][jj]);
                    }
                    if (group_func != undefined)
                        c.setText(ii * filter[0][0][0].length + jj, text.join(", "));
                    else
                        c.setText(ii * filter[0][0][0].length + jj, "(" + text.join("+") + ")");
                }
            }
        }
        if(group_func != undefined)
            c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   ]) = "+res[zz][i/stride_y][j/stride_x])
        else
            c.setText(filter[0][0].length * filter[0][0][0].length - 0.5, "   = "+res[zz][i/stride_y][j/stride_x])
        c.hideAll();
        last_pos = pos;
    }
    m.setHighlight1(j, i, filter[0][0][0].length, filter[0][0].length)
    for(var zzz = 0; zzz &lt; filter.length; zzz++) {
        console.log(zzz, zz, zzz == zz)
        if (zzz == zz)
            f[zzz].setHighlight1(0, 0, filter[0][0][0].length, filter[0][0].length)
        else
            f[zzz].setHighlight1(0, 0, 0, 0)
    }
    window.f = f

    r.setHighlight1(j/stride_x, i/stride_y, 1, 1)
    r.g.selectAll(".matrix_layer").attr("opacity", (d,i) =&gt; i &gt; zz ? 0.2 : 1 )
    r.g.selectAll(".matrix_layer .highlight1").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
    r.g.selectAll(".matrix_layer .highlight3").attr("visibility", (d,i)=&gt;i==zz ? "visible" : "hidden")
    window.r = r

    if(subpos &lt; filter[0][0].length * filter[0][0][0].length) {
        m.setHighlight2(j + i2, i + j2, 1, 1)
        if(group_func == undefined)
            for(var zzz = 0; zzz &lt; filter.length; zzz++) {
                if (zzz == zz)
                    f[zzz].setHighlight2(i2, j2, 1, 1)
                else
                    f[zzz].hideHighlight2()
            }
        r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt;= pos_zz ? "white" : "black")
        c.setHighlight1(subpos);
    }
    else {
        m.hideHighlight2()
        for(var zzz = 0; zzz &lt; filter.length; zzz++)
            f[zzz].hideHighlight2()
        r.g.selectAll(".cell text").attr("fill", (d, i) =&gt; i &gt; pos_zz ? "white" : "black")
        if(subpos &gt; filter[0][0].length * filter[0][0][0].length) {
            c.hideAll()
        }
        else
            c.setHighlight1(subpos);
    }

    function p(x) { console.log(x); return x}
}
function animate(frame) {
    dom_target.querySelector("input[type=range]").value = index;
    dom_target.querySelector("input[type=range]").max = index_max - 1;
    dom_target.querySelector("input[type=range]").min = 0;
    if(show_single_elements) {
        var [pos, subpos] = divmod(frame, filter[0][0].length * filter[0][0][0].length + 2)
        setHighlights(pos, subpos);
    }
    else
        setHighlights(frame, filter[0][0].length * filter[0][0][0].length);
}
var index = -1
animate(0)
var interval = undefined;

function PlayStep() {
    index += 1;
    if(index &gt;= index_max)
        index = 0;
    animate(index);
}

function playPause() {
    if(interval === undefined) {
        dom_target.querySelector(".play").style.display = "none"
        dom_target.querySelector(".pause").style.display = "inline-block"
        interval = window.setInterval(PlayStep, 1000);
        PlayStep();
    }
    else {
        dom_target.querySelector(".play").style.display = "inline-block"
        dom_target.querySelector(".pause").style.display = "none"
        window.clearInterval(interval);
        interval = undefined;
    }
}
dom_target.querySelector("input[type=range]").value = 0;
dom_target.querySelector("input[type=range]").max = index_max;
dom_target.querySelector("input[type=range]").onchange = (i)=&gt;{var v = parseInt(i.target.value); index = v; animate(v);};
dom_target.querySelector(".play").onclick = playPause;
dom_target.querySelector(".pause").onclick = playPause;
dom_target.querySelector(".left").onclick = ()=&gt;{index &gt; 0 ? index -= 1 : index = index_max-1; animate(index);};
dom_target.querySelector(".right").onclick = ()=&gt;{index &lt; index_max-1 ? index += 1 : index = 0; animate(index);};

dom_target.querySelector(".input_filterx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_filtery").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_filterz").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixy").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixz").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_matrixzB").onchange = (i)=&gt;{dom_target.querySelector(".input_matrixz").value = parseInt(i.target.value); init();};
dom_target.querySelector(".input_paddingx").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_paddingy").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_stridex").onchange = ()=&gt;{init()}
dom_target.querySelector(".input_stridey").onchange = ()=&gt;{init()}
dom_target.querySelector(".play_fast").onchange = ()=&gt;{init()}
dom_target.querySelector(".select_maxpool").onclick = ()=&gt;{group_func="max"; dom_target.querySelector(".dropbtn").innerText = "MaxPool2d"; init()}
dom_target.querySelector(".select_avgpool").onclick = ()=&gt;{group_func="avg"; dom_target.querySelector(".dropbtn").innerText = "AvgPool2d"; init()}

})();
&lt;/script&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="coding-exercise-3-3-implement-maxpooling">
<h3>Coding Exercise 3.3: Implement MaxPooling<a class="headerlink" href="#coding-exercise-3-3-implement-maxpooling" title="Permalink to this headline">¶</a></h3>
<p>Let us now implement MaxPooling in PyTorch and observe the effects of Pooling on the dimension of the input image. Use a kernel of size 2 and stride of 2 for the MaxPooling layer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Net3</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Net3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>

    <span class="c1"># first kernel - leading diagonal</span>
    <span class="n">kernel_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]])</span>

    <span class="c1"># second kernel -checkerboard pattern</span>
    <span class="n">kernel_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]])</span>

    <span class="c1"># third kernel - other diagonal</span>
    <span class="n">kernel_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>

    <span class="n">multiple_kernels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">kernel_1</span><span class="p">,</span> <span class="n">kernel_2</span><span class="p">,</span> <span class="n">kernel_3</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">multiple_kernels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="c1">####################################################################</span>
    <span class="c1"># Fill in missing code below (...),</span>
    <span class="c1"># then remove or comment the line below to test your function</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Define the maxpool layer"</span><span class="p">)</span>
    <span class="c1">####################################################################</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=...</span><span class="p">,</span> <span class="n">stride</span><span class="o">=...</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1">####################################################################</span>
    <span class="c1"># Fill in missing code below (...),</span>
    <span class="c1"># then remove or comment the line below to test your function</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Define the maxpool layer"</span><span class="p">)</span>
    <span class="c1">####################################################################</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># pass through a max pool layer</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="c1"># add event to airtable</span>
<span class="n">atform</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">'Coding Exercise 3.3: Implement MaxPooling'</span><span class="p">)</span>

<span class="c1">## check if your implementation is correct</span>
<span class="c1"># net = Net3().to(DEVICE)</span>
<span class="c1"># check_pooling_net(net, device=DEVICE)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_67c8514b.py"><em>Click for solution</em></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>✅ Your network produced the correct output.
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">output_x_pool</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x_img</span><span class="p">)</span>
<span class="n">output_x_pool</span> <span class="o">=</span> <span class="n">output_x_pool</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">o_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">output_o_pool</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">o_img</span><span class="p">)</span>
<span class="n">output_o_pool</span> <span class="o">=</span> <span class="n">output_o_pool</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><em>Run the cell to plot the outputs!</em></p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown *Run the cell to plot the outputs!*</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax11</span><span class="p">,</span> <span class="n">ax12</span><span class="p">,</span> <span class="n">ax13</span><span class="p">,</span> <span class="n">ax14</span><span class="p">),</span> <span class="p">(</span><span class="n">ax21</span><span class="p">,</span> <span class="n">ax22</span><span class="p">,</span> <span class="n">ax23</span><span class="p">,</span> <span class="n">ax24</span><span class="p">),</span> <span class="p">(</span><span class="n">ax31</span><span class="p">,</span> <span class="n">ax32</span><span class="p">,</span> <span class="n">ax33</span><span class="p">,</span> <span class="n">ax34</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1"># show the filters</span>
<span class="n">ax11</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 1"</span><span class="p">)</span>
<span class="n">ax12</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 2"</span><span class="p">)</span>
<span class="n">ax13</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
<span class="n">ax14</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"filter 3"</span><span class="p">)</span>
<span class="n">ax14</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">net2</span><span class="o">.</span><span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>

<span class="c1"># show x and the filters applied to x</span>
<span class="n">ax21</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"image x"</span><span class="p">)</span>
<span class="n">ax21</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax22</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 1"</span><span class="p">)</span>
<span class="n">ax22</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax23</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 2"</span><span class="p">)</span>
<span class="n">ax23</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x_pool</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax24</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 3"</span><span class="p">)</span>
<span class="n">ax24</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_x_pool</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># show o and the filters applied to o</span>
<span class="n">ax31</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"image o"</span><span class="p">)</span>
<span class="n">ax31</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax32</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 1"</span><span class="p">)</span>
<span class="n">ax32</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax33</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 2"</span><span class="p">)</span>
<span class="n">ax33</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o_pool</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax34</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"output filter 3"</span><span class="p">)</span>
<span class="n">ax34</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output_o_pool</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>You should observe the size of the output as being half of what you saw after the ReLU section, which is due to the Maxpool layer.</p>
<p>Despite the reduction in the size of the output, the important or high-level features in the output still remains intact.</p>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="section-4-putting-it-all-together">
<h1>Section 4: Putting it all together<a class="headerlink" href="#section-4-putting-it-all-together" title="Permalink to this headline">¶</a></h1>
<div class="section" id="video-5-putting-it-all-together">
<h2>Video 5: Putting it all together<a class="headerlink" href="#video-5-putting-it-all-together" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="section-4-1-number-of-parameters-in-convolutional-vs-fully-connected-models">
<h2>Section 4.1: Number of Parameters in Convolutional vs. Fully-connected Models<a class="headerlink" href="#section-4-1-number-of-parameters-in-convolutional-vs-fully-connected-models" title="Permalink to this headline">¶</a></h2>
<p>Convolutional networks encourage weight-sharing by learning a single kernel that is repeated over the entire input image. In general, this kernel is just a few parameters, compared to the huge number of parameters in a dense network.</p>
<p>Let’s use the animation below to calculate few-layer network parameters for image data of shape <span class="math notranslate nohighlight">\(32\times32\)</span> using both convolutional layers and dense layers. The <code class="docutils literal notranslate"><span class="pre">Num_Dense</span></code> in this exercise is the number of dense layers we use in the network, with each dense layer having the same input and output dimensions. <code class="docutils literal notranslate"><span class="pre">Num_Convs</span></code> is the number of convolutional blocks in the network, with each block containing a single kernel. The kernel size is the length and width of this kernel.</p>
<p><strong>Note:</strong> you must run the cell before you can use the sliders.</p>
<br/>
<center>
<img src="https://raw.githubusercontent.com/NeuromatchAcademy/course-content-dl/main/tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/static/img_params.png"/>
<figcaption> Parameter comparison</figcaption>
</center>
<div class="section" id="interactive-demo-4-1-number-of-parameters">
<h3>Interactive Demo 4.1: Number of Parameters<a class="headerlink" href="#interactive-demo-4-1-number-of-parameters" title="Permalink to this headline">¶</a></h3>
<p><em>Run this cell to enable the widget</em></p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown *Run this cell to enable the widget*</span>
<span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">interact_manual</span>



<span class="k">def</span> <span class="nf">do_plot</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">number_of_Linear</span><span class="p">,</span> <span class="n">number_of_Conv2d</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="p">,</span> <span class="n">pooling</span><span class="p">,</span> <span class="n">Final_Layer</span><span class="p">):</span>

  <span class="n">sample_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)</span>
  <span class="n">linear_layer</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">linear_nets</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">code_dense</span> <span class="o">=</span> <span class="s2">""</span>

  <span class="n">code_dense</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"model_dense = nn.Sequential(</span><span class="se">\n</span><span class="s2">"</span>
  <span class="n">code_dense</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"    nn.Flatten(),</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_Linear</span><span class="p">):</span>
    <span class="n">linear_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">image_size</span> <span class="o">*</span> <span class="n">image_size</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">image_size</span> <span class="o">*</span> <span class="n">image_size</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">linear_nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">linear_layer</span><span class="p">))</span>
    <span class="n">code_dense</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"    nn.Linear(</span><span class="si">{</span><span class="n">image_size</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">image_size</span><span class="si">}</span><span class="s2">*1, </span><span class="si">{</span><span class="n">image_size</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">image_size</span><span class="si">}</span><span class="s2">*1, bias=False),</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">if</span> <span class="n">Final_Layer</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">linear_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">image_size</span> <span class="o">*</span> <span class="n">image_size</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                                  <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">linear_nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">linear_layer</span><span class="p">))</span>
    <span class="n">code_dense</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"    nn.Linear(</span><span class="si">{</span><span class="n">image_size</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">image_size</span><span class="si">}</span><span class="s2">*1, 10, bias=False)</span><span class="se">\n</span><span class="s2">"</span>
  <span class="n">code_dense</span> <span class="o">+=</span> <span class="s2">")</span><span class="se">\n</span><span class="s2">"</span>
  <span class="n">code_dense</span> <span class="o">+=</span> <span class="s2">"result_dense = model_dense(sample_image)</span><span class="se">\n</span><span class="s2">"</span>
  <span class="n">linear_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">linear_layer</span><span class="p">)</span>

  <span class="n">conv_layer</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">conv_nets</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">code_conv</span> <span class="o">=</span> <span class="s2">""</span>

  <span class="n">code_conv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"model_conv = nn.Sequential(</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_Conv2d</span><span class="p">):</span>
    <span class="n">conv_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">out_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
                                <span class="n">padding</span><span class="o">=</span><span class="n">kernel_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="n">conv_nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">conv_layer</span><span class="p">))</span>
    <span class="n">code_conv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"    nn.Conv2d(in_channels=1, out_channels=1, kernel_size=</span><span class="si">{</span><span class="n">kernel_size</span><span class="si">}</span><span class="s2">, padding=</span><span class="si">{</span><span class="n">kernel_size</span><span class="o">//</span><span class="mi">2</span><span class="si">}</span><span class="s2">, bias=False),</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">if</span> <span class="n">pooling</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">conv_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
      <span class="n">code_conv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"    nn.MaxPool2d(2, 2),</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">conv_nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">conv_layer</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">Final_Layer</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">conv_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
    <span class="n">code_conv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"    nn.Flatten(),</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">conv_nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">conv_layer</span><span class="p">))</span>
    <span class="n">shape_conv</span> <span class="o">=</span> <span class="n">conv_nets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">sample_image</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">conv_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">shape_conv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">code_conv</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"    nn.Linear(</span><span class="si">{</span><span class="n">shape_conv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, 10, bias=False),</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">conv_nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">conv_layer</span><span class="p">))</span>
  <span class="n">conv_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">conv_layer</span><span class="p">)</span>
  <span class="n">code_conv</span> <span class="o">+=</span> <span class="s2">")</span><span class="se">\n</span><span class="s2">"</span>
  <span class="n">code_conv</span> <span class="o">+=</span> <span class="s2">"result_conv = model_conv(sample_image)</span><span class="se">\n</span><span class="s2">"</span>


  <span class="n">t_1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="n">shape_linear</span> <span class="o">=</span> <span class="n">linear_layer</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">t_2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="n">shape_conv</span> <span class="o">=</span> <span class="n">conv_layer</span><span class="p">(</span><span class="n">sample_image</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">t_3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

  <span class="nb">print</span><span class="p">(</span><span class="s2">"Time taken by Dense Layer </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_2</span> <span class="o">-</span> <span class="n">t_1</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"Time taken by Conv Layer  </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_3</span> <span class="o">-</span> <span class="n">t_2</span><span class="p">))</span>

  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">"left"</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">"bottom"</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">"right"</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">"top"</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">linear_layer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
  <span class="n">nl</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">conv_layer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"Total Parameters in Dense Layer </span><span class="si">{</span><span class="n">p1</span><span class="si">:</span><span class="s2">10,d</span><span class="si">}{</span><span class="n">nl</span><span class="si">}</span><span class="s2">Total Parameters in Conv Layer   </span><span class="si">{</span><span class="n">p2</span><span class="si">:</span><span class="s2">10,d</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.23</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="s2">"Dense Net"</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">"center"</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> <span class="n">text3</span><span class="p">):</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text1</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
               <span class="n">va</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
               <span class="n">va</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text3</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
               <span class="n">va</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

  <span class="n">x</span> <span class="o">=</span> <span class="mf">0.25</span>
  <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">"Flatten"</span><span class="p">,</span>
           <span class="nb">tuple</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.08</span> <span class="o">+</span> <span class="mf">0.01</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_Linear</span><span class="p">):</span>
    <span class="n">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">,</span> <span class="s2">"Dense"</span><span class="p">,</span>
           <span class="nb">tuple</span><span class="p">(</span><span class="n">linear_nets</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
           <span class="nb">list</span><span class="p">(</span><span class="n">linear_layer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.11</span>

  <span class="k">if</span> <span class="n">Final_Layer</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">number_of_Linear</span>
    <span class="n">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">,</span> <span class="s2">"Dense"</span><span class="p">,</span>
           <span class="nb">tuple</span><span class="p">(</span><span class="n">linear_nets</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">sample_image</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
           <span class="nb">list</span><span class="p">(</span><span class="n">linear_layer</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.23</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.35</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"Conv Net"</span><span class="p">,</span>
           <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span>
           <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">"center"</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="mf">0.25</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_Conv2d</span><span class="p">):</span>
    <span class="n">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"Conv"</span><span class="p">,</span>
           <span class="nb">tuple</span><span class="p">(</span><span class="n">conv_nets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">](</span><span class="n">sample_image</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
           <span class="nb">list</span><span class="p">(</span><span class="n">conv_nets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.11</span>
    <span class="k">if</span> <span class="n">pooling</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">"Pooling"</span><span class="p">,</span>
             <span class="nb">tuple</span><span class="p">(</span><span class="n">conv_nets</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">](</span><span class="n">sample_image</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s2">""</span><span class="p">)</span>
      <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.08</span> <span class="o">+</span> <span class="mf">0.01</span>

  <span class="k">if</span> <span class="n">Final_Layer</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">number_of_Conv2d</span>
    <span class="n">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">"Flatten"</span><span class="p">,</span>
           <span class="nb">tuple</span><span class="p">(</span><span class="n">conv_nets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">](</span><span class="n">sample_image</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.08</span> <span class="o">+</span> <span class="mf">0.01</span>

    <span class="n">addBox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">,</span> <span class="s2">"Dense"</span><span class="p">,</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">conv_nets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">](</span><span class="n">sample_image</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">conv_nets</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.11</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.08</span><span class="p">,</span><span class="mf">0.3</span><span class="o">+</span><span class="mf">0.35</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"Input"</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'b'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">"center"</span><span class="p">)</span>

  <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'b'</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.35</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sample_image</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
           <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">)</span>

  <span class="c1"># Plot</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_tight_layout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
  <span class="n">my_stringIObytes</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">my_stringIObytes</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'png'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
  <span class="n">my_stringIObytes</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">my_base64_jpgData</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">my_stringIObytes</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

  <span class="k">del</span> <span class="n">linear_layer</span><span class="p">,</span> <span class="n">conv_layer</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="n">mystring</span> <span class="o">=</span> <span class="s2">"""&lt;img src="data:image/png;base64,"""</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">my_base64_jpgData</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"""" alt="Graph"&gt;"""</span>

  <span class="k">return</span> <span class="n">code_dense</span><span class="p">,</span> <span class="n">code_conv</span><span class="p">,</span> <span class="n">mystring</span>


<span class="c1"># Parameters</span>
<span class="n">caption</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">'The values of range1 and range2 are synchronized'</span><span class="p">)</span>
<span class="n">slider_batch_size</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                      <span class="n">description</span><span class="o">=</span><span class="s2">"BatchSize"</span><span class="p">)</span>
<span class="n">slider_image_size</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                                      <span class="n">description</span><span class="o">=</span><span class="s2">"ImageSize"</span><span class="p">)</span>
<span class="n">slider_number_of_Linear</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s2">"NumDense"</span><span class="p">)</span>
<span class="n">slider_number_of_Conv2d</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s2">"NumConv"</span><span class="p">)</span>
<span class="n">slider_kernel_size</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="n">description</span><span class="o">=</span><span class="s2">"KernelSize"</span><span class="p">)</span>
<span class="n">input_pooling</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">description</span><span class="o">=</span><span class="s2">"Pooling"</span><span class="p">)</span>
<span class="n">input_Final_Layer</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">description</span><span class="o">=</span><span class="s2">"Final_Layer"</span><span class="p">)</span>

<span class="n">output_code1</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="p">)</span>

<span class="n">output_plot</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_func</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span>
              <span class="n">number_of_Linear</span><span class="p">,</span> <span class="n">number_of_Conv2d</span><span class="p">,</span>
              <span class="n">kernel_size</span><span class="p">,</span> <span class="n">pooling</span><span class="p">,</span> <span class="n">Final_Layer</span><span class="p">):</span>

    <span class="n">code1</span><span class="p">,</span> <span class="n">code2</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="n">do_plot</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span>
                                 <span class="n">number_of_Linear</span><span class="p">,</span> <span class="n">number_of_Conv2d</span><span class="p">,</span>
                                 <span class="n">kernel_size</span><span class="p">,</span> <span class="n">pooling</span><span class="p">,</span> <span class="n">Final_Layer</span><span class="p">)</span>
    <span class="n">output_plot</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">plot</span>

    <span class="n">output_code1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    &lt;!DOCTYPE html&gt;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">      &lt;head&gt;</span>
<span class="s2">        &lt;style&gt;</span>
<span class="s2">          * {</span>
<span class="s2">            box-sizing: border-box;</span>
<span class="s2">          }</span>
<span class="s2">          .column {</span>
<span class="s2">            float: left;</span>
<span class="s2">            /*width: 33.33%;*/</span>
<span class="s2">            padding: 5px;</span>
<span class="s2">          }</span>
<span class="s2">          /* Clearfix (clear floats) */</span>
<span class="s2">          .row::after {</span>
<span class="s2">            content: "";</span>
<span class="s2">            clear: both;</span>
<span class="s2">            display: table;</span>
<span class="s2">          }</span>
<span class="s2">          pre {</span>
<span class="s2">            line-height: 1.2em;</span>
<span class="s2">          }</span>
<span class="s2">        &lt;/style&gt;</span>
<span class="s2">      &lt;/head&gt;</span>

<span class="s2">      &lt;body&gt;</span>
<span class="s2">        &lt;div class="row"&gt;</span>
<span class="s2">          &lt;div class="column" style="overflow-x: scroll;"&gt;</span>
<span class="s2">          &lt;h2&gt;Code for Dense Network&lt;/h2&gt;</span>
<span class="s2">          &lt;pre&gt;"""</span><span class="o">+</span><span class="n">code1</span><span class="o">+</span><span class="s2">"""&lt;/pre&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">          &lt;div class="column" style="overflow-x: scroll;"&gt;</span>
<span class="s2">          &lt;h2&gt;Code for Conv Network&lt;/h2&gt;</span>
<span class="s2">          &lt;pre&gt;"""</span><span class="o">+</span><span class="n">code2</span><span class="o">+</span><span class="s2">"""&lt;/pre&gt;</span>
<span class="s2">          &lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">      &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">"""</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive_output</span><span class="p">(</span><span class="n">plot_func</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">slider_batch_size</span><span class="p">,</span>
    <span class="s2">"image_size"</span><span class="p">:</span> <span class="n">slider_image_size</span><span class="p">,</span>
    <span class="s2">"number_of_Linear"</span><span class="p">:</span> <span class="n">slider_number_of_Linear</span><span class="p">,</span>
    <span class="s2">"number_of_Conv2d"</span><span class="p">:</span> <span class="n">slider_number_of_Conv2d</span><span class="p">,</span>
    <span class="s2">"kernel_size"</span><span class="p">:</span> <span class="n">slider_kernel_size</span><span class="p">,</span>
    <span class="s2">"pooling"</span><span class="p">:</span> <span class="n">input_pooling</span><span class="p">,</span>
    <span class="s2">"Final_Layer"</span><span class="p">:</span> <span class="n">input_Final_Layer</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">ui</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">slider_batch_size</span><span class="p">,</span> <span class="n">slider_image_size</span><span class="p">,</span> <span class="n">slider_number_of_Linear</span><span class="p">,</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">slider_number_of_Conv2d</span><span class="p">,</span> <span class="n">slider_kernel_size</span><span class="p">,</span> <span class="n">input_pooling</span><span class="p">]),</span> <span class="n">input_Final_Layer</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">output_plot</span><span class="p">,</span> <span class="n">output_code1</span><span class="p">]),</span> <span class="n">ui</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The difference in parameters is huge, and it continues to increase as the input image size increases. Larger images require that the linear layer use a matrix that can be directly multiplied with the input pixels.</p>
<br/>
<p>While pooling does not reduce the number of parameters for a subsequent convolutional layer, it does decreases the image size. Therefore, later dense layers will need fewer parameters.</p>
<br/>
<p>The CNN parameter size, however, is invariant of the image size, as irrespective of the input that it gets, it keeps sliding the same learnable filter over the images.</p>
<p>The reduced parameter set not only brings down memory usage by huge chunks, but it also allows the model to generalize better.</p>
<div class="section" id="video-6-implement-your-own-cnn">
<h4>Video 6: Implement your own CNN<a class="headerlink" href="#video-6-implement-your-own-cnn" title="Permalink to this headline">¶</a></h4>
<div class="cell tag_remove-input docutils container">
</div>
</div>
</div>
</div>
<div class="section" id="coding-exercise-4-implement-your-own-cnn">
<h2>Coding Exercise 4: Implement your own CNN<a class="headerlink" href="#coding-exercise-4-implement-your-own-cnn" title="Permalink to this headline">¶</a></h2>
<p>Let’s stack up all we have learnt. Create a CNN with the following structure. <br/></p>
<ul class="simple">
<li><p>Convolution <code class="docutils literal notranslate"><span class="pre">nn.Conv2d(in_channels=1,</span> <span class="pre">out_channels=32,</span> <span class="pre">kernel_size=3)</span></code></p></li>
<li><p>Convolution <code class="docutils literal notranslate"><span class="pre">nn.Conv2d(in_channels=32,</span> <span class="pre">out_channels=64,</span> <span class="pre">kernel_size=3)</span></code></p></li>
<li><p>Pool Layer <code class="docutils literal notranslate"><span class="pre">nn.MaxPool2d(kernel_size=2)</span></code></p></li>
<li><p>Fully Connected Layer <code class="docutils literal notranslate"><span class="pre">nn.Linear(in_features=9216,</span> <span class="pre">out_features=128)</span></code></p></li>
<li><p>Fully Connected layer <code class="docutils literal notranslate"><span class="pre">nn.Linear(in_features=128,</span> <span class="pre">out_features=2)</span></code></p></li>
</ul>
<p>Note: As discussed in the video, we would like to flatten the output from the Convolutional Layers before passing on the Linear layers, thereby converting an input of shape [BatchSize, Channels, Height, Width] to [BatchSize, Channels\*Height\*Width], which in this case would be from [32, 64, 12, 12] (output of second convolution layer) to [32, 64*12*12] = [32, 9216]. Recall that the input images have size [28, 28].</p>
<p>Hint: You could use <code class="docutils literal notranslate"><span class="pre">torch.flatten(x,</span> <span class="pre">1)</span></code> in order to flatten the input at this stage. The 1 means it flattens dimensions starting with dimensions 1 in order to exclude the batch dimension from the flattening.</p>
<p>We should also stop to think about how we get the output of the pooling layer to be 12x12. It is because first, the two <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code> with a <code class="docutils literal notranslate"><span class="pre">kernel_size=3</span></code> operations cause the image to be reduced to 26x26 and the second <code class="docutils literal notranslate"><span class="pre">Conv2d</span></code> reduces it to 24x24. Finally, the <code class="docutils literal notranslate"><span class="pre">MaxPool2d</span></code> operation reduces the output size by half to 12x12.</p>
<p>Also, don’t forget the ReLUs (use e.g. <code class="docutils literal notranslate"><span class="pre">F.ReLU</span></code>)! No need to add a ReLU after the final fully connected layer.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @markdown ### Train/Test Functions (Run Me)</span>

<span class="c1"># @markdown  Double-click to see the contents!</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
  <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

  <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
  <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>
                            <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'batch'</span><span class="p">)</span> <span class="k">as</span> <span class="n">tepoch</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">tepoch</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">tepoch</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">):</span>
  <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
  <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_loader</span><span class="p">:</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

  <span class="n">acc</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
  <span class="k">return</span> <span class="n">acc</span>
</pre></div>
</div>
</div>
</div>
<p>We download the data. Notice that here, we normalize the dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">emnist_train</span><span class="p">,</span> <span class="n">emnist_test</span> <span class="o">=</span> <span class="n">get_Xvs0_dataset</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">get_data_loaders</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">,</span> <span class="n">emnist_test</span><span class="p">,</span>
                                             <span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EMNIST_Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">EMNIST_Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1">####################################################################</span>
    <span class="c1"># Fill in missing code below (...),</span>
    <span class="c1"># then remove or comment the line below to test your function</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Define the required layers"</span><span class="p">)</span>
    <span class="c1">####################################################################</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1">####################################################################</span>
    <span class="c1"># Fill in missing code below (...),</span>
    <span class="c1"># then remove or comment the line below to test your function</span>
    <span class="c1"># Hint: Do not forget to flatten the image as it goes from</span>
    <span class="c1"># Convolution Layers to Linear Layers!</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Define forward pass for any input x"</span><span class="p">)</span>
    <span class="c1">####################################################################</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">x</span> <span class="o">=</span> <span class="o">...</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="c1"># add event to airtable</span>
<span class="n">atform</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">'Coding Exercise 4: Implement your own CNN'</span><span class="p">)</span>

<span class="c1">## Uncomment the lines below to train your network</span>
<span class="c1"># emnist_net = EMNIST_Net().to(DEVICE)</span>
<span class="c1"># print("Total Parameters in Network {:10d}".format(sum(p.numel() for p in emnist_net.parameters())))</span>
<span class="c1"># train(emnist_net, DEVICE, train_loader, 1)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/solutions/W2D1_Tutorial1_Solution_33ecb6a5.py"><em>Click for solution</em></a></p>
<p>Now, let’s run the network on the test data!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">(</span><span class="n">emnist_net</span><span class="p">,</span> <span class="n">DEVICE</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You should have been able to get a test accuracy of around <span class="math notranslate nohighlight">\(99%\)</span>!</p>
<p><strong>Note:</strong> We are using a softmax function here which converts a real value to a value between 0 and 1, which can be interpreted as a probability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># index of an image in the dataset that corresponds to an X and O</span>
<span class="n">x_img_idx</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">o_img_idx</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Input:"</span><span class="p">)</span>
<span class="n">x_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">x_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
           <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'gray'</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">emnist_net</span><span class="p">(</span><span class="n">x_img</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Result:"</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Confidence of image being an 'O':"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Confidence of image being an 'X':"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>The network is quite confident that this image is an <span class="math notranslate nohighlight">\(X\)</span>!</p>
<p>Note that this is evident from the softmax output, which shows the probabilities of the image belonging to each of the classes. There is a higher probability of belonging to class 1; i.e., class <span class="math notranslate nohighlight">\(X\)</span>.</p>
<p>Let us also test the network on an <span class="math notranslate nohighlight">\(O\)</span> image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Input:"</span><span class="p">)</span>
<span class="n">o_img</span> <span class="o">=</span> <span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">emnist_train</span><span class="p">[</span><span class="n">o_img_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
           <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'gray'</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">emnist_net</span><span class="p">(</span><span class="n">o_img</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Result:"</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Confidence of image being an 'O':"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Confidence of image being an 'X':"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils"/>
<div class="section" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h1>
<p>In this Tutorial we have familiarized ouselves with CNNs. We have leaned how the convolution operation works and be applied in various images. Also, we have learned to implement our own CNN. In the next Tutorial, we will go deeper in the training of CNNs!</p>
<div class="section" id="airtable-submission-link">
<h2>Airtable Submission Link<a class="headerlink" href="#airtable-submission-link" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Airtable Submission Link</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span> <span class="k">as</span> <span class="n">IPyDisplay</span>
<span class="n">IPyDisplay</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">  &lt;div&gt;</span>
<span class="s2">    &lt;a href= "</span><span class="si">{</span><span class="n">atform</span><span class="o">.</span><span class="n">url</span><span class="p">()</span><span class="si">}</span><span class="s2">" target="_blank"&gt;</span>
<span class="s2">    &lt;img src="https://github.com/NeuromatchAcademy/course-content-dl/blob/main/tutorials/static/AirtableSubmissionButton.png?raw=1"</span>
<span class="s2">  alt="button link to Airtable" style="width:410px"&gt;&lt;/a&gt;</span>
<span class="s2">    &lt;/div&gt;"""</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./tutorials/W2D1_ConvnetsAndRecurrentNeuralNetworks/student"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
</div>
<div class="prev-next-bottom">
<a class="left-prev" href="../chapter_title.html" id="prev-link" title="previous page">Convnets And Recurrent Neural Networks</a>
<a class="right-next" href="W2D1_Tutorial2.html" id="next-link" title="next page">Tutorial 2: Training loop of CNNs</a>
</div>
</div>
</div>
<footer class="footer mt-5 mt-md-0">
<div class="container">
<p>
        
          By Neuromatch<br>
        
            © Copyright 2021.<br>
</br></br></p>
</div>
</footer>
</main>
</div>
</div>
<script src="../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>
</body>
</html>
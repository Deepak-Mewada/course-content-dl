
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tutorial 1: Learn to play games with RL &#8212; Neuromatch Academy: Deep Learning</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../../../_static/nma-dl-logo-square-4xp.jpeg"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Continual Learning" href="../../W3D4_ContinualLearning/chapter_title.html" />
    <link rel="prev" title="Reinforcement Learning For Games" href="../chapter_title.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      <img src="../../../_static/nma-dl-logo-square-4xp.jpeg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Neuromatch Academy: Deep Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../Schedule/schedule_intro.html">
   Schedule
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Schedule/daily_schedules.html">
     General schedule
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Schedule/shared_calendars.html">
     Shared calendars
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../Schedule/timezone_widget.html">
     Timezone widget
    </a>
   </li>
  </ul>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../TechnicalHelp/tech_intro.html">
   Technical Help
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../TechnicalHelp/Jupyterbook.html">
     Using jupyterbook
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../TechnicalHelp/Tutorial_colab.html">
       Using Google Colab
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../TechnicalHelp/Tutorial_kaggle.html">
       Using Kaggle
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../TechnicalHelp/Discord.html">
     Using Discord
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  The Basics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W1D1_BasicsAndPytorch/chapter_title.html">
   Basics And Pytorch (W1D1)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D1_BasicsAndPytorch/student/W1D1_Tutorial1.html">
     Tutorial 1: PyTorch
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W1D2_LinearDeepLearning/chapter_title.html">
   Linear Deep Learning (W1D2)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D2_LinearDeepLearning/student/W1D2_Tutorial1.html">
     Tutorial 1: Gradient Descent and AutoGrad
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D2_LinearDeepLearning/student/W1D2_Tutorial2.html">
     Tutorial 2: Learning Hyperparameters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D2_LinearDeepLearning/student/W1D2_Tutorial3.html">
     Tutorial 3: Deep linear neural networks
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W1D3_MultiLayerPerceptrons/chapter_title.html">
   Multi Layer Perceptrons (W1D3)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D3_MultiLayerPerceptrons/student/W1D3_Tutorial1.html">
     Tutorial 1: Biological vs. Artificial neurons
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D3_MultiLayerPerceptrons/student/W1D3_Tutorial2.html">
     Tutorial 2: Deep MLPs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W1D4_Optimization/chapter_title.html">
   Optimization (W1D4)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D4_Optimization/student/W1D4_Tutorial1.html">
     Tutorial 1: Optimization techniques
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W1D5_Regularization/chapter_title.html">
   Regularization (W1D5)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D5_Regularization/student/W1D5_Tutorial1.html">
     Tutorial 1: Regularization techniques part 1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W1D5_Regularization/student/W1D5_Tutorial2.html">
     Tutorial 2: Regularization techniques part 2
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Doing more with fewer parameters
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W2D1_ConvnetsAndRecurrentNeuralNetworks/chapter_title.html">
   Convnets And Recurrent Neural Networks (W2D1)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D1_ConvnetsAndRecurrentNeuralNetworks/student/W2D1_Tutorial1.html">
     Tutorial 1: Introduction to CNNs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D1_ConvnetsAndRecurrentNeuralNetworks/student/W2D1_Tutorial2.html">
     Tutorial 2: Training loop of CNNs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D1_ConvnetsAndRecurrentNeuralNetworks/student/W2D1_Tutorial3.html">
     Tutorial 3: Introduction to RNNs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W2D2_ModernConvnets/chapter_title.html">
   Modern Convnets (W2D2)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D2_ModernConvnets/student/W2D2_Tutorial1.html">
     Tutorial 1: Learn how to use modern convnets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D2_ModernConvnets/student/W2D2_Tutorial2.html">
     Tutorial 2: Facial recognition using modern convnets
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W2D3_ModernRecurrentNeuralNetworks/chapter_title.html">
   Modern Recurrent Neural Networks (W2D3)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D3_ModernRecurrentNeuralNetworks/student/W2D3_Tutorial1.html">
     Tutorial 1: Modeling sequencies and encoding text
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D3_ModernRecurrentNeuralNetworks/student/W2D3_Tutorial2.html">
     Tutorial 2: Modern RNNs and their variants
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W2D4_AttentionAndTransformers/chapter_title.html">
   Attention And Transformers (W2D4)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D4_AttentionAndTransformers/student/W2D4_Tutorial1.html">
     Tutorial 1: Learn how to work with Transformers
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W2D5_GenerativeModels/chapter_title.html">
   Generative Models (W2D5)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D5_GenerativeModels/student/W2D5_Tutorial1.html">
     Tutorial 1: Variational Autoencoders (VAEs)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D5_GenerativeModels/student/W2D5_Tutorial2.html">
     Tutorial 2: Introduction to GANs and Density Ratio Estimation Perspective of GANs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W2D5_GenerativeModels/student/W2D5_Tutorial3.html">
     Tutorial 3: Conditional GANs and Implications of GAN Technology
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Advanced topics
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W3D1_UnsupervisedAndSelfSupervisedLearning/chapter_title.html">
   Unsupervised And Self Supervised Learning (W3D1)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W3D1_UnsupervisedAndSelfSupervisedLearning/student/W3D1_Tutorial1.html">
     Tutorial 1: Un/Self-supervised learning methods
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W3D2_BasicReinforcementLearning/chapter_title.html">
   Basic Reinforcement Learning (W3D2)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W3D2_BasicReinforcementLearning/student/W3D2_Tutorial1.html">
     Tutorial 1: Introduction to Reinforcement Learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../chapter_title.html">
   Reinforcement Learning For Games (W3D3)
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
  <label for="toctree-checkbox-16">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Tutorial 1: Learn to play games with RL
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../W3D4_ContinualLearning/chapter_title.html">
   Continual Learning (W3D4)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
  <label for="toctree-checkbox-17">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W3D4_ContinualLearning/student/W3D4_Tutorial1.html">
     Tutorial 1: Introduction to Continual Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../W3D4_ContinualLearning/student/W3D4_Tutorial2.html">
     Tutorial 2: Out-of-distribution (OOD) Learning
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/tutorials/W3D3_ReinforcementLearningForGames/student/W3D3_Tutorial1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/NeuromatchAcademy/course-content-dl"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/NeuromatchAcademy/course-content-dl/issues/new?title=Issue%20on%20page%20%2Ftutorials/W3D3_ReinforcementLearningForGames/student/W3D3_Tutorial1.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Tutorial 1: Learn to play games with RL
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tutorial-objectives">
   Tutorial Objectives
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-0-introduction">
     Video 0: Introduction
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tutorial-slides">
     Tutorial slides
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-modules">
     Download the modules
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-dependencies">
     Install dependencies
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-random-seed">
     Set random seed
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-device-gpu-or-cpu-execute-set-device">
     Set device (GPU or CPU). Execute
     <code class="docutils literal notranslate">
      <span class="pre">
       set_device()
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-1-create-a-game-agent-loop-for-rl">
   Section 1: Create a game/agent loop for RL
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-1-a-game-loop-for-rl">
     Video 1: A game loop for RL
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-1-1-create-a-random-player">
     Section 1.1: Create a random player
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#coding-exercise-1-1-implement-a-random-player">
       Coding Exercise 1.1: Implement a random player
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-1-2-initiate-the-game-board">
     Section 1.2. Initiate the game board
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-1-3-create-two-random-agents-to-play-against-each-other">
     Section 1.3. Create two random agents to play against each other
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-1-4-compute-win-rate-for-the-random-player-player-1">
     Section 1.4. Compute win rate for the random player (player 1)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-2-train-a-value-function-from-expert-game-data">
   Section 2: Train a value function from expert game data
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-2-train-a-value-function">
     Video 2: Train a value function
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-2-1-load-expert-data">
     Section 2.1. Load expert data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-2-2-define-the-neural-network-architecture-for-othello">
     Section 2.2. Define the Neural Network Architecture for Othello
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#coding-exercise-2-2-implement-the-nn-othellonnet-for-othello">
       Coding Exercise 2.2: Implement the NN
       <code class="docutils literal notranslate">
        <span class="pre">
         OthelloNNet
        </span>
       </code>
       for Othello
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-2-3-define-the-value-network">
     Section 2.3. Define the Value network
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#coding-exercise-2-3-implement-the-valuenetwork">
       Coding Exercise 2.3: Implement the
       <code class="docutils literal notranslate">
        <span class="pre">
         ValueNetwork
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-2-4-train-the-value-network-and-observe-the-mse-loss-progress">
     Section 2.4. Train the value network and observe the MSE loss progress
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-3-use-a-trained-value-network-to-play-games">
   Section 3: Use a trained value network to play games
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-3-play-games-using-a-value-function">
     Video 3: Play games using a value function
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#coding-exercise-3-value-based-player">
     Coding Exercise 3: Value-based player
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-4-train-a-policy-network-from-expert-game-data">
   Section 4: Train a policy network from expert game data
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-4-train-a-policy-network">
     Video 4: Train a policy network
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#coding-exercise-4-implement-policynetwork">
     Coding Exercise 4: Implement
     <code class="docutils literal notranslate">
      <span class="pre">
       PolicyNetwork
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#train-the-policy-network">
       Train the policy network
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-5-use-a-trained-policy-network-to-play-games">
   Section 5: Use a trained policy network to play games
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-5-play-games-using-a-policy-network">
     Video 5: Play games using a policy network
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#coding-exercise-5-implement-the-policybasedplayer">
     Coding Exercise 5:
     <code class="docutils literal notranslate">
      <span class="pre">
       Implement
      </span>
      <span class="pre">
       the
      </span>
      <span class="pre">
       PolicyBasedPlayer
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-5-1-comparing-a-player-that-samples-from-the-action-probabilities-versus-the-policy-player-that-returns-the-maximum-probability">
     Section 5.1. Comparing a player that samples from the action probabilities versus the policy player that returns the maximum probability
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-5-2-compare-greedy-policy-based-player-versus-value-based-player">
     Section 5.2. Compare greedy policy based player versus value based player
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#section-5-3-compare-greedy-policy-based-player-versus-sample-based-policy-player">
     Section 5.3. Compare greedy policy based player versus sample-based policy player
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-6-plan-using-monte-carlo-rollouts">
   Section 6: Plan using Monte Carlo rollouts
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-6-play-using-monte-carlo-rollouts">
     Video 6: Play using Monte-Carlo rollouts
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#coding-exercise-6-montecarlo">
     Coding Exercise 6:
     <code class="docutils literal notranslate">
      <span class="pre">
       MonteCarlo
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-7-use-monte-carlo-simulations-to-play-games">
   Section 7: Use Monte Carlo simulations to play games
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-7-play-with-planning">
     Video 7: Play with planning
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#coding-exercise-7-monte-carlo-simulations">
     Coding Exercise 7: Monte-Carlo simulations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-8-plan-using-monte-carlo-tree-search">
   Section 8: Plan using Monte Carlo Tree Search
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-8-plan-with-mcts">
     Video 8: Plan with MCTS
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#coding-exercise-8-mcts-planner">
     Coding Exercise 8: MCTS planner
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-9-use-mcts-to-play-games">
   Section 9: Use MCTS to play games
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-9-play-with-mcts">
     Video 9: Play with MCTS
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#coding-exercise-9-agent-that-uses-an-mcts-planner">
     Coding Exercise 9: Agent that uses an MCTS planner
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#section-10-ethical-aspects">
   Section 10: Ethical aspects
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-10-unstoppable-opponents">
     Video 10: Unstoppable opponents
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#video-11-outro">
     Video 11: Outro
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><a href="https://colab.research.google.com/github/NeuromatchAcademy/course-content-dl/blob/main/tutorials/W3D3_ReinforcementLearningForGames/student/W3D3_Tutorial1.ipynb" target="_blank"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="section" id="tutorial-1-learn-to-play-games-with-rl">
<h1>Tutorial 1: Learn to play games with RL<a class="headerlink" href="#tutorial-1-learn-to-play-games-with-rl" title="Permalink to this headline">¶</a></h1>
<p><strong>Week 3, Day 3: Reinforcement Learning for Games</strong></p>
<p><strong>By Neuromatch Academy</strong></p>
<p><strong>Content creators:</strong> Mandana Samiei, Raymond Chua, Tim Lilicrap, Blake Richards</p>
<p><strong>Content reviewers:</strong> Arush Tagade, Lily Cheng, Melvin Selim Atay</p>
<p><strong>Content editors:</strong> Melvin Selim Atay, Spiros Chavlis</p>
<p><strong>Production editors:</strong> Namrata Bafna, Spiros Chavlis</p>
</div>
<hr class="docutils" />
<div class="section" id="tutorial-objectives">
<h1>Tutorial Objectives<a class="headerlink" href="#tutorial-objectives" title="Permalink to this headline">¶</a></h1>
<p>In this tutotial, you will learn how to implement a game loop and improve the performance of a random player.</p>
<p>The specific objectives for this tutorial:</p>
<ul class="simple">
<li><p>Understand the format of two-players games</p></li>
<li><p>Learn about value network and policy network</p></li>
<li><p>Learn about Monte Carlo Tree Search (MCTS) and compare its performance to policy-based and value-based players</p></li>
</ul>
<div class="section" id="video-0-introduction">
<h2>Video 0: Introduction<a class="headerlink" href="#video-0-introduction" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "f6281874636e40c1b14aaa92f48a4eb6"}
</script></div>
</div>
</div>
<div class="section" id="tutorial-slides">
<h2>Tutorial slides<a class="headerlink" href="#tutorial-slides" title="Permalink to this headline">¶</a></h2>
<p>These are the slides for the videos in the tutorial</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
<iframe
    width="854"
    height="480"
    src="https://mfr.ca-1.osf.io/render?url=https://osf.io/3zn9w/?direct%26mode=render%26action=download%26mode=render"
    frameborder="0"
    allowfullscreen
></iframe>
</div></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="setup">
<h1>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h1>
<p>In this section, we have:</p>
<ol class="simple">
<li><p><strong>Import cell</strong>: imports all libraries you use in the tutorial</p></li>
<li><p><strong>Hidden Figure settings cell</strong>: sets up the plotting style (copy exactly)</p></li>
<li><p><strong>Hidden Plotting functions cell</strong>: contains all functions used to create plots throughout the tutorial (so students don’t waste time looking at boilerplate matplotlib but can here if they wish to). Please use only matplotlib for plotting for consistency.</p></li>
<li><p><strong>Hidden Helper functions cell</strong>: This should contain functions that students have previously used or that are very simple. Any helper functions that are being used for the first time and are important should be placed directly above the relevant text or exercise (see Section 1.1 for an example)</p></li>
</ol>
<div class="section" id="download-the-modules">
<h2>Download the modules<a class="headerlink" href="#download-the-modules" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Download the modules</span>

<span class="c1"># @markdown Run this cell!</span>

<span class="c1"># @markdown Download from OSF. Original repo: https://github.com/raymondchua/nma_rl_games.git</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>

<span class="n">REPO_PATH</span> <span class="o">=</span> <span class="s2">&quot;nma_rl_games&quot;</span>
<span class="n">download_str</span> <span class="o">=</span> <span class="s2">&quot;Downloading&quot;</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">REPO_PATH</span><span class="p">):</span>
  <span class="n">download_str</span> <span class="o">=</span> <span class="s2">&quot;Redownloading&quot;</span>
  <span class="o">!</span>rm -rf <span class="nv">$REPO_PATH</span>

<span class="c1"># download from github repo directly</span>
<span class="c1">#!git clone git://github.com/raymondchua/nma_rl_games.git --quiet</span>

<span class="n">zipurl</span> <span class="o">=</span> <span class="s1">&#39;https://osf.io/kf4p9/download&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">download_str</span><span class="si">}</span><span class="s2"> and unzipping the file... Please wait.&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">zipurl</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipresp</span><span class="p">:</span>
  <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">zipresp</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span> <span class="k">as</span> <span class="n">zfile</span><span class="p">:</span>
    <span class="n">zfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Download completed!&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nma_rl_games/alpha-zero&#39;</span><span class="p">)</span>

<span class="c1"># @markdown Import modules designed for use in this notebook</span>
<span class="kn">import</span> <span class="nn">Arena</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Game</span> <span class="kn">import</span> <span class="n">Game</span>
<span class="kn">from</span> <span class="nn">MCTS</span> <span class="kn">import</span> <span class="n">MCTS</span>
<span class="kn">from</span> <span class="nn">NeuralNet</span> <span class="kn">import</span> <span class="n">NeuralNet</span>

<span class="kn">from</span> <span class="nn">othello.OthelloPlayers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">othello.OthelloLogic</span> <span class="kn">import</span> <span class="n">Board</span>
<span class="kn">from</span> <span class="nn">othello.OthelloGame</span> <span class="kn">import</span> <span class="n">OthelloGame</span>
<span class="kn">from</span> <span class="nn">othello.pytorch.NNet</span> <span class="kn">import</span> <span class="n">NNetWrapper</span> <span class="k">as</span> <span class="n">NNet</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading and unzipping the file... Please wait.
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">2</span><span class="n">d2a13b459bb</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">download_str</span><span class="si">}</span><span class="s2"> and unzipping the file... Please wait.&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span> <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">zipurl</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipresp</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">24</span>   <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">zipresp</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span> <span class="k">as</span> <span class="n">zfile</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="n">zfile</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Download completed!&quot;</span><span class="p">)</span>

<span class="nn">~/anaconda3/lib/python3.8/http/client.py</span> in <span class="ni">read</span><span class="nt">(self, amt)</span>
<span class="g g-Whitespace">    </span><span class="mi">469</span>             <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">470</span>                 <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">471</span>                     <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">472</span>                 <span class="k">except</span> <span class="n">IncompleteRead</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">473</span>                     <span class="bp">self</span><span class="o">.</span><span class="n">_close_conn</span><span class="p">()</span>

<span class="nn">~/anaconda3/lib/python3.8/http/client.py</span> in <span class="ni">_safe_read</span><span class="nt">(self, amt)</span>
<span class="g g-Whitespace">    </span><span class="mi">610</span>         <span class="n">IncompleteRead</span> <span class="n">exception</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">detect</span> <span class="n">the</span> <span class="n">problem</span><span class="o">.</span>
<span class="g g-Whitespace">    </span><span class="mi">611</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">612</span><span class="s2">         data = self.fp.read(amt)</span>
<span class="g g-Whitespace">    </span><span class="mi">613</span><span class="s2">         if len(data) &lt; amt:</span>
<span class="g g-Whitespace">    </span><span class="mi">614</span><span class="s2">             raise IncompleteRead(data, amt-len(data))</span>

<span class="nn">~/anaconda3/lib/python3.8/socket.py</span> in <span class="ni">readinto</span><span class="nt">(self, b)</span>
<span class="g g-Whitespace">    </span><span class="mi">667</span><span class="s2">         while True:</span>
<span class="g g-Whitespace">    </span><span class="mi">668</span><span class="s2">             try:</span>
<span class="ne">--&gt; </span><span class="mi">669</span><span class="s2">                 return self._sock.recv_into(b)</span>
<span class="g g-Whitespace">    </span><span class="mi">670</span><span class="s2">             except timeout:</span>
<span class="g g-Whitespace">    </span><span class="mi">671</span><span class="s2">                 self._timeout_occurred = True</span>

<span class="nn">~/anaconda3/lib/python3.8/ssl.py</span> in <span class="ni">recv_into</span><span class="nt">(self, buffer, nbytes, flags)</span>
<span class="g g-Whitespace">   </span><span class="mi">1239</span><span class="s2">                   &quot;non-zero flags not allowed in calls to recv_into() on </span><span class="si">%s</span><span class="s2">&quot; %</span>
<span class="g g-Whitespace">   </span><span class="mi">1240</span><span class="s2">                   self.__class__)</span>
<span class="ne">-&gt; </span><span class="mi">1241</span><span class="s2">             return self.read(nbytes, buffer)</span>
<span class="g g-Whitespace">   </span><span class="mi">1242</span><span class="s2">         else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1243</span><span class="s2">             return super().recv_into(buffer, nbytes, flags)</span>

<span class="nn">~/anaconda3/lib/python3.8/ssl.py</span> in <span class="ni">read</span><span class="nt">(self, len, buffer)</span>
<span class="g g-Whitespace">   </span><span class="mi">1097</span><span class="s2">         try:</span>
<span class="g g-Whitespace">   </span><span class="mi">1098</span><span class="s2">             if buffer is not None:</span>
<span class="ne">-&gt; </span><span class="mi">1099</span><span class="s2">                 return self._sslobj.read(len, buffer)</span>
<span class="g g-Whitespace">   </span><span class="mi">1100</span><span class="s2">             else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1101</span><span class="s2">                 return self._sslobj.read(len)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="install-dependencies">
<h2>Install dependencies<a class="headerlink" href="#install-dependencies" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Install dependencies</span>
<span class="o">!</span>pip install coloredlogs --quiet
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">coloredlogs</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>


<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Pickler</span><span class="p">,</span> <span class="n">Unpickler</span>

<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Pickler</span><span class="p">,</span> <span class="n">Unpickler</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">coloredlogs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>  <span class="c1"># Change this to DEBUG to see more info.</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-random-seed">
<h2>Set random seed<a class="headerlink" href="#set-random-seed" title="Permalink to this headline">¶</a></h2>
<p>Executing <code class="docutils literal notranslate"><span class="pre">set_seed(seed=seed)</span></code> you are setting the seed</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Set random seed</span>

<span class="c1"># @markdown Executing `set_seed(seed=seed)` you are setting the seed</span>

<span class="c1"># for DL its critical to set the random seed so that students can have a</span>
<span class="c1"># baseline to compare their results to expected results.</span>
<span class="c1"># Read more here: https://pytorch.org/docs/stable/notes/randomness.html</span>

<span class="c1"># Call `set_seed` function in the exercises to ensure reproducibility.</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed_torch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span><span class="p">)</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">seed_torch</span><span class="p">:</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>

  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Random seed </span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s1"> has been set.&#39;</span><span class="p">)</span>


<span class="c1"># In case that `DataLoader` is used</span>
<span class="k">def</span> <span class="nf">seed_worker</span><span class="p">(</span><span class="n">worker_id</span><span class="p">):</span>
  <span class="n">worker_seed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">initial_seed</span><span class="p">()</span> <span class="o">%</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>
  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">worker_seed</span><span class="p">)</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">worker_seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-device-gpu-or-cpu-execute-set-device">
<h2>Set device (GPU or CPU). Execute <code class="docutils literal notranslate"><span class="pre">set_device()</span></code><a class="headerlink" href="#set-device-gpu-or-cpu-execute-set-device" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Set device (GPU or CPU). Execute `set_device()`</span>
<span class="c1"># especially if torch modules used.</span>

<span class="c1"># inform the user if the notebook uses GPU or CPU.</span>

<span class="k">def</span> <span class="nf">set_device</span><span class="p">():</span>
  <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
  <span class="k">if</span> <span class="n">device</span> <span class="o">!=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: For this notebook to perform best, &quot;</span>
        <span class="s2">&quot;if possible, in the menu under `Runtime` -&gt; &quot;</span>
        <span class="s2">&quot;`Change runtime type.`  select `GPU` &quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU is enabled in this notebook.&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">device</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SEED</span> <span class="o">=</span> <span class="mi">2021</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">set_device</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">({</span>
    <span class="s1">&#39;numIters&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>            <span class="c1"># in training setting this was 1000 and num of episodes=100</span>
    <span class="s1">&#39;numEps&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>              <span class="c1"># Number of complete self-play games to simulate during a new iteration.</span>
    <span class="s1">&#39;tempThreshold&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>      <span class="c1"># To control exploration and exploitation</span>
    <span class="s1">&#39;updateThreshold&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>   <span class="c1"># During arena playoff, new neural net will be accepted if threshold or more of games are won.</span>
    <span class="s1">&#39;maxlenOfQueue&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>     <span class="c1"># Number of game examples to train the neural networks.</span>
    <span class="s1">&#39;numMCTSSims&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>        <span class="c1"># Number of games moves for MCTS to simulate.</span>
    <span class="s1">&#39;arenaCompare&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>       <span class="c1"># Number of games to play during arena play to determine if new net will be accepted.</span>
    <span class="s1">&#39;cpuct&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;maxDepth&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>             <span class="c1"># Maximum number of rollouts</span>
    <span class="s1">&#39;numMCsims&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>           <span class="c1"># Number of monte carlo simulations</span>
    <span class="s1">&#39;mc_topk&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>             <span class="c1"># top k actions for monte carlo rollout</span>

    <span class="s1">&#39;checkpoint&#39;</span><span class="p">:</span> <span class="s1">&#39;./temp/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;load_model&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;load_folder_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;/dev/models/8x100x50&#39;</span><span class="p">,</span><span class="s1">&#39;best.pth.tar&#39;</span><span class="p">),</span>
    <span class="s1">&#39;numItersForTrainExamplesHistory&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>

    <span class="c1"># define neural network arguments</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>               <span class="c1"># lr: learning rate</span>
    <span class="s1">&#39;dropout&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
    <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
    <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="n">DEVICE</span><span class="p">,</span>
    <span class="s1">&#39;num_channels&#39;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-1-create-a-game-agent-loop-for-rl">
<h1>Section 1: Create a game/agent loop for RL<a class="headerlink" href="#section-1-create-a-game-agent-loop-for-rl" title="Permalink to this headline">¶</a></h1>
<div class="section" id="video-1-a-game-loop-for-rl">
<h2>Video 1: A game loop for RL<a class="headerlink" href="#video-1-a-game-loop-for-rl" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
<p><em><strong>Goal</strong></em>: How to setup a game environment with multiple players for reinforcement learning experiments.</p>
<p><em><strong>Exercise</strong></em>:</p>
<ul class="simple">
<li><p>Build an agent that plays random moves</p></li>
<li><p>Connect with connect 4 game</p></li>
<li><p>Generate games including wins and losses</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OthelloGame</span><span class="p">(</span><span class="n">Game</span><span class="p">):</span>
  <span class="n">square_content</span> <span class="o">=</span> <span class="p">{</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
      <span class="o">+</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
      <span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span>
      <span class="p">}</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">getSquarePiece</span><span class="p">(</span><span class="n">piece</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">OthelloGame</span><span class="o">.</span><span class="n">square_content</span><span class="p">[</span><span class="n">piece</span><span class="p">]</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>

  <span class="k">def</span> <span class="nf">getInitBoard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># return initial board (numpy board)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Board</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">pieces</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">getBoardSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># (a,b) tuple</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">getActionSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># return number of actions, n is the board size and +1 is for no-op action</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">getNextState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="c1"># if player takes action on board, return next (board,player)</span>
    <span class="c1"># action must be a valid move</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="o">-</span><span class="n">player</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Board</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">pieces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="n">move</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">action</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">),</span> <span class="n">action</span><span class="o">%</span><span class="k">self</span>.n)
    <span class="n">b</span><span class="o">.</span><span class="n">execute_move</span><span class="p">(</span><span class="n">move</span><span class="p">,</span> <span class="n">player</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">pieces</span><span class="p">,</span> <span class="o">-</span><span class="n">player</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">getValidMoves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">player</span><span class="p">):</span>
    <span class="c1"># return a fixed size binary vector</span>
    <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Board</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">pieces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="n">legalMoves</span> <span class="o">=</span>  <span class="n">b</span><span class="o">.</span><span class="n">get_legal_moves</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">legalMoves</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
      <span class="n">valids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">legalMoves</span><span class="p">:</span>
      <span class="n">valids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valids</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">getGameEnded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">player</span><span class="p">):</span>
    <span class="c1"># return 0 if not ended, 1 if player 1 won, -1 if player 1 lost</span>
    <span class="c1"># player = 1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Board</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">pieces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">has_legal_moves</span><span class="p">(</span><span class="n">player</span><span class="p">):</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">has_legal_moves</span><span class="p">(</span><span class="o">-</span><span class="n">player</span><span class="p">):</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">countDiff</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

  <span class="k">def</span> <span class="nf">getCanonicalForm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">player</span><span class="p">):</span>
    <span class="c1"># return state if player==1, else return -state if player==-1</span>
    <span class="k">return</span> <span class="n">player</span><span class="o">*</span><span class="n">board</span>

  <span class="k">def</span> <span class="nf">getSymmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">pi</span><span class="p">):</span>
    <span class="c1"># mirror, rotational</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 1 for pass</span>
    <span class="n">pi_board</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
        <span class="n">newB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">newPi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">pi_board</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span><span class="p">:</span>
          <span class="n">newB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">newB</span><span class="p">)</span>
          <span class="n">newPi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">newPi</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">newB</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">newPi</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="n">pi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])]</span>
    <span class="k">return</span> <span class="n">l</span>

  <span class="k">def</span> <span class="nf">stringRepresentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">board</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">stringRepresentationReadable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
    <span class="n">board_s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">square_content</span><span class="p">[</span><span class="n">square</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">board</span> <span class="k">for</span> <span class="n">square</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">board_s</span>

  <span class="k">def</span> <span class="nf">getScore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">player</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Board</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">pieces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">countDiff</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>    <span class="c1"># print the row #</span>
      <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piece</span> <span class="o">=</span> <span class="n">board</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>    <span class="c1"># get the piece to print</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">OthelloGame</span><span class="o">.</span><span class="n">square_content</span><span class="p">[</span><span class="n">piece</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="section-1-1-create-a-random-player">
<h2>Section 1.1: Create a random player<a class="headerlink" href="#section-1-1-create-a-random-player" title="Permalink to this headline">¶</a></h2>
<div class="section" id="coding-exercise-1-1-implement-a-random-player">
<h3>Coding Exercise 1.1: Implement a random player<a class="headerlink" href="#coding-exercise-1-1-implement-a-random-player" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RandomPlayer</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">game</span>

  <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>

    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students: ##</span>
    <span class="c1">## 1. Please compute the valid moves using getValidMoves(). ##</span>
    <span class="c1">## 2. Compute the probability over actions.##</span>
    <span class="c1">## 3. Pick a random action based on the probability computed above.##</span>
    <span class="c1"># Fill out function and remove ##</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Implement the random player&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>

    <span class="n">valids</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">a</span> <span class="o">=</span> <span class="o">...</span>

    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_72142174.py"><em>Click for solution</em></a></p>
</div>
</div>
<div class="section" id="section-1-2-initiate-the-game-board">
<h2>Section 1.2. Initiate the game board<a class="headerlink" href="#section-1-2-initiate-the-game-board" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display the board</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">board</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">getInitBoard</span><span class="p">()</span>
<span class="n">game</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># observe the game board size</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Board size = </span><span class="si">{</span><span class="n">game</span><span class="o">.</span><span class="n">getBoardSize</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># observe the action size</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Action size = </span><span class="si">{</span><span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="section-1-3-create-two-random-agents-to-play-against-each-other">
<h2>Section 1.3. Create two random agents to play against each other<a class="headerlink" href="#section-1-3-create-two-random-agents-to-play-against-each-other" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the random player</span>
<span class="n">player1</span> <span class="o">=</span> <span class="n">RandomPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>  <span class="c1"># player 1 is a random player</span>
<span class="n">player2</span> <span class="o">=</span> <span class="n">RandomPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>  <span class="c1"># player 2 is a random player</span>

<span class="c1"># define number of games</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># start the competition</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">Arena</span><span class="o">.</span><span class="n">Arena</span><span class="p">(</span><span class="n">player1</span><span class="p">,</span> <span class="n">player2</span> <span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># to see the steps of the competition set &quot;display=OthelloGame.display&quot;</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="n">playGames</span><span class="p">(</span><span class="n">num_games</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># return  ( number of games won by player1, num of games won by player2, num of games won by nobody)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section-1-4-compute-win-rate-for-the-random-player-player-1">
<h2>Section 1.4. Compute win rate for the random player (player 1)<a class="headerlink" href="#section-1-4-compute-win-rate-for-the-random-player-player-1" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of games won by player1 = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;Number of games won by player2 = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">num_games</span><span class="si">}</span><span class="s2"> games&quot;</span><span class="p">)</span>
<span class="n">win_rate_player1</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">num_games</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Win rate for player1 over 20 games: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">win_rate_player1</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player1</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player2</span> <span class="o">=</span> <span class="mi">9</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">20</span> <span class="n">games</span>

<span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">55.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-2-train-a-value-function-from-expert-game-data">
<h1>Section 2: Train a value function from expert game data<a class="headerlink" href="#section-2-train-a-value-function-from-expert-game-data" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal:</strong> Learn how to train a value function from a dataset of games played by an expert.</p>
<p><strong>Exercise:</strong></p>
<ul class="simple">
<li><p>Load a dataset of expert generated games.</p></li>
<li><p>Train a network to minimize MSE for win/loss predictions given board states sampled throughout the game. This will be done on a very small number of games. We will provide a network trained on a larger dataset.</p></li>
</ul>
<div class="section" id="video-2-train-a-value-function">
<h2>Video 2: Train a value function<a class="headerlink" href="#video-2-train-a-value-function" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="section-2-1-load-expert-data">
<h2>Section 2.1. Load expert data<a class="headerlink" href="#section-2-1-load-expert-data" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">loadTrainExamples</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
  <span class="n">trainExamplesHistory</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">modelFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
  <span class="n">examplesFile</span> <span class="o">=</span> <span class="n">modelFile</span> <span class="o">+</span> <span class="s2">&quot;.examples&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">examplesFile</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File &quot;</span><span class="si">{</span><span class="n">examplesFile</span><span class="si">}</span><span class="s1">&quot; with trainExamples not found!&#39;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Continue? [y|n]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File with train examples found. Loading it...&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">examplesFile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">trainExamplesHistory</span> <span class="o">=</span> <span class="n">Unpickler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading done!&#39;</span><span class="p">)</span>
    <span class="c1"># examples based on the model were already collected (loaded)</span>
    <span class="k">return</span> <span class="n">trainExamplesHistory</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;/content/nma_rl_games/alpha-zero/pretrained_models/data/&quot;</span>
<span class="n">loaded_games</span> <span class="o">=</span> <span class="n">loadTrainExamples</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;checkpoint_1.pth.tar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="section-2-2-define-the-neural-network-architecture-for-othello">
<h2>Section 2.2. Define the Neural Network Architecture for Othello<a class="headerlink" href="#section-2-2-define-the-neural-network-architecture-for-othello" title="Permalink to this headline">¶</a></h2>
<div class="section" id="coding-exercise-2-2-implement-the-nn-othellonnet-for-othello">
<h3>Coding Exercise 2.2: Implement the NN <code class="docutils literal notranslate"><span class="pre">OthelloNNet</span></code> for Othello<a class="headerlink" href="#coding-exercise-2-2-implement-the-nn-othellonnet-for-othello" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OthelloNNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="c1"># game params</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">board_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_y</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">getBoardSize</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">action_size</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">OthelloNNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bn4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board_x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board_y</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fc_bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fc_bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_size</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">fc4</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="c1"># s: batch_size x board_x x board_y</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_y</span><span class="p">)</span>                <span class="c1"># batch_size x 1 x board_x x board_y</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>                          <span class="c1"># batch_size x num_channels x board_x x board_y</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>                          <span class="c1"># batch_size x num_channels x board_x x board_y</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>                          <span class="c1"># batch_size x num_channels x (board_x-2) x (board_y-2)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv4</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>                          <span class="c1"># batch_size x num_channels x (board_x-4) x (board_y-4)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board_x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board_y</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_bn1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">s</span><span class="p">))),</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">)</span>  <span class="c1"># batch_size x 1024</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_bn2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">s</span><span class="p">))),</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">)</span>  <span class="c1"># batch_size x 512</span>

    <span class="n">pi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># batch_size x action_size</span>
    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc4</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>   <span class="c1"># batch_size x 1</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students: Please compute a probability distribution over &#39;pi&#39; using log softmax (for numerical stability)</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Calculate the probability distribution and the value&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="c1"># return a probability distribution over actions at the current state and the value of the current state.</span>
    <span class="k">return</span> <span class="o">...</span><span class="p">,</span> <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_6639b79e.py"><em>Click for solution</em></a></p>
</div>
</div>
<div class="section" id="section-2-3-define-the-value-network">
<h2>Section 2.3. Define the Value network<a class="headerlink" href="#section-2-3-define-the-value-network" title="Permalink to this headline">¶</a></h2>
<p>During the training the ground truth will be uploaded from the <strong>MCTS simulations</strong> available at ‘checkpoint_x.path.tar.examples’.</p>
<div class="section" id="coding-exercise-2-3-implement-the-valuenetwork">
<h3>Coding Exercise 2.3: Implement the <code class="docutils literal notranslate"><span class="pre">ValueNetwork</span></code><a class="headerlink" href="#coding-exercise-2-3-implement-the-valuenetwork" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ValueNetwork</span><span class="p">(</span><span class="n">NeuralNet</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span> <span class="o">=</span> <span class="n">OthelloNNet</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">board_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_y</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">getBoardSize</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">action_size</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">games</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    examples: list of examples, each example is of form (board, pi, v)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">examples</span> <span class="ow">in</span> <span class="n">games</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EPOCH ::: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">v_losses</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># to store the losses per epoch</span>
        <span class="n">batch_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>  <span class="c1"># len(examples)=200, batch-size=64, batch_count=3</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">batch_count</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Training Value Network&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
          <span class="n">sample_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>  <span class="c1"># read the ground truth information from MCTS simulation using the loaded examples</span>
          <span class="n">boards</span><span class="p">,</span> <span class="n">pis</span><span class="p">,</span> <span class="n">vs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">examples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sample_ids</span><span class="p">]))</span>  <span class="c1"># length of boards, pis, vis = 64</span>
          <span class="n">boards</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boards</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
          <span class="n">target_vs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>

          <span class="c1"># predict</span>
          <span class="n">boards</span><span class="p">,</span> <span class="n">target_vs</span> <span class="o">=</span> <span class="n">boards</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">target_vs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

          <span class="c1">#################################################</span>
          <span class="c1">## TODO for students:</span>
          <span class="c1">## 1. Compute the value predicted by OthelloNNet() ##</span>
          <span class="c1">## 2. First implement the loss_v() function below and then use it to update the value loss. ##</span>
          <span class="c1"># Fill out function and remove</span>
          <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Compute the output&quot;</span><span class="p">)</span>
          <span class="c1">#################################################</span>
          <span class="c1"># compute output</span>
          <span class="n">_</span><span class="p">,</span> <span class="n">out_v</span> <span class="o">=</span> <span class="o">...</span>
          <span class="n">l_v</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># total loss</span>

          <span class="c1"># record loss</span>
          <span class="n">v_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_v</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
          <span class="n">t</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">Loss_v</span><span class="o">=</span><span class="n">l_v</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

          <span class="c1"># compute gradient and do SGD step</span>
          <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
          <span class="n">l_v</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
          <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    board: np array with board</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># timing</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># preparing input</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">loss_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students: Please compute Mean squared error and return as output. ##</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Calculate the loss&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="c1"># Mean squared error (MSE)</span>
    <span class="k">return</span> <span class="o">...</span>

  <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;checkpoint.pth.tar&#39;</span><span class="p">):</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checkpoint Directory does not exist! Making directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
      <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checkpoint Directory exists! &quot;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span><span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),},</span> <span class="n">filepath</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model saved! &quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;checkpoint.pth.tar&#39;</span><span class="p">):</span>
    <span class="c1"># https://github.com/pytorch/examples/blob/master/imagenet/main.py#L98</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
      <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;No model in path </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>

    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_df8a4fe0.py"><em>Click for solution</em></a></p>
</div>
</div>
<div class="section" id="section-2-4-train-the-value-network-and-observe-the-mse-loss-progress">
<h2>Section 2.4. Train the value network and observe the MSE loss progress<a class="headerlink" href="#section-2-4-train-the-value-network-and-observe-the-mse-loss-progress" title="Permalink to this headline">¶</a></h2>
<p>Only run this cell if you do not have access to the pretrained models in the rl_for_games repositry.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">vnet</span> <span class="o">=</span> <span class="n">ValueNetwork</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="n">vnet</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">loaded_games</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-3-use-a-trained-value-network-to-play-games">
<h1>Section 3: Use a trained value network to play games<a class="headerlink" href="#section-3-use-a-trained-value-network-to-play-games" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal</strong>: Learn how to use a value function in order to make a player that works better than a random player.</p>
<p><strong>Exercise:</strong></p>
<ul class="simple">
<li><p>Sample random valid moves and use the value function to rank them</p></li>
<li><p>Choose the best move as the action and play it
Show that doing so beats the random player</p></li>
</ul>
<p><strong>Hint:</strong> You might need to change the sign of the value based on the player</p>
<div class="section" id="video-3-play-games-using-a-value-function">
<h2>Video 3: Play games using a value function<a class="headerlink" href="#video-3-play-games-using-a-value-function" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-3-value-based-player">
<h2>Coding Exercise 3: Value-based player<a class="headerlink" href="#coding-exercise-3-value-based-player" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_save_name</span> <span class="o">=</span> <span class="s1">&#39;ValueNetwork.pth.tar&#39;</span>
<span class="n">path</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;/content/nma_rl_games/alpha-zero/pretrained_models/models/&quot;</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">vnet</span> <span class="o">=</span> <span class="n">ValueNetwork</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="n">vnet</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">model_save_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ValueBasedPlayer</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">vnet</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">game</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vnet</span> <span class="o">=</span> <span class="n">vnet</span>

  <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
    <span class="n">valids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getValidMoves</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_num_actions</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">va_list</span> <span class="o">=</span> <span class="n">va</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">shuffle</span><span class="p">(</span><span class="n">va_list</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students: In the first part, please return the next board state using getNextState(), then predict ##</span>
    <span class="c1">## the value of next state using value network, and finally add the value and action as a tuple to the candidate list. ##</span>
    <span class="c1">## Note that you need to reverse the sign of the value. Since we are in a 2-player game regime, in zero-sum games</span>
    <span class="c1">## the players flip every turn. ##</span>
    <span class="c1">## and the one returned from the network is computed for the current player but the next one to play is the opponent! ##</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Implement the value-based player&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">va_list</span><span class="p">:</span>
      <span class="n">nextBoard</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="o">...</span>
      <span class="n">value</span> <span class="o">=</span> <span class="o">...</span>
      <span class="n">candidates</span> <span class="o">+=</span> <span class="o">...</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_num_actions</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">candidates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>


<span class="c1"># playing games between a value-based player and a random player</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">player1</span> <span class="o">=</span> <span class="n">ValueBasedPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">vnet</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">player2</span> <span class="o">=</span> <span class="n">RandomPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">Arena</span><span class="o">.</span><span class="n">Arena</span><span class="p">(</span><span class="n">player1</span><span class="p">,</span> <span class="n">player2</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">OthelloGame</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
<span class="c1">## Uncomment the code below to check your code!</span>
<span class="c1"># result = arena.playGames(num_games, verbose=False)</span>
<span class="c1"># print(f&quot;\n\n{result}&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_5e948309.py"><em>Click for solution</em></a></p>
<p><strong>Result of pitting a value-based player against a random player</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of games won by player1 = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;Number of games won by player2 = </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, out of </span><span class="si">{</span><span class="n">num_games</span><span class="si">}</span><span class="s2"> games&quot;</span><span class="p">)</span>
<span class="n">win_rate_player1</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">num_games</span> <span class="c1"># result[0] is the number of times that player 1 wins</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Win rate for player1 over </span><span class="si">{</span><span class="n">num_games</span><span class="si">}</span><span class="s2"> games: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">win_rate_player1</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player1</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player2</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">20</span> <span class="n">games</span>

<span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">55.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-4-train-a-policy-network-from-expert-game-data">
<h1>Section 4: Train a policy network from expert game data<a class="headerlink" href="#section-4-train-a-policy-network-from-expert-game-data" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal</strong>: How to train a policy network via supervised learning / behavioural cloning.</p>
<p><strong>Exercise</strong>:</p>
<ul class="simple">
<li><p>Train a network to predict the next move in an expert dataset by maximizing the log likelihood of the next action.</p></li>
</ul>
<div class="section" id="video-4-train-a-policy-network">
<h2>Video 4: Train a policy network<a class="headerlink" href="#video-4-train-a-policy-network" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-4-implement-policynetwork">
<h2>Coding Exercise 4: Implement <code class="docutils literal notranslate"><span class="pre">PolicyNetwork</span></code><a class="headerlink" href="#coding-exercise-4-implement-policynetwork" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PolicyNetwork</span><span class="p">(</span><span class="n">NeuralNet</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span> <span class="o">=</span> <span class="n">OthelloNNet</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">board_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_y</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">getBoardSize</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">action_size</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">games</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    examples: list of examples, each example is of form (board, pi, v)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">examples</span> <span class="ow">in</span> <span class="n">games</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EPOCH ::: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">pi_losses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">batch_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">batch_count</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Training Policy Network&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
          <span class="n">sample_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
          <span class="n">boards</span><span class="p">,</span> <span class="n">pis</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">examples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sample_ids</span><span class="p">]))</span>
          <span class="n">boards</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">boards</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
          <span class="n">target_pis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pis</span><span class="p">))</span>

          <span class="c1"># predict</span>
          <span class="n">boards</span><span class="p">,</span> <span class="n">target_pis</span> <span class="o">=</span> <span class="n">boards</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">target_pis</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

          <span class="c1">#################################################</span>
          <span class="c1">## TODO for students: ##</span>
          <span class="c1">## 1. Compute the policy (pi) predicted by OthelloNNet() ##</span>
          <span class="c1">## 2. Implement the loss_pi() function below and then use it to update the policy loss. ##</span>
          <span class="c1"># Fill out function and remove</span>
          <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Compute the output&quot;</span><span class="p">)</span>
          <span class="c1">#################################################</span>
          <span class="c1"># compute output</span>
          <span class="n">out_pi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="o">...</span>
          <span class="n">l_pi</span> <span class="o">=</span> <span class="o">...</span>

          <span class="c1"># record loss</span>
          <span class="n">pi_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l_pi</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
          <span class="n">t</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">Loss_pi</span><span class="o">=</span><span class="n">l_pi</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

          <span class="c1"># compute gradient and do SGD step</span>
          <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
          <span class="n">l_pi</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
          <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    board: np array with board</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># timing</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># preparing input</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">board</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
      <span class="n">pi</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">loss_pi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students: To implement the loss function, please compute and return the negative log likelihood of targets. ##</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Compute the loss&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="k">return</span> <span class="o">...</span>

  <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;checkpoint.pth.tar&#39;</span><span class="p">):</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checkpoint Directory does not exist! Making directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
      <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checkpoint Directory exists! &quot;</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span><span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),},</span> <span class="n">filepath</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model saved! &quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;checkpoint.pth.tar&#39;</span><span class="p">):</span>
    <span class="c1"># https://github.com/pytorch/examples/blob/master/imagenet/main.py#L98</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
      <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;No model in path </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>

    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>


<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="c1">## we use the same actor-critic network to output a policy</span>
<span class="c1"># pnet = PolicyNetwork(game)</span>
<span class="c1"># pnet.train(loaded_games)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_d4081c2d.py"><em>Click for solution</em></a></p>
<div class="section" id="train-the-policy-network">
<h3>Train the policy network<a class="headerlink" href="#train-the-policy-network" title="Permalink to this headline">¶</a></h3>
<p>Only run this cell if you do not have access to the pretrained models in the rl_for_games repositry..</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">pnet</span> <span class="o">=</span> <span class="n">PolicyNetwork</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="n">pnet</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">loaded_games</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-5-use-a-trained-policy-network-to-play-games">
<h1>Section 5: Use a trained policy network to play games<a class="headerlink" href="#section-5-use-a-trained-policy-network-to-play-games" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal</strong>: How to use a policy network to play games.</p>
<p><strong>Exercise:</strong></p>
<ul class="simple">
<li><p>Use the policy network to give probabilities for the next move.</p></li>
<li><p>Build a player that takes the move given the maximum probability by the network.</p></li>
<li><p>Compare this to another player that samples moves according to the probability distribution output by the network.</p></li>
</ul>
<div class="section" id="video-5-play-games-using-a-policy-network">
<h2>Video 5: Play games using a policy network<a class="headerlink" href="#video-5-play-games-using-a-policy-network" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-5-implement-the-policybasedplayer">
<h2>Coding Exercise 5: <code class="docutils literal notranslate"><span class="pre">Implement</span> <span class="pre">the</span> <span class="pre">PolicyBasedPlayer</span></code><a class="headerlink" href="#coding-exercise-5-implement-the-policybasedplayer" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_save_name</span> <span class="o">=</span> <span class="s1">&#39;PolicyNetwork.pth.tar&#39;</span>
<span class="n">path</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;/content/nma_rl_games/alpha-zero/pretrained_models/models/&quot;</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">pnet</span> <span class="o">=</span> <span class="n">PolicyNetwork</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
<span class="n">pnet</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">model_save_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PolicyBasedPlayer</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">pnet</span><span class="p">,</span> <span class="n">greedy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">game</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pnet</span> <span class="o">=</span> <span class="n">pnet</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span> <span class="o">=</span> <span class="n">greedy</span>

  <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">):</span>
    <span class="n">valids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getValidMoves</span><span class="p">(</span><span class="n">board</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students:  ##</span>
    <span class="c1">## 1. Compute the action probabilities using policy network pnet()</span>
    <span class="c1">## 2. Mask invalid moves using valids variable and the action probabilites computed above.</span>
    <span class="c1">## 3. Compute the sum over valid actions and store them in sum_vap.</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Define the play&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="n">action_probs</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">vap</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># masking invalid moves</span>
    <span class="n">sum_vap</span> <span class="o">=</span> <span class="o">...</span>

    <span class="k">if</span> <span class="n">sum_vap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">vap</span> <span class="o">/=</span> <span class="n">sum_vap</span>  <span class="c1"># renormalize</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># if all valid moves were masked we make all valid moves equally probable</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All valid moves were masked, doing a workaround.&quot;</span><span class="p">)</span>
      <span class="n">vap</span> <span class="o">=</span> <span class="n">vap</span> <span class="o">+</span> <span class="n">valids</span>
      <span class="n">vap</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vap</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">greedy</span><span class="p">:</span>
      <span class="c1"># greedy policy player</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">vap</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vap</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># sample-based policy player</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">(),</span> <span class="n">p</span><span class="o">=</span><span class="n">vap</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span>


<span class="c1"># playing games</span>
<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">player1</span> <span class="o">=</span> <span class="n">PolicyBasedPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">pnet</span><span class="p">,</span> <span class="n">greedy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">player2</span> <span class="o">=</span> <span class="n">RandomPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">Arena</span><span class="o">.</span><span class="n">Arena</span><span class="p">(</span><span class="n">player1</span><span class="p">,</span> <span class="n">player2</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">OthelloGame</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
<span class="c1">## Uncomment below to test!</span>
<span class="c1"># result = arena.playGames(num_games, verbose=False)</span>
<span class="c1"># print(f&quot;\n\n{result}&quot;)</span>
<span class="c1"># print(f&quot;\nWin rate for player1 over {num_games} games: {round(win_rate_player1*100, 1)}%&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_83adff8a.py"><em>Click for solution</em></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">80.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
<div class="section" id="section-5-1-comparing-a-player-that-samples-from-the-action-probabilities-versus-the-policy-player-that-returns-the-maximum-probability">
<h2>Section 5.1. Comparing a player that samples from the action probabilities versus the policy player that returns the maximum probability<a class="headerlink" href="#section-5-1-comparing-a-player-that-samples-from-the-action-probabilities-versus-the-policy-player-that-returns-the-maximum-probability" title="Permalink to this headline">¶</a></h2>
<p>There’s often randomness in the results as we are running the players for a low number of games (only 20 games due compute+time costs). So, when students are running the cells they might not get the expected result. To better measure the strength of players you can run more games!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">player1</span> <span class="o">=</span> <span class="n">PolicyBasedPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">pnet</span><span class="p">,</span> <span class="n">greedy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">player2</span> <span class="o">=</span> <span class="n">RandomPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">Arena</span><span class="o">.</span><span class="n">Arena</span><span class="p">(</span><span class="n">player1</span><span class="p">,</span> <span class="n">player2</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">OthelloGame</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="n">playGames</span><span class="p">(</span><span class="n">num_games</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">win_rate_player1</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">num_games</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win rate for player1 over </span><span class="si">{</span><span class="n">num_games</span><span class="si">}</span><span class="s2"> games: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">win_rate_player1</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">95.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
<div class="section" id="section-5-2-compare-greedy-policy-based-player-versus-value-based-player">
<h2>Section 5.2. Compare greedy policy based player versus value based player<a class="headerlink" href="#section-5-2-compare-greedy-policy-based-player-versus-value-based-player" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">player1</span> <span class="o">=</span> <span class="n">PolicyBasedPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">pnet</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">player2</span> <span class="o">=</span> <span class="n">ValueBasedPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">vnet</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">Arena</span><span class="o">.</span><span class="n">Arena</span><span class="p">(</span><span class="n">player1</span><span class="p">,</span> <span class="n">player2</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">OthelloGame</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="n">playGames</span><span class="p">(</span><span class="n">num_games</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">win_rate_player1</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">num_games</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win rate for player 1 over </span><span class="si">{</span><span class="n">num_games</span><span class="si">}</span><span class="s2"> games: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">win_rate_player1</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player</span> <span class="mi">1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">50.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
<div class="section" id="section-5-3-compare-greedy-policy-based-player-versus-sample-based-policy-player">
<h2>Section 5.3. Compare greedy policy based player versus sample-based policy player<a class="headerlink" href="#section-5-3-compare-greedy-policy-based-player-versus-sample-based-policy-player" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">player1</span> <span class="o">=</span> <span class="n">PolicyBasedPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">pnet</span><span class="p">)</span><span class="o">.</span><span class="n">play</span> <span class="c1"># greedy player</span>
<span class="n">player2</span> <span class="o">=</span> <span class="n">PolicyBasedPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">pnet</span><span class="p">,</span> <span class="n">greedy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">play</span> <span class="c1"># sample-based player</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">Arena</span><span class="o">.</span><span class="n">Arena</span><span class="p">(</span><span class="n">player1</span><span class="p">,</span> <span class="n">player2</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">OthelloGame</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="n">playGames</span><span class="p">(</span><span class="n">num_games</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">win_rate_player1</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">num_games</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win rate for player 1 over </span><span class="si">{</span><span class="n">num_games</span><span class="si">}</span><span class="s2"> games: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">win_rate_player1</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player</span> <span class="mi">1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">50.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-6-plan-using-monte-carlo-rollouts">
<h1>Section 6: Plan using Monte Carlo rollouts<a class="headerlink" href="#section-6-plan-using-monte-carlo-rollouts" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal</strong>:
Teach the students the core idea behind using simulated rollouts to understand the future and value actions.</p>
<p><strong>Exercise</strong>:</p>
<ul class="simple">
<li><p>Build a loop to run Monte Carlo simulations using the policy network.</p></li>
<li><p>Use this to obtain better estimates of the value of moves.</p></li>
</ul>
<div class="section" id="video-6-play-using-monte-carlo-rollouts">
<h2>Video 6: Play using Monte-Carlo rollouts<a class="headerlink" href="#video-6-play-using-monte-carlo-rollouts" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-6-montecarlo">
<h2>Coding Exercise 6: <code class="docutils literal notranslate"><span class="pre">MonteCarlo</span></code><a class="headerlink" href="#coding-exercise-6-montecarlo" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MonteCarlo</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">game</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span> <span class="o">=</span> <span class="n">nnet</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># stores initial policy (returned by neural net)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Es</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># stores game.getGameEnded ended for board s</span>

  <span class="c1"># call this rollout</span>
  <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canonicalBoard</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs one monte carlo rollout</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">stringRepresentation</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
    <span class="n">init_start_state</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">temp_v</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">isfirstAction</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">maxDepth</span><span class="p">):</span> <span class="c1"># maxDepth</span>

      <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getGameEnded</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># terminal state</span>
        <span class="n">temp_v</span><span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">break</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
      <span class="n">valids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getValidMoves</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">valids</span>  <span class="c1"># masking invalid moves</span>
      <span class="n">sum_Ps_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">sum_Ps_s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/=</span> <span class="n">sum_Ps_s</span>  <span class="c1"># renormalize</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if all valid moves were masked make all valid moves equally probable</span>
        <span class="c1"># NB! All valid moves may be masked if either your NNet architecture is insufficient or you&#39;ve get overfitting or something else.</span>
        <span class="c1"># If you have got dozens or hundreds of these messages you should pay attention to your NNet and/or training process.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;All valid moves were masked, doing a workaround.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">valids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

      <span class="c1">#################################################</span>
      <span class="c1">## TODO for students: Take a random action.</span>
      <span class="c1">## 1. Take the random action.</span>
      <span class="c1">## 2. Find the next state and the next player from the environment.</span>
      <span class="c1">## 3. Get the canonical form of the next state.</span>
      <span class="c1"># Fill out function and remove</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Take the action, find the next state&quot;</span><span class="p">)</span>
      <span class="c1">#################################################</span>
      <span class="n">a</span> <span class="o">=</span> <span class="o">...</span>
      <span class="n">next_s</span><span class="p">,</span> <span class="n">next_player</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getNextState</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
      <span class="n">next_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getCanonicalForm</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

      <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">stringRepresentation</span><span class="p">(</span><span class="n">next_s</span><span class="p">)</span>
      <span class="n">temp_v</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">temp_v</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_2af8513a.py"><em>Click for solution</em></a></p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-7-use-monte-carlo-simulations-to-play-games">
<h1>Section 7: Use Monte Carlo simulations to play games<a class="headerlink" href="#section-7-use-monte-carlo-simulations-to-play-games" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal:</strong>
Teach students how to use simple Monte Carlo planning to play games.</p>
<div class="section" id="video-7-play-with-planning">
<h2>Video 7: Play with planning<a class="headerlink" href="#video-7-play-with-planning" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-7-monte-carlo-simulations">
<h2>Coding Exercise 7: Monte-Carlo simulations<a class="headerlink" href="#coding-exercise-7-monte-carlo-simulations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Incorporate Monte Carlo simulations into an agent.</p></li>
<li><p>Run the resulting player versus the random, value-based, and policy-based players.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load MC model from the repository</span>
<span class="n">mc_model_save_name</span> <span class="o">=</span> <span class="s1">&#39;MC.pth.tar&#39;</span>
<span class="n">path</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;/content/nma_rl_games/alpha-zero/pretrained_models/models/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MonteCarloBasedPlayer</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">game</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span> <span class="o">=</span> <span class="n">nnet</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students: Instantiate the Monte Carlo class.</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use Monte Carlo!&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">mc_topk</span>

  <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canonicalBoard</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">qsa</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">stringRepresentation</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
    <span class="n">Ps</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
    <span class="n">valids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getValidMoves</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">Ps</span> <span class="o">=</span> <span class="n">Ps</span> <span class="o">*</span> <span class="n">valids</span>  <span class="c1"># masking invalid moves</span>
    <span class="n">sum_Ps_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sum_Ps_s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">Ps</span> <span class="o">/=</span> <span class="n">sum_Ps_s</span>  <span class="c1"># renormalize</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># if all valid moves were masked make all valid moves equally probable</span>
      <span class="c1"># NB! All valid moves may be masked if either your NNet architecture is insufficient or you&#39;ve get overfitting or something else.</span>
      <span class="c1"># If you have got dozens or hundreds of these messages you should pay attention to your NNet and/or training process.</span>
      <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
      <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;All valid moves were masked, doing a workaround.&quot;</span><span class="p">)</span>
      <span class="n">Ps</span> <span class="o">=</span> <span class="n">Ps</span> <span class="o">+</span> <span class="n">valids</span>
      <span class="n">Ps</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>

    <span class="n">num_valid_actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Ps</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">num_valid_actions</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>
      <span class="n">top_k_actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">Ps</span><span class="p">,</span><span class="o">-</span><span class="n">num_valid_actions</span><span class="p">)[</span><span class="o">-</span><span class="n">num_valid_actions</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">top_k_actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">Ps</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">:]</span>  <span class="c1"># to get actions that belongs to top k prob</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students:</span>
    <span class="c1">## 1. For each action in the top-k actions</span>
    <span class="c1">## 2. Get the next state using getNextState() function. You can find the implementation of this function in Section 1 in OthelloGame() class.</span>
    <span class="c1">## 3. Get the canonical form of the getNextState().</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Loop for the top actions&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="o">...</span><span class="p">:</span>
      <span class="n">next_s</span><span class="p">,</span> <span class="n">next_player</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getNextState</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
      <span class="n">next_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getCanonicalForm</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

      <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="c1"># do some rollouts</span>
      <span class="k">for</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">numMCsims</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="c1"># average out values</span>
      <span class="n">avg_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">qsa</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avg_value</span><span class="p">,</span> <span class="n">action</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">qsa</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">qsa</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">best_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsa</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">best_action</span>

  <span class="k">def</span> <span class="nf">getActionProb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canonicalBoard</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getGameEnded</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()))</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="n">action_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()))</span>
      <span class="n">best_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
      <span class="n">action_probs</span><span class="p">[</span><span class="n">best_action</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">action_probs</span>


<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">rp</span> <span class="o">=</span> <span class="n">RandomPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>  <span class="c1"># all players</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Feel free to change this number</span>

<span class="n">n1</span> <span class="o">=</span> <span class="n">NNet</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>  <span class="c1"># nNet players</span>
<span class="n">n1</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">mc_model_save_name</span><span class="p">)</span>
<span class="n">args1</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">({</span><span class="s1">&#39;numMCsims&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;maxRollouts&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;maxDepth&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;mc_topk&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

<span class="c1">## Uncomment below to check Monte Carlo agent!</span>
<span class="c1"># mc1 = MonteCarloBasedPlayer(game, n1, args1)</span>
<span class="c1"># n1p = lambda x: np.argmax(mc1.getActionProb(x))</span>
<span class="c1"># arena = Arena.Arena(n1p, rp, game, display=OthelloGame.display)</span>
<span class="c1"># MC_result = arena.playGames(num_games, verbose=False)</span>
<span class="c1"># print(f&quot;\n\n{MC_result}&quot;)</span>
<span class="c1"># print(f&quot;\nNumber of games won by player1 = {MC_result[0]}, &quot;</span>
<span class="c1">#       f&quot;number of games won by player2 = {MC_result[1]}, out of {num_games} games&quot;)</span>
<span class="c1"># win_rate_player1 = result[0]/num_games</span>
<span class="c1"># print(f&quot;\nWin rate for player1 over {num_games} games: {round(win_rate_player1*100, 1)}%&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_9d813162.py"><em>Click for solution</em></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player1</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="n">number</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player2</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">20</span> <span class="n">games</span>

<span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">50.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-8-plan-using-monte-carlo-tree-search">
<h1>Section 8: Plan using Monte Carlo Tree Search<a class="headerlink" href="#section-8-plan-using-monte-carlo-tree-search" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal:</strong>
Teach students to understand the core ideas behind Monte Carlo Tree Search.</p>
<div class="section" id="video-8-plan-with-mcts">
<h2>Video 8: Plan with MCTS<a class="headerlink" href="#video-8-plan-with-mcts" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-8-mcts-planner">
<h2>Coding Exercise 8: MCTS planner<a class="headerlink" href="#coding-exercise-8-mcts-planner" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Plug together pre-built Selection, Expansion &amp; Backpropagation code to complete an MCTS planner.</p></li>
<li><p>Deploy the MCTS planner to understand an interesting position, producing value estimates and action counts.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MCTS</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  This class handles the MCTS tree.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">game</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span> <span class="o">=</span> <span class="n">nnet</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Qsa</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># stores Q values for s,a (as defined in the paper)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># stores #times edge s,a was visited</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># stores #times board s was visited</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># stores initial policy (returned by neural net)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Es</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># stores game.getGameEnded ended for board s</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Vs</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># stores game.getValidMoves for board s</span>

  <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canonicalBoard</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function performs one iteration of MCTS. It is recursively called</span>
<span class="sd">    till a leaf node is found. The action chosen at each node is one that</span>
<span class="sd">    has the maximum upper confidence bound as in the paper.</span>

<span class="sd">    Once a leaf node is found, the neural network is called to return an</span>
<span class="sd">    initial policy P and a value v for the state. This value is propagated</span>
<span class="sd">    up the search path. In case the leaf node is a terminal state, the</span>
<span class="sd">    outcome is propagated up the search path. The values of Ns, Nsa, Qsa are</span>
<span class="sd">    updated.</span>

<span class="sd">    NOTE: the return values are the negative of the value of the current</span>
<span class="sd">    state. This is done since v is in [-1,1] and if v is the value of a</span>
<span class="sd">    state for the current player, then its value is -v for the other player.</span>

<span class="sd">    Returns:</span>
<span class="sd">        v: the negative of the value of the current canonicalBoard</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">stringRepresentation</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getGameEnded</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># terminal node</span>
      <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Es</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">:</span>
      <span class="c1"># leaf node</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
      <span class="n">valids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getValidMoves</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">valids</span>  <span class="c1"># masking invalid moves</span>
      <span class="n">sum_Ps_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">sum_Ps_s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/=</span> <span class="n">sum_Ps_s</span>  <span class="c1"># renormalize</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if all valid moves were masked make all valid moves equally probable</span>
        <span class="c1"># NB! All valid moves may be masked if either your NNet architecture is insufficient or you&#39;ve get overfitting or something else.</span>
        <span class="c1"># If you have got dozens or hundreds of these messages you should pay attention to your NNet and/or training process.</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;All valid moves were masked, doing a workaround.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">valids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ps</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">Vs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">valids</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="k">return</span> <span class="o">-</span><span class="n">v</span>

    <span class="n">valids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="n">cur_best</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">best_act</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students:</span>
    <span class="c1">## Implement the highest upper confidence bound depending whether we observed the state-action pair which is stored in self.Qsa[(s, a)]. You can find the formula in the slide 52 in video 8 above.</span>
    <span class="c1"># Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Complete the for loop&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="c1"># pick the action with the highest upper confidence bound</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()):</span>
      <span class="k">if</span> <span class="n">valids</span><span class="p">[</span><span class="n">a</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qsa</span><span class="p">:</span>
          <span class="n">u</span> <span class="o">=</span> <span class="o">...</span> <span class="o">+</span> <span class="o">...</span> <span class="o">*</span> <span class="o">...</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">...</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">u</span> <span class="o">=</span> <span class="o">...</span> <span class="o">*</span> <span class="o">...</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">...</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span> <span class="o">&gt;</span> <span class="n">cur_best</span><span class="p">:</span>
          <span class="n">cur_best</span> <span class="o">=</span> <span class="n">u</span>
          <span class="n">best_act</span> <span class="o">=</span> <span class="n">a</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">best_act</span>
    <span class="n">next_s</span><span class="p">,</span> <span class="n">next_player</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getNextState</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">next_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getCanonicalForm</span><span class="p">(</span><span class="n">next_s</span><span class="p">,</span> <span class="n">next_player</span><span class="p">)</span>

    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">next_s</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qsa</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Qsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Qsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Qsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Ns</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">v</span>

  <span class="k">def</span> <span class="nf">getNsa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_83be26c4.py"><em>Click for solution</em></a></p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-9-use-mcts-to-play-games">
<h1>Section 9: Use MCTS to play games<a class="headerlink" href="#section-9-use-mcts-to-play-games" title="Permalink to this headline">¶</a></h1>
<p><strong>Goal:</strong>
Teach the students how to use the results of an MCTS to play games.</p>
<p><strong>Exercise:</strong></p>
<ul class="simple">
<li><p>Plug the MCTS planner into an agent.</p></li>
<li><p>Play games against other agents.</p></li>
<li><p>Explore the contributions of prior network, value function, number of simulations / time to play, and explore/exploit parameters.</p></li>
</ul>
<div class="section" id="video-9-play-with-mcts">
<h2>Video 9: Play with MCTS<a class="headerlink" href="#video-9-play-with-mcts" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
<div class="section" id="coding-exercise-9-agent-that-uses-an-mcts-planner">
<h2>Coding Exercise 9: Agent that uses an MCTS planner<a class="headerlink" href="#coding-exercise-9-agent-that-uses-an-mcts-planner" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Plug the MCTS planner into an agent.</p></li>
<li><p>Play games against other agents.</p></li>
<li><p>Explore the contributions of prior network, value function, number of simulations / time to play, and explore/exploit parameters.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load MCTS model from the repository</span>
<span class="n">mcts_model_save_name</span> <span class="o">=</span> <span class="s1">&#39;MCTS.pth.tar&#39;</span>
<span class="n">path</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;/content/nma_rl_games/alpha-zero/pretrained_models/models/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MonteCarloTreeSearchBasedPlayer</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">game</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">game</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nnet</span> <span class="o">=</span> <span class="n">nnet</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mcts</span> <span class="o">=</span> <span class="n">MCTS</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">nnet</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


  <span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canonicalBoard</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">numMCTSSims</span><span class="p">):</span>

      <span class="c1">#################################################</span>
      <span class="c1">## TODO for students:</span>
      <span class="c1">#  Run MCTS search function.</span>
      <span class="c1">#  Fill out function and remove</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Plug the planner&quot;</span><span class="p">)</span>
      <span class="c1">#################################################</span>
      <span class="o">...</span>

    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">stringRepresentation</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="c1">## TODO for students:</span>
    <span class="c1">#  Call the Nsa function from MCTS class and store it in the self.Nsa</span>
    <span class="c1">#  Fill out function and remove</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Compute Nsa (number of times edge s,a was visited)&quot;</span><span class="p">)</span>
    <span class="c1">#################################################</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span> <span class="o">=</span> <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nsa</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">())]</span>

    <span class="k">if</span> <span class="n">temp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">bestAs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
      <span class="n">bestA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">bestAs</span><span class="p">)</span>
      <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">)</span>
      <span class="n">probs</span><span class="p">[</span><span class="n">bestA</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="n">probs</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">temp</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">counts_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">))</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts_sum</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">getActionProb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canonicalBoard</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">action_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">getActionSize</span><span class="p">()))</span>
    <span class="n">best_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">canonicalBoard</span><span class="p">)</span>
    <span class="n">action_probs</span><span class="p">[</span><span class="n">best_action</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">action_probs</span>


<span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">game</span> <span class="o">=</span> <span class="n">OthelloGame</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">rp</span> <span class="o">=</span> <span class="n">RandomPlayer</span><span class="p">(</span><span class="n">game</span><span class="p">)</span><span class="o">.</span><span class="n">play</span>  <span class="c1"># all players</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># games</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">NNet</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>  <span class="c1"># nnet players</span>
<span class="n">n1</span><span class="o">.</span><span class="n">load_checkpoint</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">mcts_model_save_name</span><span class="p">)</span>
<span class="n">args1</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">({</span><span class="s1">&#39;numMCTSSims&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;cpuct&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">})</span>

<span class="c1">## Uncomment below to check your agent!</span>
<span class="c1"># mcts1 = MonteCarloTreeSearchBasedPlayer(game, n1, args1)</span>
<span class="c1"># n1p = lambda x: np.argmax(mcts1.getActionProb(x, temp=0))</span>
<span class="c1"># arena = Arena.Arena(n1p, rp, game, display=OthelloGame.display)</span>
<span class="c1"># MCTS_result = arena.playGames(num_games, verbose=False)</span>
<span class="c1"># print(f&quot;\n\n{MCTS_result}&quot;)</span>
<span class="c1"># print(f&quot;\nNumber of games won by player1 = {MCTS_result[0]}, &quot;</span>
<span class="c1">#       f&quot;number of games won by player2 = {MCTS_result[1]}, out of {num_games} games&quot;)</span>
<span class="c1"># win_rate_player1 = MCTS_result[0]/num_games</span>
<span class="c1"># print(f&quot;\nWin rate for player1 over {num_games} games: {round(win_rate_player1*100, 1)}%&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="https://github.com/NeuromatchAcademy/course-content-dl/tree/main//tutorials/W3D3_ReinforcementLearningForGames/solutions/W3D3_Tutorial1_Solution_9dd0dfb6.py"><em>Click for solution</em></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player1</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">num</span> <span class="n">of</span> <span class="n">games</span> <span class="n">won</span> <span class="n">by</span> <span class="n">player2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">20</span> <span class="n">games</span>

<span class="n">Win</span> <span class="n">rate</span> <span class="k">for</span> <span class="n">player1</span> <span class="n">over</span> <span class="mi">20</span> <span class="n">games</span><span class="p">:</span> <span class="mf">95.0</span><span class="o">%</span>
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="section-10-ethical-aspects">
<h1>Section 10: Ethical aspects<a class="headerlink" href="#section-10-ethical-aspects" title="Permalink to this headline">¶</a></h1>
<div class="section" id="video-10-unstoppable-opponents">
<h2>Video 10: Unstoppable opponents<a class="headerlink" href="#video-10-unstoppable-opponents" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h1>
<p>In this tutotial, you have learned how to implement a game loop and improve the performance of a random player. More specifically, you are now able to understand the format of two-players games. We learned about value-based and policy-based players, and we compare them with the MCTS method.</p>
<div class="section" id="video-11-outro">
<h2>Video 11: Outro<a class="headerlink" href="#video-11-outro" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove-input docutils container">
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./tutorials/W3D3_ReinforcementLearningForGames/student"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="../chapter_title.html" title="previous page">Reinforcement Learning For Games</a>
    <a class='right-next' id="next-link" href="../../W3D4_ContinualLearning/chapter_title.html" title="next page">Continual Learning</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Neuromatch<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>